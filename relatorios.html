<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios e An√°lises - EMATECH</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .relatorios-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 0;
            overflow: hidden;
        }
        
        .page-header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .page-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .page-header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .relatorios-content {
            padding: 40px;
        }
        
        .filtros-section {
            background: #f7fafc;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 40px;
            border: 1px solid #e2e8f0;
        }
        
        .filtros-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filtro-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filtro-group select,
        .filtro-group input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }
        
        .filtro-group select:focus,
        .filtro-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .action-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn-filtrar,
        .btn-action {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-filtrar {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
        }
        
        .btn-filtrar:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-3px);
        }
        
        .resumo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            margin: 15px 0 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.95;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }
        
        .stat-sublabel {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .mapa-section {
            margin-bottom: 40px;
        }
        
        .charts-section {
            display: grid;
            gap: 30px;
        }
        
        .chart-container {
            background: #f7fafc;
            padding: 30px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .chart-subtitle {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }
        
        .chart-export {
            padding: 10px 18px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chart-export:hover {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
            transform: translateY(-2px);
        }
        
        .chart-canvas {
            position: relative;
            height: 400px;
            background: white;
            border-radius: 12px;
            padding: 15px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 30px;
        }
        
        #map {
            height: 600px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: #a0aec0;
            font-size: 1.2rem;
        }
        
        @media (max-width: 1024px) {
            .relatorios-content {
                padding: 30px 20px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .resumo-stats {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .page-header {
                padding: 30px 20px;
            }
            
            .page-header h1 {
                font-size: 1.8rem;
            }
            
            .relatorios-content {
                padding: 20px;
            }
            
            .resumo-stats {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 2.5rem;
            }
            
            .chart-canvas {
                height: 300px;
            }
            
            #map {
                height: 400px;
            }
            
            .action-bar {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(102, 126, 234, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    ">
        <div class="loading-spinner" style="border-color: rgba(255,255,255,0.3); border-top-color: white;"></div>
        <p style="margin-top: 20px; font-size: 1.3rem; color: white; font-weight: 600;">
            üîÑ Carregando relat√≥rios...
        </p>
    </div>
    
    <div class="relatorios-container">
        <div class="page-header">
            <h1>üìä Relat√≥rios e An√°lises</h1>
            <p>Dashboard Completo de Dados Coletados - EMATECH</p>
        </div>
        
        <div class="relatorios-content">
            <!-- Filtros -->
            <div class="filtros-section">
                <h3 class="filtros-title">üîç Filtros Avan√ßados</h3>
                <div class="filtros-grid">
                <div class="filtro-group">
                    <label>Per√≠odo - In√≠cio</label>
                    <input type="date" id="filtro-data-inicio">
                </div>
                <div class="filtro-group">
                    <label>Per√≠odo - Fim</label>
                    <input type="date" id="filtro-data-fim">
                </div>
                <div class="filtro-group">
                    <label>Munic√≠pio</label>
                    <select id="filtro-municipio">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filtro-group">
                    <label>Sistema Produtivo</label>
                    <select id="filtro-sistema">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div class="action-bar">
                <button class="btn-filtrar" onclick="aplicarFiltros()">
                    üîç Aplicar Filtros
                </button>
                <button class="btn-action btn-secondary" onclick="limparFiltros()">
                    üîÑ Limpar Filtros
                </button>
                <button class="btn-action btn-secondary" onclick="exportarRelatorio()">
                    üì• Exportar PDF
                </button>
                <button class="btn-action btn-secondary" onclick="voltarAdmin()">
                    ‚Üê Voltar ao Painel
                </button>
            </div>
        </div>
        
        <!-- Dashboard de KPIs -->
        <div class="resumo-stats" id="resumoStats">
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="total-formularios">-</div>
                <div class="stat-label">Formul√°rios Coletados</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèòÔ∏è</div>
                <div class="stat-value" id="total-municipios">-</div>
                <div class="stat-label">Munic√≠pios Cobertos</div>
                <div class="stat-sublabel" id="cobertura-municipios">de 52</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-value" id="total-unidades">-</div>
                <div class="stat-label">Unidades EMATER</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="taxa-completude">-</div>
                <div class="stat-label">Taxa de Completude</div>
                <div class="stat-sublabel">Campos preenchidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="tempo-medio">-</div>
                <div class="stat-label">Tempo M√©dio</div>
                <div class="stat-sublabel">De preenchimento</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚òÅÔ∏è</div>
                <div class="stat-value" id="taxa-sincronizacao">-</div>
                <div class="stat-label">Sincronizados</div>
                <div class="stat-sublabel">vs Pendentes</div>
            </div>
        </div>
        
        <!-- Mapa de Geolocaliza√ß√£o -->
        <div class="mapa-section">
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">üìç Mapa de Distribui√ß√£o Geogr√°fica</div>
                        <div class="chart-subtitle">Localiza√ß√£o das entrevistas com coordenadas GPS capturadas</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="gps-counter" style="font-size: 0.9em; color: #666;">-</span>
                    </div>
                </div>
                <div id="map" style="height: 500px; border-radius: 8px; overflow: hidden;"></div>
            </div>
        </div>
        
        <!-- Gr√°ficos -->
        <div class="charts-section">
            <!-- Gr√°fico de Radar: Resultados e Impactos -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">‚≠ê Resultados e Impactos Percebidos</div>
                        <div class="chart-subtitle">Frequ√™ncia de escolha vs M√©dia de impacto (escala 1-5)</div>
                    </div>
                    <button class="chart-export" onclick="exportarGrafico('chartResultados')">üì• Exportar</button>
                </div>
                <div class="chart-canvas">
                    <canvas id="chartResultados"></canvas>
                </div>
            </div>
            
            <!-- Gr√°ficos em Grid -->
            <div class="charts-grid">
                <!-- Gr√°fico: Principais Desafios -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">üö® Principais Desafios</div>
                            <div class="chart-subtitle">Intensidade m√©dia (1-5)</div>
                        </div>
                        <button class="chart-export" onclick="exportarGrafico('chartDesafios')">üì• Exportar</button>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="chartDesafios"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico: Cobertura por Unidade -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">üè¢ Top 10 Unidades EMATER</div>
                            <div class="chart-subtitle">Formul√°rios coletados</div>
                        </div>
                        <button class="chart-export" onclick="exportarGrafico('chartUnidades')">üì• Exportar</button>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="chartUnidades"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Gr√°fico: Distribui√ß√£o por Tempo de Atua√ß√£o -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">üë• Perfil dos Extensionistas por Tempo de Atua√ß√£o</div>
                        <div class="chart-subtitle">Distribui√ß√£o da experi√™ncia na EMATER-RO</div>
                    </div>
                    <button class="chart-export" onclick="exportarGrafico('chartTempoAtuacao')">üì• Exportar</button>
                </div>
                <div class="chart-canvas">
                    <canvas id="chartTempoAtuacao"></canvas>
                </div>
            </div>
            
            <!-- PRIORIDADE M√âDIA -->
            <!-- Gr√°fico: Estrat√©gias Mais Adotadas -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">üéØ Estrat√©gias de Extens√£o Mais Adotadas</div>
                        <div class="chart-subtitle">Top 10 estrat√©gias utilizadas pelas unidades</div>
                    </div>
                    <button class="chart-export" onclick="exportarGrafico('chartEstrategias')">üì• Exportar</button>
                </div>
                <div class="chart-canvas">
                    <canvas id="chartEstrategias"></canvas>
                </div>
            </div>
            
            <!-- Gr√°ficos em Grid -->
            <div class="charts-grid">
                <!-- Gr√°fico: Rede de Parcerias -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">ü§ù Parcerias e Articula√ß√µes</div>
                            <div class="chart-subtitle">Frequ√™ncia de parcerias por tipo</div>
                        </div>
                        <button class="chart-export" onclick="exportarGrafico('chartParcerias')">üì• Exportar</button>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="chartParcerias"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico: Orienta√ß√£o de Mercado -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">üìä Orienta√ß√£o por Demanda de Mercado</div>
                            <div class="chart-subtitle">Frequ√™ncia e capacita√ß√£o em mercado</div>
                        </div>
                        <button class="chart-export" onclick="exportarGrafico('chartComercializacao')">üì• Exportar</button>
                    </div>
                    <div class="chart-canvas">
                        <canvas id="chartComercializacao"></canvas>
                    </div>
                </div>
            </div>

            <!-- ===== PRIORIDADE BAIXA: AN√ÅLISES AVAN√áADAS ===== -->
            <div class="section">
                <h2 class="section-title">üìà An√°lises Avan√ßadas</h2>
                <div class="charts-grid">
                    <!-- Gr√°fico: Correla√ß√£o Experi√™ncia x Resultados -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üîç Correla√ß√£o: Experi√™ncia vs Diversidade de Resultados</div>
                                <div class="chart-subtitle">Cada ponto representa um extensionista</div>
                            </div>
                            <button class="chart-export" onclick="exportarGrafico('chartCorrelacao')">üì• Exportar</button>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="chartCorrelacao"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico: Perfil de Diversidade de A√ß√µes -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">üéØ Perfil de Diversidade de A√ß√µes</div>
                                <div class="chart-subtitle">Combina√ß√£o de estrat√©gias e parcerias adotadas</div>
                            </div>
                            <button class="chart-export" onclick="exportarGrafico('chartIndicadores')">üì• Exportar</button>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="chartIndicadores"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico: An√°lise Comparativa de Desafios -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">‚ö†Ô∏è An√°lise Comparativa de Desafios</div>
                                <div class="chart-subtitle">Intensidade m√©dia percebida (1-5)</div>
                            </div>
                            <button class="chart-export" onclick="exportarGrafico('chartDesafiosMercado')">üì• Exportar</button>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="chartDesafiosMercado"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
    
    <script src="db-extensionistas.js"></script>
    <script>
        // ========================================
        // RELAT√ìRIOS.JS - IMPLEMENTA√á√ÉO INLINE
        // ========================================
        
        let todosFormularios = [];
        let mapaRelatorios = null;
        let charts = {};
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarDados();
        });
        
        // Carregar dados do IndexedDB
        async function carregarDados() {
            try {
                mostrarLoading(true);
                
                await initDB();
                todosFormularios = await buscarTodosFormularios();
                
                if (todosFormularios.length === 0) {
                    ocultarLoading();
                    mostrarMensagemVazia();
                    return;
                }
                
                renderizarResumo();
                renderizarGraficos();
                inicializarMapa();
                
                ocultarLoading();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                ocultarLoading();
                alert('Erro ao carregar dados para relat√≥rios.');
            }
        }
        
        // Buscar todos os formul√°rios
        async function buscarTodosFormularios() {
            const db = await initDB();
            const transaction = db.transaction(['formularios'], 'readonly');
            const store = transaction.objectStore('formularios');
            const request = store.getAll();
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        // Renderizar resumo estat√≠stico
        function renderizarResumo() {
            const total = todosFormularios.length;
            const municipios = new Set(todosFormularios.map(f => f.respostas?.municipio || f.municipio).filter(Boolean)).size;
            const unidades = new Set(todosFormularios.map(f => f.respostas?.escritorioLocal || f.escritorioLocal).filter(Boolean)).size;
            
            // Taxa de completude (campos obrigat√≥rios preenchidos)
            const camposObrigatorios = ['municipio', 'escritorioLocal', 'tempoEmater', 'resultadosRelevantes', 'desafiosEnfrentados'];
            let totalCamposPreenchidos = 0;
            let totalCamposEsperados = total * camposObrigatorios.length;
            
            todosFormularios.forEach(f => {
                camposObrigatorios.forEach(campo => {
                    const valor = f.respostas?.[campo] || f[campo];
                    if (valor && valor !== '' && valor !== null && valor !== undefined) {
                        totalCamposPreenchidos++;
                    }
                });
            });
            
            const taxaCompletude = totalCamposEsperados > 0 
                ? Math.round((totalCamposPreenchidos / totalCamposEsperados) * 100) 
                : 0;
            
            // Tempo m√©dio
            const dura√ß√µes = todosFormularios
                .map(f => f.duracaoMinutos || f.duracao_minutos || 0)
                .filter(d => d > 0);
            const tempoMedio = dura√ß√µes.length > 0
                ? Math.round(dura√ß√µes.reduce((a, b) => a + b, 0) / dura√ß√µes.length)
                : 0;
            
            // Taxa de sincroniza√ß√£o
            const sincronizados = todosFormularios.filter(f => f.sincronizado).length;
            const taxaSincronizacao = total > 0 ? Math.round((sincronizados / total) * 100) : 0;
            
            // Atualizar HTML
            document.getElementById('total-formularios').textContent = total;
            document.getElementById('total-municipios').textContent = municipios;
            document.getElementById('cobertura-municipios').textContent = `de 52 (${Math.round((municipios/52)*100)}%)`;
            document.getElementById('total-unidades').textContent = unidades;
            document.getElementById('taxa-completude').textContent = taxaCompletude + '%';
            document.getElementById('tempo-medio').textContent = tempoMedio + 'min';
            document.getElementById('taxa-sincronizacao').textContent = taxaSincronizacao + '%';
        }
        
        // Renderizar gr√°ficos
        function renderizarGraficos() {
            renderizarGraficoResultados();
            renderizarGraficoDesafios();
            renderizarGraficoUnidades();
            renderizarGraficoTempoAtuacao();
            // Prioridade M√©dia
            renderizarGraficoEstrategias();
            renderizarGraficoParcerias();
            renderizarGraficoComercializacao();
            
            // Prioridade BAIXA
            renderizarGraficoCorrelacao();
            renderizarGraficoIndicadores();
            renderizarGraficoDesafiosMercado();
        }
        
        // Gr√°fico 1: Radar de Resultados e Impactos
        function renderizarGraficoResultados() {
            const resultados = {
                'aumento_produtividade': { label: 'Aumento de Produtividade', count: 0, impactoTotal: 0 },
                'aumento_comercializacao': { label: 'Aumento de Comercializa√ß√£o', count: 0, impactoTotal: 0 },
                'inclusao_programas': { label: 'Inclus√£o em Programas', count: 0, impactoTotal: 0 },
                'implementacao_tecnologias': { label: 'Implementa√ß√£o de Tecnologias', count: 0, impactoTotal: 0 },
                'fortalecimento_organizacoes': { label: 'Fortalecimento de Organiza√ß√µes', count: 0, impactoTotal: 0 },
                'capacitacao_produtores': { label: 'Capacita√ß√£o de Produtores', count: 0, impactoTotal: 0 },
                'reducao_perdas': { label: 'Redu√ß√£o de Perdas', count: 0, impactoTotal: 0 }
            };
            
            todosFormularios.forEach(f => {
                const respostasArray = f.respostas?.resultadosRelevantes;
                if (Array.isArray(respostasArray)) {
                    respostasArray.forEach(resultado => {
                        if (resultados[resultado]) {
                            resultados[resultado].count++;
                            // Pegar o valor de impacto correspondente
                            const impacto = parseInt(f.respostas?.[`impacto_${resultado}`]) || 0;
                            if (impacto > 0) {
                                resultados[resultado].impactoTotal += impacto;
                            }
                        }
                    });
                }
            });
            
            // Calcular m√©dia de impacto
            const labels = [];
            const frequencies = [];
            const avgImpacts = [];
            
            Object.values(resultados).forEach(r => {
                labels.push(r.label);
                frequencies.push(r.count);
                avgImpacts.push(r.count > 0 ? (r.impactoTotal / r.count).toFixed(1) : 0);
            });
            
            const ctx = document.getElementById('chartResultados');
            if (!ctx) return;
            
            charts.resultados = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequ√™ncia de Escolha',
                        data: frequencies,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderWidth: 2
                    }, {
                        label: 'Impacto M√©dio (1-5)',
                        data: avgImpacts,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: Math.max(...frequencies, 5)
                        }
                    }
                }
            });
        }
        
        // Gr√°fico 2: Desafios Horizontais
        function renderizarGraficoDesafios() {
            const desafios = {
                'desafio_fatores_externos': 'Fatores Externos',
                'desafio_falta_pessoal': 'Falta de Pessoal',
                'desafio_falta_veiculos': 'Falta de Ve√≠culos',
                'desafio_falta_orcamento': 'Falta de Or√ßamento',
                'desafio_baixa_organizacao': 'Baixa Organiza√ß√£o Coletiva',
                'desafio_falta_dados': 'Falta de Dados/Sigater'
            };
            
            const medias = {};
            
            Object.keys(desafios).forEach(key => {
                const valores = todosFormularios
                    .map(f => parseInt(f.respostas?.[key]))
                    .filter(v => !isNaN(v) && v > 0);
                medias[key] = valores.length > 0 
                    ? (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(1)
                    : 0;
            });
            
            // Ordenar por intensidade
            const sorted = Object.entries(medias)
                .sort((a, b) => parseFloat(b[1]) - parseFloat(a[1]));
            
            const ctx = document.getElementById('chartDesafios');
            if (!ctx) return;
            
            charts.desafios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([key]) => desafios[key]),
                    datasets: [{
                        label: 'Intensidade M√©dia (1-5)',
                        data: sorted.map(([, value]) => parseFloat(value)),
                        backgroundColor: sorted.map(([, value]) => {
                            const v = parseFloat(value);
                            if (v >= 4) return '#f44336'; // vermelho
                            if (v >= 3) return '#ff9800'; // laranja
                            return '#ffc107'; // amarelo
                        })
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 5
                        }
                    }
                }
            });
        }
        
        // Gr√°fico 3: Top 10 Unidades EMATER
        function renderizarGraficoUnidades() {
            const unidades = {};
            
            todosFormularios.forEach(f => {
                const unidade = f.respostas?.escritorioLocal || f.escritorioLocal;
                if (unidade) {
                    unidades[unidade] = (unidades[unidade] || 0) + 1;
                }
            });
            
            // Top 10
            const sorted = Object.entries(unidades)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('chartUnidades');
            if (!ctx) return;
            
            charts.unidades = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([nome]) => nome),
                    datasets: [{
                        label: 'Formul√°rios',
                        data: sorted.map(([, count]) => count),
                        backgroundColor: '#2e7d32'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // Gr√°fico 4: Tempo de Atua√ß√£o (Pizza)
        function renderizarGraficoTempoAtuacao() {
            const tempos = {
                'menos5': 'Menos de 5 anos',
                '5a9': '5-9 anos',
                '10a14': '10-14 anos',
                '15a19': '15-19 anos',
                '20a24': '20-24 anos',
                '25a29': '25-29 anos',
                'mais30': 'Mais de 30 anos'
            };
            
            const contagem = {};
            Object.keys(tempos).forEach(key => contagem[key] = 0);
            
            todosFormularios.forEach(f => {
                const tempo = f.respostas?.tempoEmater || f.tempoEmater;
                if (tempo && contagem.hasOwnProperty(tempo)) {
                    contagem[tempo]++;
                }
            });
            
            const ctx = document.getElementById('chartTempoAtuacao');
            if (!ctx) return;
            
            charts.tempoAtuacao = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(contagem).map(key => tempos[key]),
                    datasets: [{
                        data: Object.values(contagem),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        // ============================================
        // GR√ÅFICOS DE PRIORIDADE M√âDIA
        // ============================================
        
        // Gr√°fico 5: Estrat√©gias de Extens√£o Mais Adotadas
        function renderizarGraficoEstrategias() {
            const estrategiasLabels = {
                'realocacao_tecnicos': 'Realoca√ß√£o de t√©cnicos',
                'parcerias': 'Parcerias com prefeituras/ONGs',
                'oficinas_capacitacoes': 'Oficinas e capacita√ß√µes',
                'ferramentas_digitais': 'Ferramentas digitais',
                'recursos_convenios': 'Recursos via conv√™nios'
            };
            
            const estrategias = {};
            Object.keys(estrategiasLabels).forEach(key => estrategias[key] = 0);
            
            todosFormularios.forEach(f => {
                const estrategiasArray = f.respostas?.estrategias;
                if (Array.isArray(estrategiasArray)) {
                    estrategiasArray.forEach(est => {
                        if (estrategias.hasOwnProperty(est)) {
                            estrategias[est]++;
                        }
                    });
                }
            });
            
            // Ordenar por frequ√™ncia
            const sorted = Object.entries(estrategias)
                .sort((a, b) => b[1] - a[1]);
            
            const ctx = document.getElementById('chartEstrategias');
            if (!ctx) return;
            
            charts.estrategias = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([key]) => estrategiasLabels[key]),
                    datasets: [{
                        label: 'Frequ√™ncia',
                        data: sorted.map(([, count]) => count),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // Gr√°fico 6: Parcerias e Articula√ß√µes
        function renderizarGraficoParcerias() {
            const parceriasLabels = {
                'idaron': 'Idaron',
                'embrapa': 'Embrapa',
                'prefeituras': 'Prefeituras',
                'sedam': 'Sedam',
                'secretarias_municipais': 'Secret. Municipais',
                'cooperativas_associacoes': 'Cooperativas/Associa√ß√µes',
                'movimentos_sociais': 'Movimentos Sociais',
                'instituicoes_financeiras': 'Inst. Financeiras',
                'sistema_s': 'Sistema S',
                'sindicatos': 'Sindicatos'
            };
            
            const parcerias = {};
            Object.keys(parceriasLabels).forEach(key => parcerias[key] = 0);
            
            todosFormularios.forEach(f => {
                const parceriasArray = f.respostas?.parceriasAtivas;
                if (Array.isArray(parceriasArray)) {
                    parceriasArray.forEach(p => {
                        if (parcerias.hasOwnProperty(p)) {
                            parcerias[p]++;
                        }
                    });
                }
            });
            
            const ctx = document.getElementById('chartParcerias');
            if (!ctx) return;
            
            charts.parcerias = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(parcerias).map(key => parceriasLabels[key]),
                    datasets: [{
                        label: 'Frequ√™ncia de Parcerias',
                        data: Object.values(parcerias),
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#764ba2',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Gr√°fico 7: Orienta√ß√£o de Mercado e Capacita√ß√£o
        function renderizarGraficoComercializacao() {
            // Frequ√™ncia de orienta√ß√£o por demanda de mercado
            const freqDemanda = {
                'nunca': 'Nunca',
                'raramente': 'Raramente',
                'as_vezes': '√Äs vezes',
                'frequentemente': 'Frequentemente',
                'sempre': 'Sempre'
            };
            
            const contagem = {};
            Object.keys(freqDemanda).forEach(key => contagem[key] = 0);
            
            todosFormularios.forEach(f => {
                const freq = f.respostas?.freqDemandaMercado;
                if (freq && contagem.hasOwnProperty(freq)) {
                    contagem[freq]++;
                }
            });
            
            // Capacita√ß√£o em mercado
            const comCapacitacao = todosFormularios.filter(f => f.respostas?.capacitacaoMercado === 'sim').length;
            const semCapacitacao = todosFormularios.filter(f => f.respostas?.capacitacaoMercado === 'nao').length;
            
            const ctx = document.getElementById('chartComercializacao');
            if (!ctx) return;
            
            charts.comercializacao = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(contagem).map(key => freqDemanda[key]),
                    datasets: [{
                        label: 'Frequ√™ncia de Orienta√ß√£o por Mercado',
                        data: Object.values(contagem),
                        backgroundColor: [
                            '#f44336', '#ff9800', '#ffc107', '#4caf50', '#2e7d32'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: `Capacitados: ${comCapacitacao} | N√£o: ${semCapacitacao}`,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            });
        }
        
        // ============================================
        // FIM GR√ÅFICOS DE PRIORIDADE M√âDIA
        // ============================================
        
        // ========================================
        // GR√ÅFICOS - PRIORIDADE BAIXA
        // ========================================

        // Gr√°fico 1: An√°lise de Correla√ß√£o - Experi√™ncia x Diversidade de Resultados
        function renderizarGraficoCorrelacao() {
            const ctx = document.getElementById('chartCorrelacao');
            if (!ctx) return;

            // Mapear tempo de atua√ß√£o para valores num√©ricos (anos)
            const tempoMap = {
                'menos5': 2.5,
                '5a9': 7,
                '10a14': 12,
                '15a19': 17,
                '20a24': 22,
                '25a29': 27,
                'mais30': 32
            };

            // Criar dataset: cada ponto √© um formul√°rio
            const dados = todosFormularios
                .map(f => {
                    const tempo = f.respostas?.tempoEmater;
                    const resultados = f.respostas?.resultadosRelevantes || [];
                    
                    if (!tempo || !Array.isArray(resultados)) return null;
                    
                    return {
                        x: tempoMap[tempo] || 0,
                        y: resultados.length,
                        r: 8 // raio da bolha
                    };
                })
                .filter(d => d !== null && d.x > 0 && d.y > 0);

            // Calcular linha de tend√™ncia (regress√£o linear simples)
            const n = dados.length;
            if (n === 0) return;

            const sumX = dados.reduce((acc, d) => acc + d.x, 0);
            const sumY = dados.reduce((acc, d) => acc + d.y, 0);
            const sumXY = dados.reduce((acc, d) => acc + d.x * d.y, 0);
            const sumX2 = dados.reduce((acc, d) => acc + d.x * d.x, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // Criar pontos para linha de tend√™ncia
            const trendline = [
                { x: 0, y: intercept },
                { x: 35, y: slope * 35 + intercept }
            ];

            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Extensionistas',
                            data: dados,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Tend√™ncia',
                            data: trendline,
                            type: 'line',
                            borderColor: 'rgba(255, 99, 132, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'üîç Correla√ß√£o: Experi√™ncia vs Diversidade de Resultados',
                            font: { size: 16, weight: 'bold' }
                        },
                        subtitle: {
                            display: true,
                            text: `Coeficiente angular: ${slope.toFixed(3)} | Intercept: ${intercept.toFixed(2)}`,
                            font: { size: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `${context.parsed.y} resultados (${context.parsed.x} anos exp.)`;
                                    }
                                    return 'Linha de tend√™ncia';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tempo de Atua√ß√£o na EMATER (anos)'
                            },
                            min: 0,
                            max: 35
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Quantidade de Resultados Alcan√ßados'
                            },
                            min: 0,
                            max: 7,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico 2: Diversidade de A√ß√µes (Estrat√©gias + Parcerias)
        function renderizarGraficoIndicadores() {
            const ctx = document.getElementById('chartIndicadores');
            if (!ctx) return;

            // Classificar extensionistas por diversidade de a√ß√µes
            const perfis = {
                'baixa': { label: 'Baixa (1-3 a√ß√µes)', count: 0, cor: '#f44336' },
                'media': { label: 'M√©dia (4-6 a√ß√µes)', count: 0, cor: '#ff9800' },
                'alta': { label: 'Alta (7-10 a√ß√µes)', count: 0, cor: '#4caf50' },
                'muito_alta': { label: 'Muito Alta (11+ a√ß√µes)', count: 0, cor: '#2e7d32' }
            };

            todosFormularios.forEach(f => {
                const estrategias = f.respostas?.estrategias || [];
                const parcerias = f.respostas?.parceriasAtivas || [];
                const totalAcoes = estrategias.length + parcerias.length;
                
                if (totalAcoes <= 3) perfis.baixa.count++;
                else if (totalAcoes <= 6) perfis.media.count++;
                else if (totalAcoes <= 10) perfis.alta.count++;
                else perfis.muito_alta.count++;
            });

            const labels = Object.values(perfis).map(p => p.label);
            const dados = Object.values(perfis).map(p => p.count);
            const cores = Object.values(perfis).map(p => p.cor);
            const percentuais = dados.map(d => ((d / todosFormularios.length) * 100).toFixed(1));

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Extensionistas',
                        data: dados,
                        backgroundColor: cores,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'üéØ Perfil de Diversidade de A√ß√µes',
                            font: { size: 16, weight: 'bold' }
                        },
                        subtitle: {
                            display: true,
                            text: 'Combina√ß√£o de estrat√©gias e parcerias adotadas',
                            font: { size: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    return `${context.label}: ${context.parsed} (${percentuais[idx]}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico 3: Compara√ß√£o de Intensidade dos Desafios
        function renderizarGraficoDesafiosMercado() {
            const ctx = document.getElementById('chartDesafiosMercado');
            if (!ctx) return;

            // Mapear os 6 desafios existentes no formul√°rio
            const desafiosMap = {
                'desafio_fatores_externos': 'Fatores Externos (clima, pragas)',
                'desafio_falta_pessoal': 'Falta de Pessoal',
                'desafio_falta_veiculos': 'Falta de Ve√≠culos/Estrutura',
                'desafio_falta_orcamento': 'Falta de Or√ßamento',
                'desafio_baixa_organizacao': 'Baixa Organiza√ß√£o Produtores',
                'desafio_distancia': 'Dist√¢ncia/Vias de Acesso'
            };

            // Calcular intensidade m√©dia (1-5) para cada desafio
            const intensidades = {};
            Object.keys(desafiosMap).forEach(key => intensidades[key] = []);

            todosFormularios.forEach(f => {
                Object.keys(desafiosMap).forEach(desafio => {
                    const valor = parseInt(f.respostas?.[desafio]);
                    if (!isNaN(valor) && valor >= 1 && valor <= 5) {
                        intensidades[desafio].push(valor);
                    }
                });
            });

            // Calcular m√©dias e ordenar
            const resultados = Object.entries(intensidades)
                .map(([key, valores]) => {
                    if (valores.length === 0) return null;
                    const media = valores.reduce((a, b) => a + b, 0) / valores.length;
                    return { key, label: desafiosMap[key], media, count: valores.length };
                })
                .filter(r => r !== null)
                .sort((a, b) => b.media - a.media);

            if (resultados.length === 0) return;

            const labels = resultados.map(r => r.label);
            const dados = resultados.map(r => r.media.toFixed(2));
            
            // Cores baseadas na intensidade: vermelho=cr√≠tico, amarelo=moderado
            const cores = dados.map(d => {
                const val = parseFloat(d);
                if (val >= 4) return 'rgba(244, 67, 54, 0.8)';  // Vermelho
                if (val >= 3) return 'rgba(255, 152, 0, 0.8)';  // Laranja
                return 'rgba(255, 193, 7, 0.8)';  // Amarelo
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Intensidade M√©dia',
                        data: dados,
                        backgroundColor: cores,
                        borderColor: cores.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        title: {
                            display: true,
                            text: '‚ö†Ô∏è An√°lise Comparativa de Desafios',
                            font: { size: 16, weight: 'bold' }
                        },
                        subtitle: {
                            display: true,
                            text: 'Intensidade m√©dia percebida (1=Insignificante, 5=Cr√≠tico)',
                            font: { size: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    return `M√©dia: ${context.parsed.x} (${resultados[idx].count} respostas)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Intensidade M√©dia (escala 1-5)'
                            }
                        }
                    }
                }
            });
        }
        
        // ============================================
        // FIM GR√ÅFICOS DE PRIORIDADE BAIXA
        // ============================================
        
        // Gr√°fico 3: Pr√°ticas Sustent√°veis
        function renderizarGraficoPraticas() {
            const praticasCount = {};
            
            todosFormularios.forEach(f => {
                const praticas = f.respostas?.praticas_sustentaveis;
                if (Array.isArray(praticas)) {
                    praticas.forEach(p => {
                        praticasCount[p] = (praticasCount[p] || 0) + 1;
                    });
                }
            });
            
            const ctx = document.getElementById('chartPraticas');
            if (!ctx) return;
            
            // Top 10 pr√°ticas
            const topPraticas = Object.entries(praticasCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            charts.praticas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topPraticas.map(p => p[0]),
                    datasets: [{
                        label: 'Ado√ß√µes',
                        data: topPraticas.map(p => p[1]),
                        backgroundColor: '#27ae60'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // Gr√°fico 4: Tempo de Atendimento
        function renderizarGraficoTempo() {
            const faixas = {
                '0-15 min': 0,
                '15-30 min': 0,
                '30-60 min': 0,
                'Mais de 60 min': 0
            };
            
            todosFormularios.forEach(f => {
                const tempo = f.duracaoMinutos || f.duracao_minutos || 0;
                if (tempo <= 15) faixas['0-15 min']++;
                else if (tempo <= 30) faixas['15-30 min']++;
                else if (tempo <= 60) faixas['30-60 min']++;
                else faixas['Mais de 60 min']++;
            });
            
            const ctx = document.getElementById('chartTempo');
            if (!ctx) return;
            
            charts.tempo = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(faixas),
                    datasets: [{
                        data: Object.values(faixas),
                        backgroundColor: ['#48bb78', '#667eea', '#f56565', '#ed8936']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Gr√°fico 5: Organiza√ß√£o Coletiva
        function renderizarGraficoOrganizacao() {
            const organizacoes = {
                'Cooperativa': 0,
                'Associa√ß√£o': 0,
                'Sindicato': 0,
                'N√£o participa': 0
            };
            
            todosFormularios.forEach(f => {
                const org = f.respostas?.organizacao_coletiva || 'N√£o participa';
                if (organizacoes.hasOwnProperty(org)) {
                    organizacoes[org]++;
                }
            });
            
            const ctx = document.getElementById('chartOrganizacao');
            if (!ctx) return;
            
            charts.organizacao = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(organizacoes),
                    datasets: [{
                        label: 'Produtores',
                        data: Object.values(organizacoes),
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // Gr√°fico 6: Satisfa√ß√£o
        function renderizarGraficoSatisfacao() {
            const categorias = {
                'Atendimento': [],
                'Orienta√ß√µes': [],
                'Resultado': [],
                'Geral': []
            };
            
            todosFormularios.forEach(f => {
                if (f.respostas?.satisfacao_atendimento) 
                    categorias['Atendimento'].push(parseFloat(f.respostas.satisfacao_atendimento));
                if (f.respostas?.satisfacao_orientacoes) 
                    categorias['Orienta√ß√µes'].push(parseFloat(f.respostas.satisfacao_orientacoes));
                if (f.respostas?.satisfacao_resultado) 
                    categorias['Resultado'].push(parseFloat(f.respostas.satisfacao_resultado));
                if (f.respostas?.satisfacao_geral) 
                    categorias['Geral'].push(parseFloat(f.respostas.satisfacao_geral));
            });
            
            const medias = Object.keys(categorias).map(cat => {
                const valores = categorias[cat];
                return valores.length > 0 
                    ? (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(1)
                    : 0;
            });
            
            const ctx = document.getElementById('chartSatisfacao');
            if (!ctx) return;
            
            charts.satisfacao = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        label: 'M√©dia de Satisfa√ß√£o (1-5)',
                        data: medias,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5
                        }
                    }
                }
            });
        }
        
        // Gr√°fico 7: Mudan√ßas Percebidas
        function renderizarGraficoMudancas() {
            const mudancas = {
                'Produ√ß√£o': { 'Melhorou': 0, 'Manteve': 0, 'Piorou': 0 },
                'Qualidade': { 'Melhorou': 0, 'Manteve': 0, 'Piorou': 0 },
                'Vendas': { 'Melhorou': 0, 'Manteve': 0, 'Piorou': 0 }
            };
            
            todosFormularios.forEach(f => {
                const prod = f.respostas?.mudanca_producao;
                const qual = f.respostas?.mudanca_qualidade;
                const vend = f.respostas?.mudanca_vendas;
                
                if (prod && mudancas['Produ√ß√£o'][prod]) mudancas['Produ√ß√£o'][prod]++;
                if (qual && mudancas['Qualidade'][qual]) mudancas['Qualidade'][qual]++;
                if (vend && mudancas['Vendas'][vend]) mudancas['Vendas'][vend]++;
            });
            
            const ctx = document.getElementById('chartMudancas');
            if (!ctx) return;
            
            charts.mudancas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(mudancas),
                    datasets: [
                        {
                            label: 'Melhorou',
                            data: Object.values(mudancas).map(m => m['Melhorou']),
                            backgroundColor: '#48bb78'
                        },
                        {
                            label: 'Manteve',
                            data: Object.values(mudancas).map(m => m['Manteve']),
                            backgroundColor: '#ed8936'
                        },
                        {
                            label: 'Piorou',
                            data: Object.values(mudancas).map(m => m['Piorou']),
                            backgroundColor: '#f56565'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Gr√°fico 8: Canais de Comercializa√ß√£o
        function renderizarGraficoCanais() {
            const canais = {};
            
            todosFormularios.forEach(f => {
                const canaisForm = f.respostas?.canais_comercializacao;
                if (Array.isArray(canaisForm)) {
                    canaisForm.forEach(c => {
                        canais[c] = (canais[c] || 0) + 1;
                    });
                }
            });
            
            const ctx = document.getElementById('chartCanais');
            if (!ctx) return;
            
            charts.canais = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(canais),
                    datasets: [{
                        label: 'Frequ√™ncia',
                        data: Object.values(canais),
                        backgroundColor: '#4facfe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // Inicializar mapa
        function inicializarMapa() {
            const mapElement = document.getElementById('map');
            if (!mapElement) return;
            
            mapaRelatorios = L.map('map').setView([-10.9, -62.8], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapaRelatorios);
            
            // Adicionar marcadores com GPS
            let countGPS = 0;
            todosFormularios.forEach(f => {
                const geo = f.geolocalizacao || f;
                if (geo && geo.latitude && geo.longitude) {
                    const marker = L.marker([geo.latitude, geo.longitude])
                        .bindPopup(`
                            <strong>${f.protocolo}</strong><br>
                            ${f.respostas?.municipio || 'N/A'}<br>
                            <small>Precis√£o: ¬±${Math.round(geo.precisao || 0)}m</small>
                        `);
                    marker.addTo(mapaRelatorios);
                    countGPS++;
                }
            });
            
            const counterElement = document.getElementById('gps-counter');
            if (counterElement) {
                counterElement.textContent = `${countGPS} registros com GPS`;
            }
        }
        
        // Fun√ß√µes auxiliares
        function mostrarLoading(mostrar) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = mostrar ? 'flex' : 'none';
            }
        }
        
        function ocultarLoading() {
            mostrarLoading(false);
        }
        
        function mostrarMensagemVazia() {
            const container = document.querySelector('.relatorios-container');
            if (container) {
                container.innerHTML += '<div class=\"no-data\">üìä Nenhum formul√°rio encontrado. Complete alguns formul√°rios para visualizar os relat√≥rios.</div>';
            }
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            alert('Filtros ainda n√£o implementados. Utilize esta fun√ß√£o para filtrar por per√≠odo, munic√≠pio, etc.');
        }
        
        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtro-data-inicio').value = '';
            document.getElementById('filtro-data-fim').value = '';
            document.getElementById('filtro-municipio').value = '';
            document.getElementById('filtro-sistema').value = '';
            carregarDados();
        }
        
        // Exportar relat√≥rio
        function exportarRelatorio() {
            alert('Exporta√ß√£o para PDF ainda n√£o implementada.');
        }
        
        // Voltar ao painel
        function voltarAdmin() {
            window.location.href = 'admin.html';
        }
        
        // Exportar gr√°fico como imagem
        function exportarGrafico(chartId) {
            const chart = Chart.getChart(chartId);
            if (chart) {
                const link = document.createElement('a');
                link.download = `${chartId}-${new Date().toISOString().split('T')[0]}.png`;
                link.href = chart.toBase64Image();
                link.click();
                console.log(`‚úÖ Gr√°fico ${chartId} exportado com sucesso`);
            } else {
                console.error(`‚ùå Gr√°fico ${chartId} n√£o encontrado`);
                alert('Erro ao exportar gr√°fico. Tente novamente.');
            }
        }
    </script>
</body>
</html>
