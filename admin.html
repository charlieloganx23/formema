<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Painel Administrativo - EMATECH v2.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 0;
            overflow: hidden;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .admin-header p {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
        }
        
        .admin-content {
            padding: 40px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            margin: 15px 0 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.95;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }
        
        .stat-sublabel {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .action-section {
            margin-bottom: 40px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .btn-action {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }
        
        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-action:active {
            transform: translateY(-1px);
        }
        
        .data-table {
            width: 100%;
            background: #f7fafc;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .table-header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 20px 25px;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .table-content {
            max-height: 600px;
            overflow-y: auto;
            background: white;
        }
        
        .table-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .table-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        .table-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .data-row {
            padding: 18px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: 2fr 1.2fr 0.8fr 1.2fr auto;
            gap: 20px;
            align-items: center;
            transition: all 0.2s ease;
            background: white;
        }
        
        .data-row:hover {
            background: #f7fafc;
            box-shadow: inset 0 0 0 2px #667eea;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            box-shadow: 0 2px 4px rgba(34, 84, 61, 0.1);
        }
        
        .badge-warning {
            background: linear-gradient(135deg, #feebc8 0%, #fbd38d 100%);
            color: #744210;
            box-shadow: 0 2px 4px rgba(116, 66, 16, 0.1);
        }
        
        @media (max-width: 1024px) {
            .admin-content {
                padding: 30px 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .data-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .admin-header {
                padding: 30px 20px;
            }
            
            .admin-header h1 {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 2.5rem;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        
        /* Bot√£o de Relat√≥rios em Destaque */
        .btn-relatorios {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-relatorios:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 30px rgba(25, 118, 210, 0.6);
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
        }
        
        .btn-relatorios:active {
            transform: translateY(-1px);
        }
        
        /* Estilos da barra de progresso de sincroniza√ß√£o */
        .sync-progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }
        
        .sync-progress-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
        }
        
        .sync-progress-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .sync-progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .sync-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2e7d32 0%, #4caf50 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .sync-progress-text {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal de Loading para Sincroniza√ß√£o */
        .sync-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .sync-modal-overlay.active {
            display: flex;
        }

        .sync-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.4s ease;
        }

        .sync-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            margin: 0 auto 25px;
            animation: spin 1s linear infinite;
        }

        .sync-modal h2 {
            color: #2d3748;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .sync-modal p {
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .sync-progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .sync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.4s ease;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .sync-status {
            margin-top: 15px;
            color: #4a5568;
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            min-width: 320px;
            animation: slideInRight 0.4s ease;
            border-left: 4px solid #667eea;
        }

        .toast.success {
            border-left-color: #48bb78;
        }

        .toast.error {
            border-left-color: #f56565;
        }

        .toast.info {
            border-left-color: #4299e1;
        }

        .toast.warning {
            border-left-color: #ed8936;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: #718096;
            line-height: 1.5;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #4a5568;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>üìä Painel Administrativo</h1>
            <p>Gerenciamento Completo de Dados - EMATECH v2.0</p>
        </header>
        
        <div class="admin-content">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">Total de Formul√°rios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèõÔ∏è</div>
                    <div class="stat-value" id="stat-municipios">-</div>
                    <div class="stat-label">Munic√≠pios Visitados</div>
                    <div class="stat-sublabel">de 52 munic√≠pios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìç</div>
                    <div class="stat-value" id="stat-cobertura">-</div>
                    <div class="stat-label">Cobertura</div>
                    <div class="stat-sublabel">% do estado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value" id="stat-7dias">-</div>
                    <div class="stat-label">√öltimos 7 Dias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="stat-tempo">-</div>
                    <div class="stat-label">Tempo M√©dio</div>
                    <div class="stat-sublabel">minutos</div>
                </div>
            </div>
        
            <!-- Bot√£o de Relat√≥rios em Destaque -->
            <div class="action-section" style="text-align: center;">
                <button class="btn-relatorios" onclick="abrirRelatorios()">
                    üìä VER RELAT√ìRIOS E GR√ÅFICOS COMPLETOS
                </button>
            </div>
            
            <!-- A√ß√µes Principais -->
            <div class="action-section">
                <h2 class="section-title">üöÄ A√ß√µes R√°pidas</h2>
                <div class="action-buttons">
                    <button class="btn-action btn-primary" onclick="window.location.href='mapa-cobertura.html'">
                        üó∫Ô∏è Mapa de Cobertura
                    </button>
                    <button class="btn-action btn-primary" onclick="atualizarPagina()">
                        üîÑ Atualizar P√°gina
                    </button>
                    <button class="btn-action btn-primary" onclick="exportarTodosExcel()">
                        üìä Exportar Excel
                    </button>
                    <button class="btn-action btn-secondary" onclick="exportarTodos()">
                        üìÇ Exportar JSON
                    </button>
                    <button class="btn-action btn-secondary" onclick="sincronizarTodos()">
                        üîÑ Sincronizar Tudo
                    </button>
                    <button class="btn-action btn-danger" onclick="limparDadosLocais()">
                        üóëÔ∏è Limpar Dados Locais
                    </button>
                    <button class="btn-action btn-secondary" onclick="voltarFormulario()">
                        ‚Üê Voltar ao Formul√°rio
                    </button>
                </div>
            </div>
        
            <!-- Tabela de Formul√°rios -->
            <div class="data-table">
                <div class="table-header">
                    üìã Formul√°rios Coletados
                </div>
                <div style="padding: 15px 25px; background: #f7fafc; display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 1.2fr auto; gap: 20px; font-weight: 600; color: #4a5568; border-bottom: 2px solid #e2e8f0; font-size: 0.9em;">
                    <div>Protocolo/Munic√≠pio</div>
                    <div>Data/Hora</div>
                    <div>Dura√ß√£o</div>
                    <div>Status</div>
                    <div>A√ß√µes</div>
                </div>
                <div class="table-content" id="tableContent">
                    <p style="padding: 20px; text-align: center; color: #666;">
                        Carregando dados...
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes -->
    <div id="modalDetalhes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Formul√°rio</h2>
                <button class="modal-close" onclick="fecharModal()">√ó</button>
            </div>
            <div id="modalBody">
                <!-- Conte√∫do din√¢mico -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Modal de Sincroniza√ß√£o -->
    <div id="syncModal" class="sync-modal-overlay">
        <div class="sync-modal">
            <div class="sync-spinner"></div>
            <h2 id="syncModalTitle">Sincronizando...</h2>
            <p id="syncModalMessage">Por favor, aguarde enquanto processamos os dados.</p>
            <div class="sync-progress-bar">
                <div id="syncProgressFill" class="sync-progress-fill" style="width: 0%;"></div>
            </div>
            <div id="syncStatus" class="sync-status"></div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="db-extensionistas.js"></script>
    <script>
        // Vari√°vel global para armazenar formul√°rios
        let formulariosGlobal = [];
        
        // ==================== FUN√á√ïES GLOBAIS (dispon√≠veis para onclick) ====================
        
        // Voltar ao formul√°rio
        window.voltarFormulario = function() {
            window.location.href = 'index.html';
        };
        
        // Atualizar p√°gina com hard refresh (limpa cache)
        window.atualizarPagina = function() {
            console.log('üîÑ Atualizando p√°gina com hard refresh...');
            
            // Adicionar par√¢metro de timestamp para for√ßar bypass do cache
            const url = new URL(window.location.href);
            url.searchParams.set('nocache', Date.now());
            
            // Recarregar com novo URL (for√ßa download de recursos)
            window.location.href = url.toString();
        };
        
        // Vari√°vel para controlar √∫ltimo count
        let ultimoCountFormularios = 0;
        let ultimoCountSincronizados = 0;
        
        // Inicializar painel quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', async function() {
            await carregarDadosServidor();
            await carregarFormulariosPendentes();
            
            // Iniciar auto-refresh a cada 3 segundos
            iniciarAutoRefresh();
        });
        
        // Sistema de auto-refresh para detectar mudan√ßas
        function iniciarAutoRefresh() {
            console.log('üîÑ Auto-refresh ativado (verifica a cada 3s)');
            
            setInterval(async () => {
                try {
                    // Verificar se houve mudan√ßas no IndexedDB
                    const db = await initDB();
                    const transaction = db.transaction(['formularios'], 'readonly');
                    const store = transaction.objectStore('formularios');
                    
                    const countRequest = store.count();
                    
                    countRequest.onsuccess = async () => {
                        const totalAtual = countRequest.result;
                        
                        // Se o total mudou, recarregar
                        if (totalAtual !== ultimoCountFormularios) {
                            console.log(`üìä Detectada mudan√ßa: ${ultimoCountFormularios} ‚Üí ${totalAtual} formul√°rios`);
                            ultimoCountFormularios = totalAtual;
                            await carregarDadosServidor();
                            await carregarFormulariosPendentes();
                            showToast('info', 'Dados Atualizados', 'Painel administrativo atualizado automaticamente.', 3000);
                        } else {
                            // Verificar se houve mudan√ßa nos sincronizados
                            const getAllRequest = store.getAll();
                            getAllRequest.onsuccess = async () => {
                                const formularios = getAllRequest.result;
                                const sincronizados = formularios.filter(f => f.sincronizado).length;
                                
                                if (sincronizados !== ultimoCountSincronizados) {
                                    console.log(`‚úÖ Mudan√ßa em sincronizados: ${ultimoCountSincronizados} ‚Üí ${sincronizados}`);
                                    ultimoCountSincronizados = sincronizados;
                                    await carregarDadosServidor();
                                    await carregarFormulariosPendentes();
                                    showToast('success', 'Sincroniza√ß√£o Detectada', 'Formul√°rios sincronizados atualizados!', 3000);
                                }
                            };
                        }
                    };
                } catch (error) {
                    console.error('‚ö†Ô∏è Erro no auto-refresh:', error);
                }
            }, 3000); // Verifica a cada 3 segundos
        }
        
        // Carregar dados do IndexedDB local
        async function carregarDadosServidor() {
            try {
                console.log('üîÑ Carregando estat√≠sticas do IndexedDB...');
                
                // Buscar todos os formul√°rios do IndexedDB
                const db = await initDB();
                const transaction = db.transaction(['formularios'], 'readonly');
                const store = transaction.objectStore('formularios');
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const todosFormularios = request.result;
                        
                        // Parse de campos JSON (quando vem do servidor)
                        todosFormularios.forEach(form => {
                            if (form.respostas && typeof form.respostas === 'string') {
                                try {
                                    form.respostas = JSON.parse(form.respostas);
                                } catch (e) {
                                    console.warn('Erro ao fazer parse de respostas:', form.protocolo, e);
                                }
                            }
                            if (form.fotos && typeof form.fotos === 'string') {
                                try {
                                    form.fotos = JSON.parse(form.fotos);
                                } catch (e) {
                                    console.warn('Erro ao fazer parse de fotos:', form.protocolo, e);
                                }
                            }
                        });
                        
                        formulariosGlobal = todosFormularios;
                        
                        // Atualizar contadores de controle
                        ultimoCountFormularios = todosFormularios.length;
                        ultimoCountSincronizados = todosFormularios.filter(f => f.sincronizado).length;
                        
                        console.log(`‚úÖ ${todosFormularios.length} formul√°rios carregados do IndexedDB`);
                        console.log(`‚úÖ ${ultimoCountSincronizados} sincronizados, ${todosFormularios.length - ultimoCountSincronizados} pendentes`);
                        
                        // Calcular KPIs
                        const totalFormularios = todosFormularios.length;
                        const municipiosUnicos = new Set(todosFormularios.map(f => f.respostas?.municipio).filter(Boolean));
                        const municipiosVisitados = municipiosUnicos.size;
                        const coberturaPercentual = Math.round((municipiosVisitados / 52) * 100);
                        
                        // Formul√°rios dos √∫ltimos 7 dias
                        const seteDiasAtras = new Date();
                        seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);
                        const ultimos7dias = todosFormularios.filter(f => {
                            const dataForm = new Date(f.timestampFim || f.timestamp_fim);
                            return dataForm >= seteDiasAtras;
                        }).length;
                        
                        // Tempo m√©dio
                        const formsComDuracao = todosFormularios.filter(f => f.duracaoMinutos || f.duracao_minutos);
                        const tempoMedio = formsComDuracao.length > 0
                            ? Math.round(formsComDuracao.reduce((sum, f) => sum + (f.duracaoMinutos || f.duracao_minutos || 0), 0) / formsComDuracao.length)
                            : 0;
                        
                        // Atualizar KPIs
                        document.getElementById('stat-total').textContent = totalFormularios;
                        document.getElementById('stat-municipios').textContent = municipiosVisitados;
                        document.getElementById('stat-cobertura').textContent = coberturaPercentual + '%';
                        document.getElementById('stat-7dias').textContent = ultimos7dias;
                        document.getElementById('stat-tempo').textContent = tempoMedio;
                        
                        // Renderizar √∫ltimos 20 formul√°rios
                        const ultimosFormularios = todosFormularios
                            .sort((a, b) => {
                                const dataA = new Date(a.timestampFim || a.timestamp_fim || 0);
                                const dataB = new Date(b.timestampFim || b.timestamp_fim || 0);
                                return dataB - dataA;
                            })
                            .slice(0, 20);
                        
                        renderizarFormularios(ultimosFormularios);
                        
                        console.log('‚úÖ Painel atualizado com sucesso!');
                        resolve();
                    };
                    
                    request.onerror = () => {
                        console.error('‚ùå Erro ao buscar formul√°rios do IndexedDB');
                        document.getElementById('tableContent').innerHTML = `
                            <p style="padding: 20px; text-align: center; color: #d32f2f;">
                                ‚ö†Ô∏è Erro ao carregar dados do IndexedDB
                            </p>
                        `;
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('tableContent').innerHTML = `
                    <p style="padding: 20px; text-align: center; color: #d32f2f;">
                        ‚ö†Ô∏è Erro ao carregar dados: ${error.message}
                    </p>
                `;
            }
        }
        
        // Carregar estat√≠sticas (DEPRECATED - agora vem do servidor)
        async function carregarEstatisticas() {
            // Mantido para compatibilidade, mas n√£o usado mais
            console.log('‚ö†Ô∏è carregarEstatisticas() deprecated - usando dados do servidor');
        }
        
        // Carregar lista de formul√°rios (DEPRECATED - agora vem do servidor)
        async function carregarFormularios() {
            // Mantido para compatibilidade, mas n√£o usado mais
            console.log('‚ö†Ô∏è carregarFormularios() deprecated - usando dados do servidor');
        }
        
        // Carregar formul√°rios pendentes do IndexedDB
        async function carregarFormulariosPendentes() {
            try {
                console.log('üîÑ Verificando formul√°rios pendentes no IndexedDB...');
                
                // Usar initDB do db.js
                const db = await initDB();
                const transaction = db.transaction(['formularios'], 'readonly');
                const store = transaction.objectStore('formularios');
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const todosForms = request.result;
                        
                        // Filtrar apenas os n√£o sincronizados
                        const pendentes = todosForms.filter(f => !f.sincronizado);
                        
                        if (pendentes.length > 0) {
                            console.log(`‚ö†Ô∏è ${pendentes.length} formul√°rio(s) pendente(s) de sincroniza√ß√£o`);
                            
                            // Atualizar contador na estat√≠stica
                            const statPendentes = document.createElement('div');
                            statPendentes.className = 'stat-card';
                            statPendentes.style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
                            statPendentes.innerHTML = `
                                <div class="stat-label" style="color: white;">‚ö†Ô∏è Pendentes</div>
                                <div class="stat-value" style="color: white;">${pendentes.length}</div>
                                <small style="color: rgba(255,255,255,0.9); font-size: 0.8em;">aguardando sincroniza√ß√£o</small>
                            `;
                            document.getElementById('statsGrid').appendChild(statPendentes);
                            
                            // Adicionar se√ß√£o de pendentes antes da tabela de formul√°rios
                            const container = document.getElementById('tableContent');
                            const pendentesHtml = `
                                <div style="background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                                    <h3 style="margin: 0 0 10px 0; color: #856404;">
                                        ‚ö†Ô∏è Formul√°rios Pendentes de Sincroniza√ß√£o (${pendentes.length})
                                    </h3>
                                    <p style="margin: 0 0 15px 0; color: #856404; font-size: 14px;">
                                        Estes formul√°rios est√£o salvos localmente mas ainda n√£o foram enviados ao servidor.
                                    </p>
                                    ${pendentes.map(form => `
                                        <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #f39c12;">
                                            <strong style="color: #856404;">${form.protocolo}</strong>
                                            <span style="margin-left: 10px; color: #666; font-size: 13px;">
                                                ${form.respostas?.municipio || 'N/A'} - 
                                                ${form.timestampFim ? new Date(form.timestampFim).toLocaleDateString('pt-BR') : 'N/A'}
                                            </span>
                                            <span style="float: right; background: #f39c12; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                                                PENDENTE
                                            </span>
                                        </div>
                                    `).join('')}
                                    <button id="btn-sync-manual" onclick="sincronizarManual()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                                        üîÑ Sincronizar Todos Agora
                                    </button>
                                </div>
                            `;
                            container.insertAdjacentHTML('afterbegin', pendentesHtml);
                        } else {
                            console.log('‚úÖ Nenhum formul√°rio pendente');
                        }
                        
                        resolve(pendentes);
                    };
                    
                    request.onerror = () => {
                        console.error('‚ùå Erro ao buscar formul√°rios pendentes');
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('‚ùå Erro ao verificar pendentes:', error);
            }
        }
        
        // Renderizar formul√°rios na tabela
        function renderizarFormularios(formularios) {
            try {
                const container = document.getElementById('tableContent');
                
                if (!formularios || formularios.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Nenhum formul√°rio encontrado.</p>';
                    return;
                }
                
                console.log(`üìã Renderizando ${formularios.length} √∫ltimos formul√°rios...`);
                container.innerHTML = '';
                
                formularios.forEach(form => {
                    const row = document.createElement('div');
                    row.className = 'data-row';
                    row.style.cursor = 'pointer';
                    row.onclick = function(e) {
                        // N√£o abrir se clicar nos bot√µes
                        if (!e.target.closest('button')) {
                            verDetalhes(form.protocolo);
                        }
                    };
                    
                    // Normalizar campos (suporta tanto snake_case do PHP quanto camelCase do JS)
                    const protocolo = form.protocolo;
                    const municipio = form.municipio || form.respostas?.municipio || 'N/A';
                    const timestampFim = form.timestampFim || form.timestamp_fim;
                    const duracaoMinutos = form.duracaoMinutos || form.duracao_minutos || 0;
                    const status = form.status || 'N/A';
                    
                    // Formatar data
                    const dataFormatada = timestampFim ? 
                        new Date(timestampFim).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'N/A';
                    
                    // Status baseado apenas na sincroniza√ß√£o
                    const statusCompleto = form.sincronizado ? 'Completo' : 'Pendente';
                    const badgeClass = form.sincronizado ? 'badge-success' : 'badge-warning';
                    
                    row.innerHTML = `
                        <div>
                            <strong>${protocolo || '-'}</strong><br>
                            <small>${municipio}</small>
                        </div>
                        <div>${dataFormatada}</div>
                        <div>${duracaoMinutos}min</div>
                        <div>
                            <span class="badge ${badgeClass}">
                                ${statusCompleto}
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-action btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="verDetalhes('${form.protocolo}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            <button class="btn-action btn-primary" style="padding: 6px 12px; font-size: 0.85em; background: #1976d2;" onclick="exportarExcel('${form.protocolo}')" title="Exportar para Excel">
                                üìä Excel
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(row);
                });
                
                console.log('‚úÖ Formul√°rios renderizados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao renderizar formul√°rios:', error);
            }
        }
        
        // Ver detalhes do formul√°rio
        window.verDetalhes = async function(protocolo) {
            try {
                // Buscar formul√°rio no array global
                let form = formulariosGlobal.find(f => f.protocolo === protocolo);
                
                if (!form) {
                    alert('Formul√°rio n√£o encontrado');
                    return;
                }
                
                // Se respostas √© string JSON, fazer parse
                if (form.respostas && typeof form.respostas === 'string') {
                    try {
                        form.respostas = JSON.parse(form.respostas);
                    } catch (e) {
                        console.warn('Erro ao fazer parse de respostas:', e);
                    }
                }
                
                const modal = document.getElementById('modalDetalhes');
                const body = document.getElementById('modalBody');
                
                // Extrair dados do formul√°rio (compat√≠vel com ambos formatos)
                const municipio = form.respostas?.municipio || form.municipio || 'N/A';
                const identificador = form.respostas?.identificador_iniciais || form.identificador_iniciais || form.nomeCompleto || 'N/A';
                const unidade = form.respostas?.unidade_emater || form.unidade_emater || form.escritorioLocal || null;
                const timestampFim = form.timestampFim || form.timestamp_fim;
                const duracaoMinutos = form.duracaoMinutos || form.duracao_minutos || 0;
                
                // Se respostas estiver vazio mas tiver dados no root, usar os dados do root
                let respostasParaMostrar = form.respostas;
                if (!respostasParaMostrar || Object.keys(respostasParaMostrar).length === 0) {
                    // Criar objeto respostas a partir dos campos do formul√°rio
                    respostasParaMostrar = { ...form };
                    // Remover campos meta
                    delete respostasParaMostrar.id;
                    delete respostasParaMostrar.protocolo;
                    delete respostasParaMostrar.timestamp_inicio;
                    delete respostasParaMostrar.timestamp_fim;
                    delete respostasParaMostrar.sincronizado;
                    delete respostasParaMostrar.versao_formulario;
                    delete respostasParaMostrar.data_sincronizacao;
                }
                
                // Preparar informa√ß√µes de GPS (suporta tanto objeto quanto campos diretos)
                const geo = form.geolocalizacao || form;
                let gpsInfo = '<p><strong>üìç Geolocaliza√ß√£o:</strong> ';
                if (geo && geo.latitude) {
                    const lat = geo.latitude.toFixed(6);
                    const lng = geo.longitude.toFixed(6);
                    const precisao = Math.round(geo.precisao || 0);
                    
                    // Formatar precis√£o
                    let precisaoTexto = '';
                    let qualidadeTexto = '';
                    let corQualidade = '#666';
                    
                    if (precisao >= 1000) {
                        precisaoTexto = `${(precisao / 1000).toFixed(1)}km`;
                    } else {
                        precisaoTexto = `${precisao}m`;
                    }
                    
                    if (precisao < 20) {
                        qualidadeTexto = 'Excelente';
                        corQualidade = '#2e7d32';
                    } else if (precisao < 50) {
                        qualidadeTexto = 'Boa';
                        corQualidade = '#388e3c';
                    } else if (precisao < 100) {
                        qualidadeTexto = 'Moderada';
                        corQualidade = '#f57c00';
                    } else if (precisao < 1000) {
                        qualidadeTexto = 'Baixa';
                        corQualidade = '#e64a19';
                    } else {
                        qualidadeTexto = 'Muito Baixa';
                        corQualidade = '#d32f2f';
                    }
                    
                    gpsInfo += `<br>
                        ‚Ä¢ Latitude: ${lat}<br>
                        ‚Ä¢ Longitude: ${lng}<br>
                        ‚Ä¢ Precis√£o: ¬±${precisaoTexto} <span style="color: ${corQualidade}; font-weight: 600;">(${qualidadeTexto})</span><br>
                        ‚Ä¢ <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color: #1976d2;">üó∫Ô∏è Ver no Google Maps</a>
                    `;
                } else if (geo && geo.erro) {
                    gpsInfo += `<span style="color: #d32f2f;">${geo.erro}</span>`;
                } else {
                    gpsInfo += '<span style="color: #666;">N√£o capturado</span>';
                }
                gpsInfo += '</p>';
                
                // Preparar galeria de fotos
                let fotosGaleria = '';
                if (form.fotos && form.fotos.length > 0) {
                    fotosGaleria = `
                        <p><strong>üì∏ Fotos da Propriedade:</strong> ${form.fotos.length} foto(s)</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${form.fotos.map((foto, index) => `
                                <div style="position: relative; cursor: pointer;" onclick="abrirFotoModal('${form.protocolo}', ${index})">
                                    <img src="${foto.data}" 
                                         alt="${foto.nome}" 
                                         style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 3px; border-radius: 4px; text-align: center;">
                                        ${(foto.tamanho / 1024).toFixed(0)}KB
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                            <em>Clique nas fotos para visualizar em tamanho maior</em>
                        </p>
                    `;
                }
                
                // Formatar respostas de forma leg√≠vel
                const formatarRespostas = (respostas) => {
                    const labels = {
                        municipio: 'Munic√≠pio',
                        escritorioLocal: 'Escrit√≥rio Local',
                        tempoEmater: 'Tempo na EMATER',
                        nomeCompleto: 'Nome Completo',
                        resultadosRelevantes: 'Resultados Relevantes',
                        impacto_aumento_produtividade: 'Impacto - Aumento de Produtividade',
                        impacto_aumento_comercializacao: 'Impacto - Aumento de Comercializa√ß√£o',
                        impacto_inclusao_programas: 'Impacto - Inclus√£o em Programas',
                        impacto_implementacao_tecnologias: 'Impacto - Implementa√ß√£o de Tecnologias',
                        impacto_fortalecimento_organizacoes: 'Impacto - Fortalecimento de Organiza√ß√µes',
                        impacto_capacitacao_produtores: 'Impacto - Capacita√ß√£o de Produtores',
                        impacto_reducao_perdas: 'Impacto - Redu√ß√£o de Perdas',
                        desafio_fatores_externos: 'Desafio - Fatores Externos',
                        desafio_falta_pessoal: 'Desafio - Falta de Pessoal',
                        desafio_falta_veiculos: 'Desafio - Falta de Ve√≠culos',
                        desafio_falta_orcamento: 'Desafio - Falta de Or√ßamento',
                        desafio_baixa_organizacao: 'Desafio - Baixa Organiza√ß√£o',
                        desafio_falta_dados: 'Desafio - Falta de Dados',
                        desafio_resistencia_produtores: 'Desafio - Resist√™ncia dos Produtores',
                        desafio_burocracia: 'Desafio - Burocracia',
                        estrategias: 'Estrat√©gias Utilizadas',
                        estrategiaMaisEfetiva: 'Estrat√©gia Mais Efetiva',
                        criteriosPriorizacao: 'Crit√©rios de Prioriza√ß√£o',
                        documentoFormalCriterios: 'Documento Formal de Crit√©rios',
                        instrumentosPriorizacao: 'Instrumentos de Prioriza√ß√£o',
                        parceriasAtivas: 'Parcerias Ativas',
                        participaForuns: 'Participa de F√≥runs',
                        influenciaEmater: 'Influ√™ncia da EMATER',
                        freqDemandaMercado: 'Frequ√™ncia de Demanda de Mercado',
                        capacitacaoMercado: 'Capacita√ß√£o para Mercado',
                        impactoCapacitacao: 'Impacto da Capacita√ß√£o',
                        instrumentosProducao: 'Instrumentos de Produ√ß√£o',
                        freqApoioMercadosInstitucionais: 'Frequ√™ncia de Apoio a Mercados Institucionais',
                        conhecimentoOfertaDemanda: 'Conhecimento de Oferta/Demanda',
                        indicadoresDesempenho: 'Indicadores de Desempenho',
                        indicadoresFormalizados: 'Indicadores Formalizados',
                        indicadoresEfetividade: 'Indicadores de Efetividade',
                        frequenciaInfluencia: 'Frequ√™ncia de Influ√™ncia',
                        capacidadeAcompanhamento: 'Capacidade de Acompanhamento'
                    };
                    
                    const formatarValor = (chave, valor) => {
                        if (valor === null || valor === undefined || valor === '') return '<em style="color: #999;">N√£o informado</em>';
                        
                        // Arrays
                        if (Array.isArray(valor)) {
                            if (valor.length === 0) return '<em style="color: #999;">Nenhum</em>';
                            return valor.map(v => `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px; display: inline-block; margin: 2px;">${v}</span>`).join(' ');
                        }
                        
                        // Escala de 1-5
                        if (chave.includes('impacto_') || chave.includes('desafio_') || chave.includes('influencia') || chave.includes('conhecimento') || chave.includes('capacidade') || chave === 'documentoFormalCriterios') {
                            const num = parseInt(valor);
                            if (!isNaN(num) && num >= 1 && num <= 5) {
                                const cor = num >= 4 ? '#4caf50' : num >= 3 ? '#ff9800' : '#f44336';
                                return `<span style="color: ${cor}; font-weight: bold; font-size: 1.1em;">${'‚òÖ'.repeat(num)}${'‚òÜ'.repeat(5-num)}</span> <span style="color: #666;">(${num}/5)</span>`;
                            }
                        }
                        
                        // Sim/N√£o
                        if (valor === 'sim' || valor === 'nao') {
                            return valor === 'sim' ? '<span style="color: #4caf50; font-weight: bold;">‚úì Sim</span>' : '<span style="color: #f44336;">‚úó N√£o</span>';
                        }
                        
                        // Tempo EMATER
                        if (chave === 'tempoEmater') {
                            const tempos = {
                                'menos5': 'Menos de 5 anos',
                                '5-10': '5 a 10 anos',
                                '10-20': '10 a 20 anos',
                                'mais20': 'Mais de 20 anos'
                            };
                            return tempos[valor] || valor;
                        }
                        
                        // Coment√°rios longos
                        if (chave.includes('comentario') || chave.includes('exemplo') || chave.includes('limitacoes') || chave.includes('Quais')) {
                            return `<div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-top: 4px; font-style: italic;">${valor}</div>`;
                        }
                        
                        return valor;
                    };
                    
                    let html = '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    // Agrupar por categoria
                    const categorias = {
                        'Informa√ß√µes B√°sicas': ['municipio', 'escritorioLocal', 'tempoEmater', 'nomeCompleto'],
                        'Resultados e Impactos': ['resultadosRelevantes', 'impacto_aumento_produtividade', 'impacto_aumento_comercializacao', 'impacto_inclusao_programas', 'impacto_implementacao_tecnologias', 'impacto_fortalecimento_organizacoes', 'impacto_capacitacao_produtores', 'impacto_reducao_perdas'],
                        'Desafios': ['desafio_fatores_externos', 'desafio_falta_pessoal', 'desafio_falta_veiculos', 'desafio_falta_orcamento', 'desafio_baixa_organizacao', 'desafio_falta_dados', 'desafio_resistencia_produtores', 'desafio_burocracia'],
                        'Estrat√©gias e Prioriza√ß√£o': ['estrategias', 'estrategiaMaisEfetiva', 'criteriosPriorizacao', 'documentoFormalCriterios', 'instrumentosPriorizacao', 'exemploInstrumento'],
                        'Parcerias e Participa√ß√£o': ['parceriasAtivas', 'participaForuns', 'influenciaEmater'],
                        'Mercado e Comercializa√ß√£o': ['freqDemandaMercado', 'capacitacaoMercado', 'impactoCapacitacao', 'instrumentosProducao', 'exemploInstrumentosProducao', 'freqApoioMercadosInstitucionais', 'conhecimentoOfertaDemanda'],
                        'Indicadores e Monitoramento': ['indicadoresDesempenho', 'indicadoresFormalizados', 'indicadoresEfetividade', 'indicadoresEfetividadeQuais', 'frequenciaInfluencia', 'capacidadeAcompanhamento', 'limitacoesAcompanhamento'],
                        'Coment√°rios': ['comentarioB', 'comentarioC', 'comentarioD']
                    };
                    
                    for (const [categoria, campos] of Object.entries(categorias)) {
                        const camposPresentes = campos.filter(c => respostas[c] !== undefined);
                        if (camposPresentes.length > 0) {
                            html += `<h5 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 4px; margin: 16px 0 8px 0;">${categoria}</h5>`;
                            html += '<table style="width: 100%; border-collapse: collapse;">';
                            
                            for (const campo of camposPresentes) {
                                const label = labels[campo] || campo;
                                const valor = formatarValor(campo, respostas[campo]);
                                html += `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-weight: 600; color: #555; width: 40%; vertical-align: top;">${label}:</td>
                                        <td style="padding: 8px; color: #333;">${valor}</td>
                                    </tr>
                                `;
                            }
                            
                            html += '</table>';
                        }
                    }
                    
                    html += '</div>';
                    return html;
                };
                
                body.innerHTML = `
                    <h3>Protocolo: ${form.protocolo}</h3>
                    <p><strong>Munic√≠pio:</strong> ${municipio}</p>
                    <p><strong>Produtor:</strong> ${identificador}</p>
                    ${unidade ? `<p><strong>Unidade EMATER:</strong> ${unidade}</p>` : ''}
                    <p><strong>Data/Hora:</strong> ${timestampFim ? new Date(timestampFim).toLocaleString('pt-BR') : 'N/A'}</p>
                    <p><strong>Dura√ß√£o:</strong> ${duracaoMinutos} minutos</p>
                    <p><strong>Status:</strong> ${form.sincronizado ? 'Completo ‚úÖ' : 'Pendente ‚è≥'}</p>
                    ${gpsInfo}
                    ${fotosGaleria}
                    <hr>
                    <h4>Respostas do Formul√°rio:</h4>
                    ${formatarRespostas(respostasParaMostrar)}
                `;
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes do formul√°rio.');
            }
        };
        
        // Abrir foto em modal
        window.abrirFotoModal = async function(protocolo, fotoIndex) {
            try {
                // Buscar formul√°rio no array global
                const form = formulariosGlobal.find(f => f.protocolo === protocolo);
                
                if (!form || !form.fotos || !form.fotos[fotoIndex]) {
                    alert('Foto n√£o encontrada');
                    return;
                }
                
                const foto = form.fotos[fotoIndex];
                
                // Criar modal para foto
                const modalFoto = document.createElement('div');
                modalFoto.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.95);
                    z-index: 11000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                `;
                
                const dataFoto = new Date(foto.timestamp).toLocaleString('pt-BR');
                
                modalFoto.innerHTML = `
                    <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer;">√ó</div>
                    <img src="${foto.data}" style="max-width: 90%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <div style="color: white; margin-top: 20px; text-align: center;">
                        <div style="font-size: 16px; font-weight: 600;">${foto.nome}</div>
                        <div style="font-size: 14px; margin-top: 5px; opacity: 0.8;">
                            ${(foto.tamanho / 1024).toFixed(1)}KB ‚Ä¢ ${dataFoto}
                        </div>
                        <button onclick="baixarFoto('${foto.data}', '${foto.nome}')" 
                                style="margin-top: 15px; padding: 10px 20px; background: #2e7d32; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üì• Baixar Foto
                        </button>
                    </div>
                `;
                
                modalFoto.onclick = () => document.body.removeChild(modalFoto);
                document.body.appendChild(modalFoto);
                
            } catch (error) {
                console.error('Erro ao abrir foto:', error);
            }
        }
        
        // Baixar foto individual
        window.baixarFoto = function(dataUrl, nomeArquivo) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        // Fechar modal
        window.fecharModal = function() {
            document.getElementById('modalDetalhes').style.display = 'none';
        };
        
        // Exportar todos os dados (JSON) - MODIFICADO: buscar do servidor
        window.exportarTodos = async function() {
            try {
                // Usar dados globais em vez de IndexedDB
                const dados = {
                    versao: '2.0',
                    dataExportacao: new Date().toISOString(),
                    totalFormularios: formulariosGlobal.length,
                    fonte: 'MySQL Railway Server',
                    formularios: formulariosGlobal
                };
                
                const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ematech_backup_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`Exporta√ß√£o conclu√≠da! ${dados.totalFormularios} formul√°rios exportados.`);
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar dados.');
            }
        };
        
        // ==================== SISTEMA DE MODAL E TOASTS ====================
        
        // Mostrar modal de sincroniza√ß√£o
        function showSyncModal(title, message, status = '') {
            const modal = document.getElementById('syncModal');
            const modalTitle = document.getElementById('syncModalTitle');
            const modalMessage = document.getElementById('syncModalMessage');
            const syncStatus = document.getElementById('syncStatus');
            const progressFill = document.getElementById('syncProgressFill');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            syncStatus.textContent = status;
            progressFill.style.width = '0%';
            modal.classList.add('active');
        }

        // Atualizar progresso do modal
        function updateSyncModal(status, progress) {
            const syncStatus = document.getElementById('syncStatus');
            const progressFill = document.getElementById('syncProgressFill');
            
            syncStatus.textContent = status;
            progressFill.style.width = progress + '%';
        }

        // Fechar modal de sincroniza√ß√£o
        function hideSyncModal() {
            const modal = document.getElementById('syncModal');
            modal.classList.remove('active');
        }

        // Mostrar toast notification
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100px)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        // Sincronizar todos - Recarregar do IndexedDB
        window.sincronizarTodos = async function() {
            try {
                showSyncModal('Sincronizando Dados', 'Atualizando formul√°rios do IndexedDB...', 'Iniciando sincroniza√ß√£o...');
                updateSyncModal('Carregando dados locais...', 30);
                
                await carregarDadosServidor();
                updateSyncModal('Verificando formul√°rios pendentes...', 60);
                
                await carregarFormulariosPendentes();
                updateSyncModal('Sincroniza√ß√£o conclu√≠da!', 100);
                
                setTimeout(() => {
                    hideSyncModal();
                    showToast('success', 'Sincroniza√ß√£o Completa', 'Todos os dados foram atualizados com sucesso!');
                }, 500);
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                hideSyncModal();
                showToast('error', 'Erro na Sincroniza√ß√£o', 'N√£o foi poss√≠vel sincronizar os dados. Tente novamente.');
            }
        };
        
        // Limpar dados locais do IndexedDB (apenas deste dispositivo)
        window.limparDadosLocais = async function() {
            const confirmacao1 = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: Limpar Dados Locais\n\n' +
                'Esta a√ß√£o ir√° APAGAR todos os formul√°rios armazenados LOCALMENTE neste dispositivo.\n\n' +
                '‚ö†Ô∏è Formul√°rios N√ÉO SINCRONIZADOS ser√£o PERDIDOS!\n' +
                '‚úÖ Formul√°rios j√° sincronizados permanecer√£o no servidor.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmacao1) return;
            
            const confirmacao2 = confirm(
                'üî¥ √öLTIMA CONFIRMA√á√ÉO\n\n' +
                'Voc√™ tem CERTEZA ABSOLUTA que deseja apagar os dados locais?\n\n' +
                'Esta a√ß√£o √© IRREVERS√çVEL!\n\n' +
                'Clique OK para APAGAR ou Cancelar para MANTER os dados.'
            );
            
            if (!confirmacao2) return;
            
            try {
                console.log('üóëÔ∏è Iniciando limpeza do IndexedDB local...');
                
                // Apagar banco de dados local
                const deleteRequest = indexedDB.deleteDatabase('EmaterFormularios');
                
                deleteRequest.onsuccess = function() {
                    console.log('‚úÖ IndexedDB local apagado com sucesso');
                    alert(
                        '‚úÖ Dados locais apagados com sucesso!\n\n' +
                        'O IndexedDB deste dispositivo foi limpo.\n' +
                        'A p√°gina ser√° recarregada.'
                    );
                    setTimeout(() => window.location.reload(), 1000);
                };
                
                deleteRequest.onerror = function(event) {
                    console.error('‚ùå Erro ao apagar IndexedDB:', event);
                    alert('‚ùå Erro ao apagar dados locais. Verifique o console.');
                };
                
                deleteRequest.onblocked = function() {
                    console.warn('‚ö†Ô∏è Opera√ß√£o bloqueada - feche outras abas do site');
                    alert(
                        '‚ö†Ô∏è Opera√ß√£o bloqueada!\n\n' +
                        'Feche todas as outras abas/janelas deste site e tente novamente.'
                    );
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao limpar dados locais:', error);
                alert('‚ùå Erro ao limpar dados locais: ' + error.message);
            }
        }
        
        // Limpar dados antigos - DESABILITADO (requer endpoint PHP espec√≠fico)
        async function limparDados() {
            alert('‚ö†Ô∏è Esta fun√ß√£o requer implementa√ß√£o no servidor MySQL.\n\nPor seguran√ßa, a exclus√£o de dados deve ser feita diretamente no banco de dados ou via ferramenta administrativa.');
        }
        
        // Exportar formul√°rio individual para Excel
        window.exportarExcel = async function(protocolo) {
            try {
                // Buscar formul√°rio no array global
                const form = formulariosGlobal.find(f => f.protocolo === protocolo);
                
                if (!form) {
                    alert('Formul√°rio n√£o encontrado');
                    return;
                }
                
                console.log('üìä Exportando formul√°rio:', form);
                
                // Criar dados estruturados para Excel
                const dados = [];
                
                // Normalizar campos
                const municipio = form.municipio || form.respostas?.municipio || 'N/A';
                const timestampInicio = form.timestampInicio || form.timestamp_inicio;
                const timestampFim = form.timestampFim || form.timestamp_fim;
                const duracaoMinutos = form.duracaoMinutos || form.duracao_minutos || 0;
                
                // Cabe√ßalho do formul√°rio
                dados.push(['FORMUL√ÅRIO DE PESQUISA - EMATER-RO']);
                dados.push(['Protocolo:', form.protocolo]);
                dados.push(['Munic√≠pio:', municipio]);
                dados.push(['Produtor:', form.identificador_iniciais || form.respostas?.identificador_iniciais || 'N/A']);
                if (form.unidade_emater) {
                    dados.push(['Unidade EMATER:', form.unidade_emater]);
                }
                dados.push(['Data In√≠cio:', timestampInicio ? new Date(timestampInicio).toLocaleString('pt-BR') : 'N/A']);
                dados.push(['Data Fim:', timestampFim ? new Date(timestampFim).toLocaleString('pt-BR') : 'N/A']);
                dados.push(['Dura√ß√£o:', `${duracaoMinutos} minutos`]);
                dados.push(['Status:', form.status === 'completo' || form.status === 'concluido' ? 'Completo' : 'Pendente']);
                dados.push(['']); // Linha em branco
                
                // Geolocaliza√ß√£o (se houver)
                if (form.geolocalizacao && form.geolocalizacao.latitude) {
                    dados.push(['GEOLOCALIZA√á√ÉO']);
                    dados.push(['Latitude:', form.geolocalizacao.latitude]);
                    dados.push(['Longitude:', form.geolocalizacao.longitude]);
                    const precisao = Math.round(form.geolocalizacao.precisao);
                    const precisaoTexto = precisao >= 1000 ? `${(precisao/1000).toFixed(1)}km` : `${precisao}m`;
                    dados.push(['Precis√£o:', precisaoTexto]);
                    if (form.geolocalizacao.altitude) {
                        dados.push(['Altitude:', `${Math.round(form.geolocalizacao.altitude)}m`]);
                    }
                    dados.push(['Timestamp GPS:', new Date(form.geolocalizacao.timestamp).toLocaleString('pt-BR')]);
                    dados.push(['Link Google Maps:', `https://www.google.com/maps?q=${form.geolocalizacao.latitude},${form.geolocalizacao.longitude}`]);
                    dados.push(['']); // Linha em branco
                } else if (form.geolocalizacao && form.geolocalizacao.erro) {
                    dados.push(['GEOLOCALIZA√á√ÉO']);
                    dados.push(['Status:', `Erro - ${form.geolocalizacao.erro}`]);
                    dados.push(['']); // Linha em branco
                }
                
                // Informa√ß√µes gerais do formul√°rio
                dados.push(['INFORMA√á√ïES GERAIS']);
                const comunidade = form.comunidade || form.respostas?.comunidade_localidade;
                const sistemaProdutivo = form.sistema_produtivo || form.respostas?.sistema_produtivo;
                const areaProdutiva = form.area_produtiva || form.respostas?.area_produtiva;
                const atendimentoEmater = form.atendimento_emater || form.respostas?.atendimento_emater;
                
                if (comunidade) {
                    dados.push(['Comunidade/Localidade:', comunidade]);
                }
                if (sistemaProdutivo) {
                    dados.push(['Sistema Produtivo:', sistemaProdutivo]);
                }
                if (areaProdutiva) {
                    dados.push(['√Årea Produtiva:', areaProdutiva]);
                }
                if (atendimentoEmater) {
                    dados.push(['Atendimento EMATER:', atendimentoEmater]);
                }
                dados.push(['']); // Linha em branco
                
                // Respostas do question√°rio (JSON completo)
                dados.push(['RESPOSTAS DO QUESTION√ÅRIO']);
                dados.push(['']); // Linha em branco
                
                if (form.respostas && typeof form.respostas === 'object') {
                    // Iterar pelas respostas
                    for (const [chave, valor] of Object.entries(form.respostas)) {
                        if (valor !== null && valor !== undefined && valor !== '') {
                            dados.push([chave + ':', JSON.stringify(valor)]);
                        }
                    }
                } else {
                    dados.push(['Nenhuma resposta registrada']);
                }
                dados.push(['']); // Linha em branco
                
                // Converter para CSV
                const csv = dados.map(row => {
                    return row.map(cell => {
                        // Escapar aspas e envolver em aspas se contiver v√≠rgula
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',');
                }).join('\n');
                
                // Adicionar BOM para UTF-8 (corrige acentua√ß√£o no Excel)
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `formulario_${protocolo}_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Formul√°rio exportado para Excel com todas as respostas');
                
            } catch (error) {
                console.error('Erro ao exportar para Excel:', error);
                alert('Erro ao exportar formul√°rio. Verifique o console.');
            }
        }
        
        // Exportar todos os formul√°rios para Excel em um √∫nico arquivo
        window.exportarTodosExcel = async function() {
            try {
                // Usar dados globais do servidor
                const formularios = formulariosGlobal;
                
                if (formularios.length === 0) {
                    alert('Nenhum formul√°rio para exportar.');
                    return;
                }
                
                // Mostrar mensagem de progresso
                const originalText = event.target.textContent;
                event.target.textContent = `‚è≥ Exportando ${formularios.length} formul√°rios...`;
                event.target.disabled = true;
                
                console.log(`üìä Exportando ${formularios.length} formul√°rios para Excel...`);
                
                // Criar array de dados
                const dados = [];
                
                // Cabe√ßalho do arquivo
                dados.push(['FORMUL√ÅRIOS DE PESQUISA - EMATER-RO']);
                dados.push(['Total de Formul√°rios:', formularios.length]);
                dados.push(['Data Exporta√ß√£o:', new Date().toLocaleString('pt-BR')]);
                dados.push(['']); // Linha em branco
                dados.push(['']); // Linha em branco
                
                // Cabe√ßalho das colunas
                const colunas = [
                    'Protocolo',
                    'Data In√≠cio',
                    'Data Fim',
                    'Dura√ß√£o (min)',
                    'Munic√≠pio',
                    'Comunidade',
                    'Sistema Produtivo',
                    '√Årea Produtiva',
                    'Atendimento EMATER',
                    'Consentimento',
                    'Latitude',
                    'Longitude',
                    'Precis√£o GPS',
                    'Pr√°ticas Sustent√°veis',
                    'Produtividade',
                    'Renda',
                    'Satisfa√ß√£o Geral',
                    'P√∫blicos Priorit√°rios',
                    'Canais Comercializa√ß√£o',
                    'Sincronizado'
                ];
                dados.push(colunas);
                
                // Adicionar dados de cada formul√°rio
                for (const form of formularios) {
                    const linha = [
                        form.protocolo || '',
                        (form.timestampInicio || form.timestamp_inicio) ? new Date(form.timestampInicio || form.timestamp_inicio).toLocaleString('pt-BR') : '',
                        (form.timestampFim || form.timestamp_fim) ? new Date(form.timestampFim || form.timestamp_fim).toLocaleString('pt-BR') : '',
                        form.duracaoMinutos || form.duracao_minutos || '',
                        form.respostas?.municipio || form.municipio || '',
                        form.respostas?.comunidade_localidade || '',
                        form.respostas?.sistema_produtivo || '',
                        form.respostas?.area_produtiva || '',
                        form.atendimentoEmater || '',
                        form.consentimento || '',
                        form.geolocalizacao?.latitude?.toFixed(6) || '',
                        form.geolocalizacao?.longitude?.toFixed(6) || '',
                        form.geolocalizacao?.precisao ? `¬±${Math.round(form.geolocalizacao.precisao)}m` : '',
                        Array.isArray(form.respostas?.praticas_sustentaveis) ? form.respostas.praticas_sustentaveis.join('; ') : form.respostas?.praticas_sustentaveis || '',
                        form.respostas?.produtividade || '',
                        form.respostas?.renda || '',
                        form.respostas?.satisfacao_geral || '',
                        Array.isArray(form.respostas?.publicos_prioritarios) ? form.respostas.publicos_prioritarios.join('; ') : '',
                        Array.isArray(form.respostas?.canais_comercializacao) ? form.respostas.canais_comercializacao.join('; ') : '',
                        form.sincronizado ? 'Sim' : 'N√£o'
                    ];
                    dados.push(linha);
                }
                
                // Converter para CSV
                const csv = dados.map(row => {
                    return row.map(cell => {
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',');
                }).join('\n');
                
                // Adicionar BOM para UTF-8
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                a.download = `formularios_emater_${timestamp}_${formularios.length}registros.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log(`‚úÖ ${formularios.length} formul√°rios exportados para Excel`);
                alert(`‚úÖ ${formularios.length} formul√°rios exportados com sucesso!\n\nArquivo: formularios_emater_${timestamp}_${formularios.length}registros.csv`);
                
                // Restaurar bot√£o
                event.target.textContent = originalText;
                event.target.disabled = false;
                
            } catch (error) {
                console.error('Erro ao exportar todos para Excel:', error);
                alert('Erro ao exportar formul√°rios. Verifique o console.');
                // Restaurar bot√£o em caso de erro
                if (event && event.target) {
                    event.target.textContent = originalText || 'üì• EXPORTAR TODOS (EXCEL)';
                    event.target.disabled = false;
                }
            }
        }
        
        // Abrir p√°gina de relat√≥rios
        window.abrirRelatorios = function() {
            window.location.href = 'relatorios.html';
        };
        
        // Sincronizar manualmente formul√°rios pendentes
        window.sincronizarManual = async function() {
            const btn = document.getElementById('btn-sync-manual');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Sincronizando...';
            }
            
            try {
                showSyncModal('Sincronizando Pendentes', 'Enviando formul√°rios para o servidor...', 'Preparando envio...');
                updateSyncModal('Processando formul√°rios...', 50);
                
                await sincronizarTodos();
                
                updateSyncModal('Conclu√≠do!', 100);
                
                if (btn) {
                    btn.innerHTML = '‚úÖ Sincronizado!';
                }
                
                setTimeout(() => {
                    hideSyncModal();
                    showToast('success', 'Sincroniza√ß√£o Manual Conclu√≠da', 'Formul√°rios pendentes foram enviados com sucesso!');
                    setTimeout(() => location.reload(), 1500);
                }, 500);
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o manual:', error);
                hideSyncModal();
                showToast('error', 'Erro na Sincroniza√ß√£o', 'N√£o foi poss√≠vel sincronizar. Verifique sua conex√£o e tente novamente.');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '‚ùå Erro - Tentar Novamente';
                }
            }
        }
        
        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalDetalhes');
            if (event.target == modal) {
                fecharModal();
            }
        }
    </script>
</body>
</html>
