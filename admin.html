<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Painel Administrativo - EMATECH v2.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 0;
            overflow: hidden;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 40px 40px 0;
            text-align: center;
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .admin-header p {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: 20px;
        }
        
        /* Tabs System */
        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-top: 30px;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 16px 32px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab-btn:first-child {
            border-top-left-radius: 12px;
        }
        
        .tab-btn:last-child {
            border-top-right-radius: 12px;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .tab-btn.active {
            background: white;
            color: #2e7d32;
            border-bottom-color: #4caf50;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .tab-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
            line-height: 1.3;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .tab-badge-total {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .tab-badge-pending {
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .tab-badge.has-pending {
            background: #f44336;
        }
        
        .tab-btn.active .tab-badge {
            background: rgba(46, 125, 50, 0.2);
            color: #1b5e20;
        }
        
        .tab-btn.active .tab-badge.has-pending {
            background: #ff5722;
            color: white;
        }
        
        .admin-content {
            padding: 40px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            margin: 15px 0 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.95;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }
        
        .stat-sublabel {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .action-section {
            margin-bottom: 40px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .btn-action {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        }
        
        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }
        
        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-action:active {
            transform: translateY(-1px);
        }
        
        .data-table {
            width: 100%;
            background: #f7fafc;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .table-header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 20px 25px;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .table-content {
            max-height: 600px;
            overflow-y: auto;
            background: white;
        }
        
        .table-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .table-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        .table-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .data-row {
            padding: 18px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: 2fr 1.2fr 0.8fr 1.2fr auto;
            gap: 20px;
            align-items: center;
            transition: all 0.2s ease;
            background: white;
        }
        
        .data-row:hover {
            background: #f7fafc;
            box-shadow: inset 0 0 0 2px #667eea;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            box-shadow: 0 2px 4px rgba(34, 84, 61, 0.1);
        }
        
        .badge-warning {
            background: linear-gradient(135deg, #feebc8 0%, #fbd38d 100%);
            color: #744210;
            box-shadow: 0 2px 4px rgba(116, 66, 16, 0.1);
        }
        
        @media (max-width: 1024px) {
            .admin-content {
                padding: 30px 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .data-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .admin-header {
                padding: 30px 20px;
            }
            
            .admin-header h1 {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 2.5rem;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        
        /* Bot√£o de Relat√≥rios em Destaque */
        .btn-relatorios {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-relatorios:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 30px rgba(25, 118, 210, 0.6);
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
        }
        
        .btn-relatorios:active {
            transform: translateY(-1px);
        }
        
        /* Estilos da barra de progresso de sincroniza√ß√£o */
        .sync-progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }
        
        .sync-progress-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
        }
        
        .sync-progress-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .sync-progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .sync-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2e7d32 0%, #4caf50 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .sync-progress-text {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal de Loading para Sincroniza√ß√£o */
        .sync-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .sync-modal-overlay.active {
            display: flex;
        }

        .sync-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.4s ease;
        }

        .sync-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            margin: 0 auto 25px;
            animation: spin 1s linear infinite;
        }

        .sync-modal h2 {
            color: #2d3748;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .sync-modal p {
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .sync-progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .sync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.4s ease;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .sync-status {
            margin-top: 15px;
            color: #4a5568;
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            min-width: 320px;
            animation: slideInRight 0.4s ease;
            border-left: 4px solid #667eea;
        }

        .toast.success {
            border-left-color: #48bb78;
        }

        .toast.error {
            border-left-color: #f56565;
        }

        .toast.info {
            border-left-color: #4299e1;
        }

        .toast.warning {
            border-left-color: #ed8936;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: #718096;
            line-height: 1.5;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #4a5568;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Indicador de sincroniza√ß√£o autom√°tica */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .sync-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .sync-indicator.success {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }
        
        .sync-indicator.error {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .sync-indicator .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Indicador de Sincroniza√ß√£o Autom√°tica -->
    <div id="syncIndicator" class="sync-indicator">
        <div class="spinner"></div>
        <span id="syncText">Sincronizando...</span>
    </div>
    
    <div class="admin-container">
        <header class="admin-header">
            <h1>üìä Painel Administrativo</h1>
            <p>Gerenciamento Completo de Dados - EMATECH v2.0</p>
            
            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="extensionistas" onclick="trocarAba('extensionistas')">
                    üìù Extensionistas
                    <span class="tab-badge" id="badge-extensionistas">
                        <div class="tab-badge-total">0 total</div>
                        <div class="tab-badge-pending">0 pendentes</div>
                    </span>
                </button>
                <button class="tab-btn" data-tab="gerentes" onclick="trocarAba('gerentes')">
                    üëî Gerentes
                    <span class="tab-badge" id="badge-gerentes">
                        <div class="tab-badge-total">0 total</div>
                        <div class="tab-badge-pending">0 pendentes</div>
                    </span>
                </button>
            </div>
        </header>
        
        <div class="admin-content">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">Total de Formul√°rios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèõÔ∏è</div>
                    <div class="stat-value" id="stat-municipios">-</div>
                    <div class="stat-label">Munic√≠pios Visitados</div>
                    <div class="stat-sublabel">de 52 munic√≠pios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìç</div>
                    <div class="stat-value" id="stat-cobertura">-</div>
                    <div class="stat-label">Cobertura</div>
                    <div class="stat-sublabel">% do estado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value" id="stat-7dias">-</div>
                    <div class="stat-label">√öltimos 7 Dias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="stat-tempo">-</div>
                    <div class="stat-label">Tempo M√©dio</div>
                    <div class="stat-sublabel">minutos</div>
                </div>
            </div>
        
            <!-- Bot√£o de Relat√≥rios em Destaque -->
            <div class="action-section" style="text-align: center;">
                <button class="btn-relatorios" onclick="abrirRelatorios()">
                    üìä VER RELAT√ìRIOS E GR√ÅFICOS COMPLETOS
                </button>
            </div>
            
            <!-- A√ß√µes Principais -->
            <div class="action-section">
                <h2 class="section-title">üöÄ A√ß√µes R√°pidas</h2>
                <div class="action-buttons">
                    <button class="btn-action btn-primary" onclick="window.location.href='mapa-cobertura.html'">
                        üó∫Ô∏è Mapa de Cobertura
                    </button>
                    <button class="btn-action btn-primary" onclick="atualizarPagina()">
                        üîÑ Atualizar P√°gina
                    </button>
                    <button class="btn-action btn-primary" onclick="exportarTodosExcel()">
                        üìä Exportar Excel
                    </button>
                    <button class="btn-action btn-secondary" onclick="exportarTodos()">
                        üìÇ Exportar JSON
                    </button>
                    <button class="btn-action btn-secondary" onclick="sincronizarTodos()">
                        üîÑ Sincronizar Tudo
                    </button>
                    <button class="btn-action btn-danger" onclick="limparDadosLocais()">
                        üóëÔ∏è Limpar Dados Locais
                    </button>
                    <button class="btn-action btn-secondary" onclick="voltarFormulario()">
                        ‚Üê Voltar ao Formul√°rio
                    </button>
                </div>
            </div>
        
            <!-- Tabela de Formul√°rios -->
            <div class="data-table">
                <div class="table-header">
                    üìã Formul√°rios Coletados
                </div>
                <div style="padding: 15px 25px; background: #f7fafc; display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 1.2fr auto; gap: 20px; font-weight: 600; color: #4a5568; border-bottom: 2px solid #e2e8f0; font-size: 0.9em;">
                    <div>Protocolo/Munic√≠pio</div>
                    <div>Data/Hora</div>
                    <div>Dura√ß√£o</div>
                    <div>Status</div>
                    <div>A√ß√µes</div>
                </div>
                <div class="table-content" id="tableContent">
                    <p style="padding: 20px; text-align: center; color: #666;">
                        Carregando dados...
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes -->
    <div id="modalDetalhes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Formul√°rio</h2>
                <button class="modal-close" onclick="fecharModal()">√ó</button>
            </div>
            <div id="modalBody">
                <!-- Conte√∫do din√¢mico -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Modal de Sincroniza√ß√£o -->
    <div id="syncModal" class="sync-modal-overlay">
        <div class="sync-modal">
            <div class="sync-spinner"></div>
            <h2 id="syncModalTitle">Sincronizando...</h2>
            <p id="syncModalMessage">Por favor, aguarde enquanto processamos os dados.</p>
            <div class="sync-progress-bar">
                <div id="syncProgressFill" class="sync-progress-fill" style="width: 0%;"></div>
            </div>
            <div id="syncStatus" class="sync-status"></div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="db-extensionistas.js"></script>
    <script>
        // ==================== NAMESPACE ISOLADO ====================
        // Salvar fun√ß√µes de extensionistas antes de carregar gerentes
        console.log('üîç Verificando fun√ß√µes dispon√≠veis de extensionistas...');
        console.log('  - buscarTodosFormularios:', typeof window.buscarTodosFormularios);
        console.log('  - buscarNaoSincronizados:', typeof window.buscarNaoSincronizados);
        
        const ExtensionistasDB = {
            buscarTodos: window.buscarTodosFormularios,
            buscarNaoSincronizados: window.buscarNaoSincronizados,
            buscarPorProtocolo: window.buscarPorProtocolo,
            sincronizar: window.sincronizarFormularioComAzure,
            sincronizarTodosPendentes: window.sincronizarTodosPendentes,
            marcarComoSincronizado: window.marcarComoSincronizado,
            deletar: window.deletarFormulario,
            exportarJSON: window.exportarParaJSON,
            DB_NAME: 'EmatechExtensionistas',
            tipo: 'extensionistas'
        };
        console.log('‚úÖ Namespace ExtensionistasDB criado');
    </script>
    <script src="db-gerentes.js"></script>
    <script>
        // Salvar fun√ß√µes de gerentes ap√≥s carregar
        console.log('üîç Verificando fun√ß√µes dispon√≠veis de gerentes...');
        console.log('  - buscarTodosFormularios:', typeof window.buscarTodosFormularios);
        console.log('  - buscarNaoSincronizados:', typeof window.buscarNaoSincronizados);
        
        const GerentesDB = {
            buscarTodos: window.buscarTodosFormularios,
            buscarNaoSincronizados: window.buscarNaoSincronizados,
            buscarPorProtocolo: window.buscarPorProtocolo,
            sincronizar: window.sincronizarFormularioComAzure,
            sincronizarTodosPendentes: window.sincronizarTodosPendentes,
            marcarComoSincronizado: window.marcarComoSincronizado,
            deletar: window.deletarFormulario,
            exportarJSON: window.exportarParaJSON,
            DB_NAME: 'EmatechGerentes',
            tipo: 'gerentes'
        };
        console.log('‚úÖ Namespace GerentesDB criado');
        
        // Restaurar extensionistas como padr√£o para compatibilidade
        window.buscarTodosFormularios = ExtensionistasDB.buscarTodos;
        window.sincronizarFormularioComAzure = ExtensionistasDB.sincronizar;
        
        // ==================== SISTEMA DE ABAS ====================
        let abaAtiva = 'extensionistas'; // default
        
        function getDBAtivo() {
            return abaAtiva === 'extensionistas' ? ExtensionistasDB : GerentesDB;
        }
        
        async function atualizarBadgesAbas() {
            try {
                const [todosExt, pendentesExt, todosGer, pendentesGer] = await Promise.all([
                    ExtensionistasDB.buscarTodos(),
                    ExtensionistasDB.buscarNaoSincronizados(),
                    GerentesDB.buscarTodos(),
                    GerentesDB.buscarNaoSincronizados()
                ]);
                
                // Badge extensionistas
                const badgeExt = document.getElementById('badge-extensionistas');
                badgeExt.innerHTML = `
                    <div class="tab-badge-total">${todosExt.length} total</div>
                    <div class="tab-badge-pending">${pendentesExt.length} pendente${pendentesExt.length !== 1 ? 's' : ''}</div>
                `;
                if (pendentesExt.length > 0) {
                    badgeExt.classList.add('has-pending');
                } else {
                    badgeExt.classList.remove('has-pending');
                }
                
                // Badge gerentes
                const badgeGer = document.getElementById('badge-gerentes');
                badgeGer.innerHTML = `
                    <div class="tab-badge-total">${todosGer.length} total</div>
                    <div class="tab-badge-pending">${pendentesGer.length} pendente${pendentesGer.length !== 1 ? 's' : ''}</div>
                `;
                if (pendentesGer.length > 0) {
                    badgeGer.classList.add('has-pending');
                } else {
                    badgeGer.classList.remove('has-pending');
                }
                
                console.log(`üìä Badges: Ext=${todosExt.length} total (${pendentesExt.length} pendentes), Ger=${todosGer.length} total (${pendentesGer.length} pendentes)`);
            } catch (error) {
                console.error('‚ö†Ô∏è Erro ao atualizar badges:', error);
                // Em caso de erro, mostrar 0
                document.getElementById('badge-extensionistas').innerHTML = '<div class="tab-badge-total">0 total</div><div class="tab-badge-pending">0 pendentes</div>';
                document.getElementById('badge-gerentes').innerHTML = '<div class="tab-badge-total">0 total</div><div class="tab-badge-pending">0 pendentes</div>';
            }
        }
        
        function trocarAba(aba) {
            abaAtiva = aba;
            
            // Atualizar visual das abas
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-btn[data-tab="${aba}"]`).classList.add('active');
            
            // Recarregar dados
            carregarDadosServidor();
            carregarFormulariosPendentes();
            
            console.log(`üîÑ Aba trocada para: ${aba}`);
        }
        
        // Vari√°vel global para armazenar formul√°rios
        let formulariosGlobal = [];
        
        // ==================== SINCRONIZA√á√ÉO AUTOM√ÅTICA ====================
        
        // Mostrar indicador de sincroniza√ß√£o
        function mostrarIndicadorSync(texto, tipo = 'loading') {
            const indicator = document.getElementById('syncIndicator');
            const textElement = document.getElementById('syncText');
            
            indicator.className = 'sync-indicator show';
            if (tipo === 'success') indicator.classList.add('success');
            if (tipo === 'error') indicator.classList.add('error');
            
            textElement.textContent = texto;
        }
        
        // Esconder indicador de sincroniza√ß√£o
        function esconderIndicadorSync(delay = 3000) {
            setTimeout(() => {
                const indicator = document.getElementById('syncIndicator');
                indicator.classList.remove('show');
            }, delay);
        }
        
        // Verificar e executar sincroniza√ß√£o autom√°tica ao carregar
        async function verificarSincronizacaoAutomatica() {
            try {
                // PASSO 1: Baixar dados do servidor para todos verem os mesmos dados
                console.log('üîÑ [AUTO-SYNC] Passo 1: Baixando dados do Azure...');
                const resultadoDownload = await sincronizarDadosDoServidor();
                
                if (resultadoDownload.success && (resultadoDownload.novos > 0 || resultadoDownload.atualizados > 0)) {
                    console.log(`‚úÖ [AUTO-SYNC] ${resultadoDownload.novos} novos, ${resultadoDownload.atualizados} atualizados`);
                }
                
                // PASSO 2: Enviar pendentes locais para o servidor
                console.log('üîÑ [AUTO-SYNC] Passo 2: Verificando pendentes locais...');
                const pendentes = await buscarNaoSincronizados();
                
                if (pendentes.length > 0) {
                    console.log(`üîÑ [AUTO-SYNC] ${pendentes.length} formul√°rio(s) pendente(s) detectado(s)`);
                    mostrarIndicadorSync(`Sincronizando ${pendentes.length} formul√°rio(s)...`, 'loading');
                    
                    // Chamar fun√ß√£o de sincroniza√ß√£o autom√°tica em background
                    const resultado = await sincronizacaoAutomaticaEmBackground();
                    
                    if (resultado.success && resultado.sincronizados > 0) {
                        mostrarIndicadorSync(`‚úÖ ${resultado.sincronizados} formul√°rio(s) sincronizado(s)!`, 'success');
                        esconderIndicadorSync(4000);
                        
                        // Recarregar dados ap√≥s sincroniza√ß√£o
                        setTimeout(async () => {
                            await carregarDadosServidor();
                            await carregarFormulariosPendentes();
                        }, 1000);
                    } else if (resultado.pendentes > 0) {
                        mostrarIndicadorSync(`‚ö†Ô∏è ${resultado.pendentes} ainda pendente(s)`, 'error');
                        esconderIndicadorSync(5000);
                    } else {
                        esconderIndicadorSync(0);
                    }
                } else {
                    console.log('‚úÖ [AUTO-SYNC] Nenhum formul√°rio pendente');
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Erro na verifica√ß√£o autom√°tica:', error);
            }
        }
        
        // ==================== FUN√á√ïES GLOBAIS (dispon√≠veis para onclick) ====================
        
        // Voltar ao formul√°rio
        window.voltarFormulario = function() {
            window.location.href = 'index.html';
        };
        
        // Atualizar p√°gina com hard refresh (limpa cache)
        window.atualizarPagina = function() {
            console.log('üîÑ Atualizando p√°gina com hard refresh...');
            
            // Adicionar par√¢metro de timestamp para for√ßar bypass do cache
            const url = new URL(window.location.href);
            url.searchParams.set('nocache', Date.now());
            
            // Recarregar com novo URL (for√ßa download de recursos)
            window.location.href = url.toString();
        };
        
        // Vari√°vel para controlar √∫ltimo count
        let ultimoCountFormularios = 0;
        let ultimoCountSincronizados = 0;
        
        // Aguardar carregamento completo de todos os scripts
        async function aguardarScripts() {
            let tentativas = 0;
            while (!window.buscarTodosFormularios && tentativas < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                tentativas++;
            }
            
            if (!window.buscarTodosFormularios) {
                console.error('‚ùå ERRO CR√çTICO: db-extensionistas.js n√£o carregou!');
                document.getElementById('tableContent').innerHTML = `
                    <p style="padding: 40px; text-align: center; color: #d32f2f; font-size: 1.2em;">
                        ‚ö†Ô∏è Erro ao carregar sistema de banco de dados.<br>
                        Por favor, recarregue a p√°gina (F5).
                    </p>
                `;
                return false;
            }
            
            console.log('‚úÖ Scripts carregados com sucesso');
            return true;
        }
        
        // Inicializar painel quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', async function() {
            // Aguardar scripts carregarem
            const scriptsOk = await aguardarScripts();
            if (!scriptsOk) return;
            
            // Executar sincroniza√ß√£o autom√°tica primeiro
            await verificarSincronizacaoAutomatica();
            
            await carregarDadosServidor();
            await carregarFormulariosPendentes();
            
            // Iniciar auto-refresh a cada 3 segundos
            iniciarAutoRefresh();
        });
        
        // Sistema de auto-refresh para detectar mudan√ßas
        function iniciarAutoRefresh() {
            console.log('üîÑ Auto-refresh ativado (verifica a cada 3s - monitora ambas as fontes)');
            
            setInterval(async () => {
                try {
                    // Verificar a aba ativa
                    const db = getDBAtivo();
                    const formularios = await db.buscarTodos();
                    const totalAtual = formularios.length;
                    const sincronizados = formularios.filter(f => f.sincronizado).length;
                    
                    // Se o total mudou, recarregar
                    if (totalAtual !== ultimoCountFormularios) {
                        console.log(`üìä Detectada mudan√ßa (${abaAtiva}): ${ultimoCountFormularios} ‚Üí ${totalAtual} formul√°rios`);
                        ultimoCountFormularios = totalAtual;
                        await carregarDadosServidor();
                        await carregarFormulariosPendentes();
                        showToast('info', 'Dados Atualizados', `Painel ${abaAtiva} atualizado automaticamente.`, 3000);
                    } else if (sincronizados !== ultimoCountSincronizados) {
                        // Verificar se houve mudan√ßa nos sincronizados
                        console.log(`‚úÖ Mudan√ßa em sincronizados (${abaAtiva}): ${ultimoCountSincronizados} ‚Üí ${sincronizados}`);
                        ultimoCountSincronizados = sincronizados;
                        await carregarDadosServidor();
                        await carregarFormulariosPendentes();
                        showToast('success', 'Sincroniza√ß√£o Detectada', 'Formul√°rios sincronizados atualizados!', 3000);
                    }
                    
                    // Atualizar badges sempre (monitora ambas as fontes)
                    await atualizarBadgesAbas();
                } catch (error) {
                    console.error('‚ö†Ô∏è Erro no auto-refresh:', error);
                }
            }, 3000); // Verifica a cada 3 segundos
        }
        
        // Carregar dados do IndexedDB local
        // ==========================================
        // SINCRONIZA√á√ÉO BIDIRECIONAL COM AZURE
        // ==========================================
        
        // Baixar TODOS os dados do Azure e mesclar com locais
        async function sincronizarDadosDoServidor() {
            try {
                console.log('üîÑ [DOWNLOAD] Baixando todos os dados do Azure SQL...');
                mostrarIndicadorSync('Baixando dados do servidor...', 'loading');
                
                // Verificar conex√£o
                if (!navigator.onLine) {
                    console.log('üì¥ [DOWNLOAD] Offline - usando dados locais');
                    esconderIndicadorSync(0);
                    return { success: false, error: 'Offline' };
                }
                
                // Buscar do Azure
                const resultado = await buscarFormulariosDoAzure({ limite: 10000 });
                
                if (!resultado.success || !resultado.formularios) {
                    console.error('‚ùå [DOWNLOAD] Falha ao buscar do Azure:', resultado.error);
                    mostrarIndicadorSync('‚ö†Ô∏è Erro ao baixar dados do servidor', 'error');
                    esconderIndicadorSync(4000);
                    return resultado;
                }
                
                const formulariosServidor = resultado.formularios;
                console.log(`üì• [DOWNLOAD] ${formulariosServidor.length} formul√°rios encontrados no servidor`);
                
                if (formulariosServidor.length === 0) {
                    console.log('‚ÑπÔ∏è [DOWNLOAD] Nenhum formul√°rio no servidor');
                    esconderIndicadorSync(0);
                    return { success: true, novos: 0, atualizados: 0, deletados: 0 };
                }
                
                // Buscar formul√°rios locais
                const formulariosLocais = await buscarTodosFormularios();
                const protocolosLocais = new Set(formulariosLocais.map(f => f.protocolo));
                const protocolosServidor = new Set(formulariosServidor.map(f => f.protocolo));
                
                let novos = 0;
                let atualizados = 0;
                let deletados = 0;
                
                // ====================================================
                // PASSO 1: DETECTAR E DELETAR FORMUL√ÅRIOS OBSOLETOS
                // (Sincroniza√ß√£o Bidirecional - Op√ß√£o 2 Modificada)
                // ====================================================
                console.log('üîç [SYNC] Verificando formul√°rios obsoletos...');
                
                const candidatosExclusao = formulariosLocais.filter(formLocal => {
                    // ‚úÖ PROTE√á√ÉO 1: S√≥ considerar sincronizados
                    const estaSincronizado = formLocal.sincronizado === true;
                    
                    // ‚úÖ PROTE√á√ÉO 2: N√£o est√° mais no servidor
                    const naoEstaNoServidor = !protocolosServidor.has(formLocal.protocolo);
                    
                    // REGRA DE OURO: Deletar SOMENTE se sincronizado E ausente no servidor
                    return estaSincronizado && naoEstaNoServidor;
                });
                
                if (candidatosExclusao.length > 0) {
                    console.log(`üóëÔ∏è [SYNC] ${candidatosExclusao.length} formul√°rio(s) obsoleto(s) detectado(s)`);
                    
                    for (const formObsoleto of candidatosExclusao) {
                        try {
                            const resultadoDelete = await deletarFormularioLocal(formObsoleto.id);
                            
                            if (resultadoDelete.success) {
                                deletados++;
                                console.log(`‚úÖ [SYNC] Deletado: ${formObsoleto.protocolo} (ID: ${formObsoleto.id}) - removido do servidor`);
                            } else {
                                console.warn(`‚ö†Ô∏è [SYNC] N√£o foi poss√≠vel deletar: ${formObsoleto.protocolo} - ${resultadoDelete.error}`);
                            }
                        } catch (error) {
                            console.error(`‚ùå [SYNC] Erro ao deletar ${formObsoleto.protocolo}:`, error);
                        }
                    }
                    
                    console.log(`‚úÖ [SYNC] ${deletados} formul√°rio(s) obsoleto(s) removido(s) do IndexedDB local`);
                } else {
                    console.log('‚úÖ [SYNC] Nenhum formul√°rio obsoleto detectado');
                }
                
                // ====================================================
                // PASSO 2: ADICIONAR/ATUALIZAR FORMUL√ÅRIOS DO SERVIDOR
                // ====================================================
                
                // Abrir transa√ß√£o para inserir/atualizar
                const db = await initDB();
                const transaction = db.transaction(['formularios'], 'readwrite');
                const store = transaction.objectStore('formularios');
                
                // Processar cada formul√°rio do servidor
                for (const formServidor of formulariosServidor) {
                    try {
                        // Marcar como sincronizado (veio do servidor)
                        formServidor.sincronizado = true;
                        formServidor.data_sincronizacao = new Date().toISOString();
                        
                        if (protocolosLocais.has(formServidor.protocolo)) {
                            // J√° existe localmente - atualizar
                            const index = store.index('protocolo');
                            const getRequest = index.get(formServidor.protocolo);
                            
                            await new Promise((resolve, reject) => {
                                getRequest.onsuccess = () => {
                                    const localForm = getRequest.result;
                                    if (localForm) {
                                        // Manter o ID local, atualizar resto
                                        formServidor.id = localForm.id;
                                        const updateRequest = store.put(formServidor);
                                        updateRequest.onsuccess = () => {
                                            atualizados++;
                                            resolve();
                                        };
                                        updateRequest.onerror = reject;
                                    } else {
                                        resolve();
                                    }
                                };
                                getRequest.onerror = reject;
                            });
                        } else {
                            // N√£o existe localmente - inserir novo
                            delete formServidor.id; // Deixar auto-increment criar novo ID
                            await new Promise((resolve, reject) => {
                                const addRequest = store.add(formServidor);
                                addRequest.onsuccess = () => {
                                    novos++;
                                    resolve();
                                };
                                addRequest.onerror = reject;
                            });
                        }
                    } catch (error) {
                        console.error(`‚ö†Ô∏è [DOWNLOAD] Erro ao processar ${formServidor.protocolo}:`, error);
                    }
                }
                
                console.log(`‚úÖ [DOWNLOAD] Conclu√≠do: ${novos} novos, ${atualizados} atualizados, ${deletados} deletados`);
                
                if (novos > 0 || atualizados > 0 || deletados > 0) {
                    let mensagem = '‚úÖ ';
                    if (novos > 0) mensagem += `${novos} novos `;
                    if (atualizados > 0) mensagem += `${atualizados} atualizados `;
                    if (deletados > 0) mensagem += `${deletados} deletados `;
                    mensagem += 'do servidor!';
                    
                    mostrarIndicadorSync(mensagem, 'success');
                    esconderIndicadorSync(5000);
                } else {
                    mostrarIndicadorSync('‚úÖ Dados j√° atualizados', 'success');
                    esconderIndicadorSync(3000);
                }
                
                return { success: true, novos, atualizados, deletados, total: formulariosServidor.length };
            } catch (error) {
                console.error('‚ùå [DOWNLOAD] Erro ao sincronizar do servidor:', error);
                mostrarIndicadorSync('‚ùå Erro ao baixar dados', 'error');
                esconderIndicadorSync(4000);
                return { success: false, error: error.message };
            }
        }
        
        // ==========================================
        // HELPER PARA OBTER RESPOSTAS
        // ==========================================
        
        /**
         * Fun√ß√£o helper para obter respostas parseadas
         * Lida com ambas estruturas:
         * - Dados em f.respostas (vindo do servidor)
         * - Dados diretos no f (salvo localmente)
         */
        function getRespostas(formulario) {
            if (!formulario) return null;
            
            let respostas = formulario.respostas;
            
            // Se respostas for string, fazer parse
            if (typeof respostas === 'string') {
                try {
                    respostas = JSON.parse(respostas);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao parsear respostas:', e);
                    return formulario; // Fallback para raiz
                }
            }
            
            // Se respostas existe (objeto), usar ela
            // Sen√£o, fallback para o pr√≥prio formul√°rio (dados na raiz)
            return respostas || formulario;
        }
        
        // ==========================================
        // CARREGAMENTO DE DADOS
        // ==========================================

        async function carregarDadosServidor() {
            try {
                console.log(`üîÑ Carregando estat√≠sticas do IndexedDB (${abaAtiva})...`);
                
                // Buscar formul√°rios da aba ativa
                const db = getDBAtivo();
                const todosFormularios = await db.buscarTodos();
                
                // Parse de campos JSON (quando vem do servidor)
                todosFormularios.forEach(form => {
                    if (form.respostas && typeof form.respostas === 'string') {
                        try {
                            form.respostas = JSON.parse(form.respostas);
                        } catch (e) {
                            console.warn('Erro ao fazer parse de respostas:', form.protocolo, e);
                        }
                    }
                    if (form.fotos && typeof form.fotos === 'string') {
                        try {
                            form.fotos = JSON.parse(form.fotos);
                        } catch (e) {
                            console.warn('Erro ao fazer parse de fotos:', form.protocolo, e);
                        }
                    }
                });
                
                formulariosGlobal = todosFormularios;
                
                // Atualizar contadores de controle
                ultimoCountFormularios = todosFormularios.length;
                ultimoCountSincronizados = todosFormularios.filter(f => f.sincronizado).length;
                        
                console.log(`‚úÖ ${todosFormularios.length} formul√°rios carregados (${abaAtiva})`);
                console.log(`‚úÖ ${ultimoCountSincronizados} sincronizados, ${todosFormularios.length - ultimoCountSincronizados} pendentes`);
                
                // Atualizar badges das abas
                await atualizarBadgesAbas();
                
                // Calcular KPIs usando getRespostas() para garantir compatibilidade
                const totalFormularios = todosFormularios.length;
                const municipiosUnicos = new Set(
                    todosFormularios
                        .map(f => getRespostas(f)?.municipio)
                        .filter(Boolean)
                );
                const municipiosVisitados = municipiosUnicos.size;
                const coberturaPercentual = Math.round((municipiosVisitados / 52) * 100);
                
                // Formul√°rios dos √∫ltimos 7 dias
                const seteDiasAtras = new Date();
                seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);
                const ultimos7dias = todosFormularios.filter(f => {
                    const dataForm = new Date(f.timestampFim || f.timestamp_fim);
                    return dataForm >= seteDiasAtras;
                }).length;
                
                // Tempo m√©dio
                const formsComDuracao = todosFormularios.filter(f => f.duracaoMinutos || f.duracao_minutos);
                const tempoMedio = formsComDuracao.length > 0
                    ? Math.round(formsComDuracao.reduce((sum, f) => sum + (f.duracaoMinutos || f.duracao_minutos || 0), 0) / formsComDuracao.length)
                    : 0;
                
                // Atualizar KPIs
                document.getElementById('stat-total').textContent = totalFormularios;
                document.getElementById('stat-municipios').textContent = municipiosVisitados;
                document.getElementById('stat-cobertura').textContent = coberturaPercentual + '%';
                document.getElementById('stat-7dias').textContent = ultimos7dias;
                document.getElementById('stat-tempo').textContent = tempoMedio;
                
                // Renderizar √∫ltimos 20 formul√°rios
                const ultimosFormularios = todosFormularios
                    .sort((a, b) => {
                        const dataA = new Date(a.timestampFim || a.timestamp_fim || 0);
                        const dataB = new Date(b.timestampFim || b.timestamp_fim || 0);
                        return dataB - dataA;
                    })
                    .slice(0, 20);
                
                renderizarFormularios(ultimosFormularios);
                
                console.log('‚úÖ Painel atualizado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('tableContent').innerHTML = `
                    <p style="padding: 20px; text-align: center; color: #d32f2f;">
                        ‚ö†Ô∏è Erro ao carregar dados: ${error.message}
                    </p>
                `;
            }
        }
        
        // Carregar estat√≠sticas (DEPRECATED - agora vem do servidor)
        async function carregarEstatisticas() {
            // Mantido para compatibilidade, mas n√£o usado mais
            console.log('‚ö†Ô∏è carregarEstatisticas() deprecated - usando dados do servidor');
        }
        
        // Carregar lista de formul√°rios (DEPRECATED - agora vem do servidor)
        async function carregarFormularios() {
            // Mantido para compatibilidade, mas n√£o usado mais
            console.log('‚ö†Ô∏è carregarFormularios() deprecated - usando dados do servidor');
        }
        
        // Carregar formul√°rios pendentes do IndexedDB
        async function carregarFormulariosPendentes() {
            try {
                console.log('üîÑ Verificando formul√°rios pendentes no IndexedDB...');
                
                // Usar fun√ß√£o do db.js
                const pendentes = await buscarNaoSincronizados();
                
                if (pendentes.length > 0) {
                    console.log(`‚ö†Ô∏è ${pendentes.length} formul√°rio(s) pendente(s) de sincroniza√ß√£o`);
                    
                    // Exibir notifica√ß√£o de pendentes
                    const container = document.getElementById('statsGrid');
                    if (container && !document.getElementById('alert-pendentes')) {
                        const alertDiv = document.createElement('div');
                        alertDiv.id = 'alert-pendentes';
                        alertDiv.style.cssText = `
                            grid-column: 1 / -1;
                            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
                        `;
                        
                        alertDiv.innerHTML = `
                            <div style="font-size: 2.5rem;">‚ö†Ô∏è</div>
                            <div style="flex: 1;">
                                <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 5px;">
                                    ${pendentes.length} Formul√°rio(s) Pendente(s)
                                </div>
                                <div style="font-size: 0.95rem; opacity: 0.95;">
                                    Clique no bot√£o abaixo para sincronizar com o servidor
                                </div>
                            </div>
                            <button id="btn-sync-manual" onclick="sincronizarManual()" style="
                                background: white;
                                color: #f57c00;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 700;
                                font-size: 1rem;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                                transition: transform 0.2s;
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üîÑ Sincronizar Agora
                            </button>
                        `;
                        
                        container.insertBefore(alertDiv, container.firstChild);
                    }
                } else {
                    console.log('‚úÖ Todos os formul√°rios est√£o sincronizados');
                    
                    // Remover alerta se existir
                    const alert = document.getElementById('alert-pendentes');
                    if (alert) {
                        alert.remove();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar pendentes:', error);
            }
        }
        
        // Renderizar formul√°rios na tabela
        function renderizarFormularios(formularios) {
            try {
                const container = document.getElementById('tableContent');
                
                if (!formularios || formularios.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Nenhum formul√°rio encontrado.</p>';
                    return;
                }
                
                console.log(`üìã Renderizando ${formularios.length} √∫ltimos formul√°rios...`);
                container.innerHTML = '';
                
                formularios.forEach(form => {
                    const row = document.createElement('div');
                    row.className = 'data-row';
                    row.style.cursor = 'pointer';
                    row.onclick = function(e) {
                        // N√£o abrir se clicar nos bot√µes
                        if (!e.target.closest('button')) {
                            verDetalhes(form.protocolo);
                        }
                    };
                    
                    // Usar helper getRespostas() para obter dados corretamente
                    const respostas = getRespostas(form);
                    const protocolo = form.protocolo;
                    const municipio = respostas?.municipio || 'N/A';
                    const timestampFim = form.timestampFim || form.timestamp_fim;
                    const duracaoMinutos = form.duracaoMinutos || form.duracao_minutos || 0;
                    const status = form.status || 'N/A';
                    
                    // Formatar data
                    const dataFormatada = timestampFim ? 
                        new Date(timestampFim).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'N/A';
                    
                    // Status baseado apenas na sincroniza√ß√£o
                    const statusCompleto = form.sincronizado ? 'Completo' : 'Pendente';
                    const badgeClass = form.sincronizado ? 'badge-success' : 'badge-warning';
                    
                    row.innerHTML = `
                        <div>
                            <strong>${protocolo || '-'}</strong><br>
                            <small>${municipio}</small>
                        </div>
                        <div>${dataFormatada}</div>
                        <div>${duracaoMinutos}min</div>
                        <div>
                            <span class="badge ${badgeClass}">
                                ${statusCompleto}
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-action btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="verDetalhes('${form.protocolo}')">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            <button class="btn-action btn-primary" style="padding: 6px 12px; font-size: 0.85em; background: #1976d2;" onclick="exportarExcel('${form.protocolo}')" title="Exportar para Excel">
                                üìä Excel
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(row);
                });
                
                console.log('‚úÖ Formul√°rios renderizados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao renderizar formul√°rios:', error);
            }
        }
        
        // Ver detalhes do formul√°rio
        window.verDetalhes = async function(protocolo) {
            try {
                // Buscar formul√°rio no array global
                let form = formulariosGlobal.find(f => f.protocolo === protocolo);
                
                if (!form) {
                    alert('Formul√°rio n√£o encontrado');
                    return;
                }
                
                // Usar helper getRespostas() para obter dados corretamente
                const respostas = getRespostas(form);
                
                const modal = document.getElementById('modalDetalhes');
                const body = document.getElementById('modalBody');
                
                // Extrair dados usando helper
                const municipio = respostas?.municipio || 'N/A';
                const identificador = respostas?.identificador_iniciais || respostas?.nomeCompleto || 'N/A';
                const unidade = respostas?.escritorioLocal || respostas?.unidade_emater || null;
                const timestampFim = form.timestampFim || form.timestamp_fim;
                const duracaoMinutos = form.duracaoMinutos || form.duracao_minutos || 0;
                
                // respostas j√° cont√©m os dados corretos via getRespostas()
                const respostasParaMostrar = respostas;
                
                // Preparar informa√ß√µes de GPS (suporta tanto objeto quanto campos diretos)
                const geo = form.geolocalizacao || form;
                let gpsInfo = '<p><strong>üìç Geolocaliza√ß√£o:</strong> ';
                if (geo && geo.latitude) {
                    const lat = geo.latitude.toFixed(6);
                    const lng = geo.longitude.toFixed(6);
                    const precisao = Math.round(geo.precisao || 0);
                    
                    // Formatar precis√£o
                    let precisaoTexto = '';
                    let qualidadeTexto = '';
                    let corQualidade = '#666';
                    
                    if (precisao >= 1000) {
                        precisaoTexto = `${(precisao / 1000).toFixed(1)}km`;
                    } else {
                        precisaoTexto = `${precisao}m`;
                    }
                    
                    if (precisao < 20) {
                        qualidadeTexto = 'Excelente';
                        corQualidade = '#2e7d32';
                    } else if (precisao < 50) {
                        qualidadeTexto = 'Boa';
                        corQualidade = '#388e3c';
                    } else if (precisao < 100) {
                        qualidadeTexto = 'Moderada';
                        corQualidade = '#f57c00';
                    } else if (precisao < 1000) {
                        qualidadeTexto = 'Baixa';
                        corQualidade = '#e64a19';
                    } else {
                        qualidadeTexto = 'Muito Baixa';
                        corQualidade = '#d32f2f';
                    }
                    
                    gpsInfo += `<br>
                        ‚Ä¢ Latitude: ${lat}<br>
                        ‚Ä¢ Longitude: ${lng}<br>
                        ‚Ä¢ Precis√£o: ¬±${precisaoTexto} <span style="color: ${corQualidade}; font-weight: 600;">(${qualidadeTexto})</span><br>
                        ‚Ä¢ <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color: #1976d2;">üó∫Ô∏è Ver no Google Maps</a>
                    `;
                } else if (geo && geo.erro) {
                    gpsInfo += `<span style="color: #d32f2f;">${geo.erro}</span>`;
                } else {
                    gpsInfo += '<span style="color: #666;">N√£o capturado</span>';
                }
                gpsInfo += '</p>';
                
                // Preparar galeria de fotos
                let fotosGaleria = '';
                if (form.fotos && form.fotos.length > 0) {
                    fotosGaleria = `
                        <p><strong>üì∏ Fotos da Propriedade:</strong> ${form.fotos.length} foto(s)</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${form.fotos.map((foto, index) => `
                                <div style="position: relative; cursor: pointer;" onclick="abrirFotoModal('${form.protocolo}', ${index})">
                                    <img src="${foto.data}" 
                                         alt="${foto.nome}" 
                                         style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 3px; border-radius: 4px; text-align: center;">
                                        ${(foto.tamanho / 1024).toFixed(0)}KB
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                            <em>Clique nas fotos para visualizar em tamanho maior</em>
                        </p>
                    `;
                }
                
                // Formatar respostas de forma leg√≠vel
                const formatarRespostas = (respostas) => {
                    const labels = {
                        municipio: 'Munic√≠pio',
                        escritorioLocal: 'Escrit√≥rio Local',
                        tempoEmater: 'Tempo na EMATER',
                        nomeCompleto: 'Nome Completo',
                        resultadosRelevantes: 'Resultados Relevantes',
                        impacto_aumento_produtividade: 'Impacto - Aumento de Produtividade',
                        impacto_aumento_comercializacao: 'Impacto - Aumento de Comercializa√ß√£o',
                        impacto_inclusao_programas: 'Impacto - Inclus√£o em Programas',
                        impacto_implementacao_tecnologias: 'Impacto - Implementa√ß√£o de Tecnologias',
                        impacto_fortalecimento_organizacoes: 'Impacto - Fortalecimento de Organiza√ß√µes',
                        impacto_capacitacao_produtores: 'Impacto - Capacita√ß√£o de Produtores',
                        impacto_reducao_perdas: 'Impacto - Redu√ß√£o de Perdas',
                        desafio_fatores_externos: 'Desafio - Fatores Externos',
                        desafio_falta_pessoal: 'Desafio - Falta de Pessoal',
                        desafio_falta_veiculos: 'Desafio - Falta de Ve√≠culos',
                        desafio_falta_orcamento: 'Desafio - Falta de Or√ßamento',
                        desafio_baixa_organizacao: 'Desafio - Baixa Organiza√ß√£o',
                        desafio_falta_dados: 'Desafio - Falta de Dados',
                        desafio_resistencia_produtores: 'Desafio - Resist√™ncia dos Produtores',
                        desafio_burocracia: 'Desafio - Burocracia',
                        estrategias: 'Estrat√©gias Utilizadas',
                        estrategiaMaisEfetiva: 'Estrat√©gia Mais Efetiva',
                        criteriosPriorizacao: 'Crit√©rios de Prioriza√ß√£o',
                        documentoFormalCriterios: 'Documento Formal de Crit√©rios',
                        instrumentosPriorizacao: 'Instrumentos de Prioriza√ß√£o',
                        parceriasAtivas: 'Parcerias Ativas',
                        participaForuns: 'Participa de F√≥runs',
                        influenciaEmater: 'Influ√™ncia da EMATER',
                        freqDemandaMercado: 'Frequ√™ncia de Demanda de Mercado',
                        capacitacaoMercado: 'Capacita√ß√£o para Mercado',
                        impactoCapacitacao: 'Impacto da Capacita√ß√£o',
                        instrumentosProducao: 'Instrumentos de Produ√ß√£o',
                        freqApoioMercadosInstitucionais: 'Frequ√™ncia de Apoio a Mercados Institucionais',
                        conhecimentoOfertaDemanda: 'Conhecimento de Oferta/Demanda',
                        indicadoresDesempenho: 'Indicadores de Desempenho',
                        indicadoresFormalizados: 'Indicadores Formalizados',
                        indicadoresEfetividade: 'Indicadores de Efetividade',
                        frequenciaInfluencia: 'Frequ√™ncia de Influ√™ncia',
                        capacidadeAcompanhamento: 'Capacidade de Acompanhamento'
                    };
                    
                    const formatarValor = (chave, valor) => {
                        if (valor === null || valor === undefined || valor === '') return '<em style="color: #999;">N√£o informado</em>';
                        
                        // Arrays
                        if (Array.isArray(valor)) {
                            if (valor.length === 0) return '<em style="color: #999;">Nenhum</em>';
                            return valor.map(v => `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 4px; display: inline-block; margin: 2px;">${v}</span>`).join(' ');
                        }
                        
                        // Escala de 1-5
                        if (chave.includes('impacto_') || chave.includes('desafio_') || chave.includes('influencia') || chave.includes('conhecimento') || chave.includes('capacidade') || chave === 'documentoFormalCriterios') {
                            const num = parseInt(valor);
                            if (!isNaN(num) && num >= 1 && num <= 5) {
                                const cor = num >= 4 ? '#4caf50' : num >= 3 ? '#ff9800' : '#f44336';
                                return `<span style="color: ${cor}; font-weight: bold; font-size: 1.1em;">${'‚òÖ'.repeat(num)}${'‚òÜ'.repeat(5-num)}</span> <span style="color: #666;">(${num}/5)</span>`;
                            }
                        }
                        
                        // Sim/N√£o
                        if (valor === 'sim' || valor === 'nao') {
                            return valor === 'sim' ? '<span style="color: #4caf50; font-weight: bold;">‚úì Sim</span>' : '<span style="color: #f44336;">‚úó N√£o</span>';
                        }
                        
                        // Tempo EMATER
                        if (chave === 'tempoEmater') {
                            const tempos = {
                                'menos5': 'Menos de 5 anos',
                                '5-10': '5 a 10 anos',
                                '10-20': '10 a 20 anos',
                                'mais20': 'Mais de 20 anos'
                            };
                            return tempos[valor] || valor;
                        }
                        
                        // Coment√°rios longos
                        if (chave.includes('comentario') || chave.includes('exemplo') || chave.includes('limitacoes') || chave.includes('Quais')) {
                            return `<div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-top: 4px; font-style: italic;">${valor}</div>`;
                        }
                        
                        return valor;
                    };
                    
                    let html = '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    // Agrupar por categoria
                    const categorias = {
                        'Informa√ß√µes B√°sicas': ['municipio', 'escritorioLocal', 'tempoEmater', 'nomeCompleto'],
                        'Resultados e Impactos': ['resultadosRelevantes', 'impacto_aumento_produtividade', 'impacto_aumento_comercializacao', 'impacto_inclusao_programas', 'impacto_implementacao_tecnologias', 'impacto_fortalecimento_organizacoes', 'impacto_capacitacao_produtores', 'impacto_reducao_perdas'],
                        'Desafios': ['desafio_fatores_externos', 'desafio_falta_pessoal', 'desafio_falta_veiculos', 'desafio_falta_orcamento', 'desafio_baixa_organizacao', 'desafio_falta_dados', 'desafio_resistencia_produtores', 'desafio_burocracia'],
                        'Estrat√©gias e Prioriza√ß√£o': ['estrategias', 'estrategiaMaisEfetiva', 'criteriosPriorizacao', 'documentoFormalCriterios', 'instrumentosPriorizacao', 'exemploInstrumento'],
                        'Parcerias e Participa√ß√£o': ['parceriasAtivas', 'participaForuns', 'influenciaEmater'],
                        'Mercado e Comercializa√ß√£o': ['freqDemandaMercado', 'capacitacaoMercado', 'impactoCapacitacao', 'instrumentosProducao', 'exemploInstrumentosProducao', 'freqApoioMercadosInstitucionais', 'conhecimentoOfertaDemanda'],
                        'Indicadores e Monitoramento': ['indicadoresDesempenho', 'indicadoresFormalizados', 'indicadoresEfetividade', 'indicadoresEfetividadeQuais', 'frequenciaInfluencia', 'capacidadeAcompanhamento', 'limitacoesAcompanhamento'],
                        'Coment√°rios': ['comentarioB', 'comentarioC', 'comentarioD']
                    };
                    
                    for (const [categoria, campos] of Object.entries(categorias)) {
                        const camposPresentes = campos.filter(c => respostas[c] !== undefined);
                        if (camposPresentes.length > 0) {
                            html += `<h5 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 4px; margin: 16px 0 8px 0;">${categoria}</h5>`;
                            html += '<table style="width: 100%; border-collapse: collapse;">';
                            
                            for (const campo of camposPresentes) {
                                const label = labels[campo] || campo;
                                const valor = formatarValor(campo, respostas[campo]);
                                html += `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-weight: 600; color: #555; width: 40%; vertical-align: top;">${label}:</td>
                                        <td style="padding: 8px; color: #333;">${valor}</td>
                                    </tr>
                                `;
                            }
                            
                            html += '</table>';
                        }
                    }
                    
                    html += '</div>';
                    return html;
                };
                
                body.innerHTML = `
                    <h3>Protocolo: ${form.protocolo}</h3>
                    <p><strong>Munic√≠pio:</strong> ${municipio}</p>
                    <p><strong>Produtor:</strong> ${identificador}</p>
                    ${unidade ? `<p><strong>Unidade EMATER:</strong> ${unidade}</p>` : ''}
                    <p><strong>Data/Hora:</strong> ${timestampFim ? new Date(timestampFim).toLocaleString('pt-BR') : 'N/A'}</p>
                    <p><strong>Dura√ß√£o:</strong> ${duracaoMinutos} minutos</p>
                    <p><strong>Status:</strong> ${form.sincronizado ? 'Completo ‚úÖ' : 'Pendente ‚è≥'}</p>
                    ${gpsInfo}
                    ${fotosGaleria}
                    <hr>
                    <h4>Respostas do Formul√°rio:</h4>
                    ${formatarRespostas(respostasParaMostrar)}
                `;
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes do formul√°rio.');
            }
        };
        
        // Abrir foto em modal
        window.abrirFotoModal = async function(protocolo, fotoIndex) {
            try {
                // Buscar formul√°rio no array global
                const form = formulariosGlobal.find(f => f.protocolo === protocolo);
                
                if (!form || !form.fotos || !form.fotos[fotoIndex]) {
                    alert('Foto n√£o encontrada');
                    return;
                }
                
                const foto = form.fotos[fotoIndex];
                
                // Criar modal para foto
                const modalFoto = document.createElement('div');
                modalFoto.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.95);
                    z-index: 11000;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                `;
                
                const dataFoto = new Date(foto.timestamp).toLocaleString('pt-BR');
                
                modalFoto.innerHTML = `
                    <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer;">√ó</div>
                    <img src="${foto.data}" style="max-width: 90%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                    <div style="color: white; margin-top: 20px; text-align: center;">
                        <div style="font-size: 16px; font-weight: 600;">${foto.nome}</div>
                        <div style="font-size: 14px; margin-top: 5px; opacity: 0.8;">
                            ${(foto.tamanho / 1024).toFixed(1)}KB ‚Ä¢ ${dataFoto}
                        </div>
                        <button onclick="baixarFoto('${foto.data}', '${foto.nome}')" 
                                style="margin-top: 15px; padding: 10px 20px; background: #2e7d32; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üì• Baixar Foto
                        </button>
                    </div>
                `;
                
                modalFoto.onclick = () => document.body.removeChild(modalFoto);
                document.body.appendChild(modalFoto);
                
            } catch (error) {
                console.error('Erro ao abrir foto:', error);
            }
        }
        
        // Baixar foto individual
        window.baixarFoto = function(dataUrl, nomeArquivo) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        // Fechar modal
        window.fecharModal = function() {
            document.getElementById('modalDetalhes').style.display = 'none';
        };
        
        // Exportar todos os dados (JSON) - MODIFICADO: buscar do servidor
        window.exportarTodos = async function() {
            try {
                // Usar dados globais em vez de IndexedDB
                const dados = {
                    versao: '2.0',
                    dataExportacao: new Date().toISOString(),
                    totalFormularios: formulariosGlobal.length,
                    fonte: 'MySQL Railway Server',
                    formularios: formulariosGlobal
                };
                
                const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ematech_backup_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`Exporta√ß√£o conclu√≠da! ${dados.totalFormularios} formul√°rios exportados.`);
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('Erro ao exportar dados.');
            }
        };
        
        // ==================== SISTEMA DE MODAL E TOASTS ====================
        
        // Mostrar modal de sincroniza√ß√£o
        function showSyncModal(title, message, status = '') {
            const modal = document.getElementById('syncModal');
            const modalTitle = document.getElementById('syncModalTitle');
            const modalMessage = document.getElementById('syncModalMessage');
            const syncStatus = document.getElementById('syncStatus');
            const progressFill = document.getElementById('syncProgressFill');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            syncStatus.textContent = status;
            progressFill.style.width = '0%';
            modal.classList.add('active');
        }

        // Atualizar progresso do modal
        function updateSyncModal(status, progress) {
            const syncStatus = document.getElementById('syncStatus');
            const progressFill = document.getElementById('syncProgressFill');
            
            syncStatus.textContent = status;
            progressFill.style.width = progress + '%';
        }

        // Fechar modal de sincroniza√ß√£o
        function hideSyncModal() {
            const modal = document.getElementById('syncModal');
            modal.classList.remove('active');
        }

        // Mostrar toast notification
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100px)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        // Sincronizar todos - Recarregar do IndexedDB
        window.sincronizarTodos = async function() {
            try {
                showSyncModal('Sincronizando Dados', 'Atualizando formul√°rios do IndexedDB...', 'Iniciando sincroniza√ß√£o...');
                updateSyncModal('Carregando dados locais...', 30);
                
                await carregarDadosServidor();
                updateSyncModal('Verificando formul√°rios pendentes...', 60);
                
                await carregarFormulariosPendentes();
                updateSyncModal('Sincroniza√ß√£o conclu√≠da!', 100);
                
                setTimeout(() => {
                    hideSyncModal();
                    showToast('success', 'Sincroniza√ß√£o Completa', 'Todos os dados foram atualizados com sucesso!');
                }, 500);
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                hideSyncModal();
                showToast('error', 'Erro na Sincroniza√ß√£o', 'N√£o foi poss√≠vel sincronizar os dados. Tente novamente.');
            }
        };
        
        // Limpar dados locais do IndexedDB (apenas deste dispositivo)
        window.limparDadosLocais = async function() {
            const confirmacao1 = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: Limpar Dados Locais\n\n' +
                'Esta a√ß√£o ir√° APAGAR todos os formul√°rios armazenados LOCALMENTE neste dispositivo.\n\n' +
                '‚ö†Ô∏è Formul√°rios N√ÉO SINCRONIZADOS ser√£o PERDIDOS!\n' +
                '‚úÖ Formul√°rios j√° sincronizados permanecer√£o no servidor.\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmacao1) return;
            
            const confirmacao2 = confirm(
                'üî¥ √öLTIMA CONFIRMA√á√ÉO\n\n' +
                'Voc√™ tem CERTEZA ABSOLUTA que deseja apagar os dados locais?\n\n' +
                'Esta a√ß√£o √© IRREVERS√çVEL!\n\n' +
                'Clique OK para APAGAR ou Cancelar para MANTER os dados.'
            );
            
            if (!confirmacao2) return;
            
            try {
                console.log('üóëÔ∏è Iniciando limpeza do IndexedDB local...');
                
                // Apagar banco de dados local
                const deleteRequest = indexedDB.deleteDatabase('EmaterFormularios');
                
                deleteRequest.onsuccess = function() {
                    console.log('‚úÖ IndexedDB local apagado com sucesso');
                    alert(
                        '‚úÖ Dados locais apagados com sucesso!\n\n' +
                        'O IndexedDB deste dispositivo foi limpo.\n' +
                        'A p√°gina ser√° recarregada.'
                    );
                    setTimeout(() => window.location.reload(), 1000);
                };
                
                deleteRequest.onerror = function(event) {
                    console.error('‚ùå Erro ao apagar IndexedDB:', event);
                    alert('‚ùå Erro ao apagar dados locais. Verifique o console.');
                };
                
                deleteRequest.onblocked = function() {
                    console.warn('‚ö†Ô∏è Opera√ß√£o bloqueada - feche outras abas do site');
                    alert(
                        '‚ö†Ô∏è Opera√ß√£o bloqueada!\n\n' +
                        'Feche todas as outras abas/janelas deste site e tente novamente.'
                    );
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao limpar dados locais:', error);
                alert('‚ùå Erro ao limpar dados locais: ' + error.message);
            }
        }
        
        // Limpar dados antigos - DESABILITADO (requer endpoint PHP espec√≠fico)
        async function limparDados() {
            alert('‚ö†Ô∏è Esta fun√ß√£o requer implementa√ß√£o no servidor MySQL.\n\nPor seguran√ßa, a exclus√£o de dados deve ser feita diretamente no banco de dados ou via ferramenta administrativa.');
        }
        
        // Exportar formul√°rio individual para Excel
        window.exportarExcel = async function(protocolo) {
            try {
                // Buscar formul√°rio no array global
                const form = formulariosGlobal.find(f => f.protocolo === protocolo);
                
                if (!form) {
                    alert('Formul√°rio n√£o encontrado');
                    return;
                }
                
                console.log('üìä Exportando formul√°rio:', form);
                
                // Criar dados estruturados para Excel
                const dados = [];
                
                // Usar helper getRespostas() para acesso correto aos dados
                const respostas = getRespostas(form);
                const municipio = respostas?.municipio || 'N/A';
                const timestampInicio = form.timestampInicio || form.timestamp_inicio;
                const timestampFim = form.timestampFim || form.timestamp_fim;
                const duracaoMinutos = form.duracaoMinutos || form.duracao_minutos || 0;
                
                // Cabe√ßalho do formul√°rio
                dados.push(['FORMUL√ÅRIO DE PESQUISA - EMATER-RO']);
                dados.push(['Protocolo:', form.protocolo]);
                dados.push(['Munic√≠pio:', municipio]);
                dados.push(['Produtor:', respostas?.identificador_iniciais || 'N/A']);
                const unidadeEmater = respostas?.escritorioLocal || respostas?.unidade_emater;
                if (unidadeEmater) {
                    dados.push(['Unidade EMATER:', unidadeEmater]);
                }
                dados.push(['Data In√≠cio:', timestampInicio ? new Date(timestampInicio).toLocaleString('pt-BR') : 'N/A']);
                dados.push(['Data Fim:', timestampFim ? new Date(timestampFim).toLocaleString('pt-BR') : 'N/A']);
                dados.push(['Dura√ß√£o:', `${duracaoMinutos} minutos`]);
                dados.push(['Status:', form.status === 'completo' || form.status === 'concluido' ? 'Completo' : 'Pendente']);
                dados.push(['']); // Linha em branco
                
                // Geolocaliza√ß√£o (se houver)
                if (form.geolocalizacao && form.geolocalizacao.latitude) {
                    dados.push(['GEOLOCALIZA√á√ÉO']);
                    dados.push(['Latitude:', form.geolocalizacao.latitude]);
                    dados.push(['Longitude:', form.geolocalizacao.longitude]);
                    const precisao = Math.round(form.geolocalizacao.precisao);
                    const precisaoTexto = precisao >= 1000 ? `${(precisao/1000).toFixed(1)}km` : `${precisao}m`;
                    dados.push(['Precis√£o:', precisaoTexto]);
                    if (form.geolocalizacao.altitude) {
                        dados.push(['Altitude:', `${Math.round(form.geolocalizacao.altitude)}m`]);
                    }
                    dados.push(['Timestamp GPS:', new Date(form.geolocalizacao.timestamp).toLocaleString('pt-BR')]);
                    dados.push(['Link Google Maps:', `https://www.google.com/maps?q=${form.geolocalizacao.latitude},${form.geolocalizacao.longitude}`]);
                    dados.push(['']); // Linha em branco
                } else if (form.geolocalizacao && form.geolocalizacao.erro) {
                    dados.push(['GEOLOCALIZA√á√ÉO']);
                    dados.push(['Status:', `Erro - ${form.geolocalizacao.erro}`]);
                    dados.push(['']); // Linha em branco
                }
                
                // Informa√ß√µes gerais do formul√°rio
                dados.push(['INFORMA√á√ïES GERAIS']);
                const comunidade = respostas?.comunidade_localidade;
                const sistemaProdutivo = respostas?.sistema_produtivo;
                const areaProdutiva = respostas?.area_produtiva;
                const atendimentoEmater = respostas?.atendimento_emater;
                
                if (comunidade) {
                    dados.push(['Comunidade/Localidade:', comunidade]);
                }
                if (sistemaProdutivo) {
                    dados.push(['Sistema Produtivo:', sistemaProdutivo]);
                }
                if (areaProdutiva) {
                    dados.push(['√Årea Produtiva:', areaProdutiva]);
                }
                if (atendimentoEmater) {
                    dados.push(['Atendimento EMATER:', atendimentoEmater]);
                }
                dados.push(['']); // Linha em branco
                
                // Respostas do question√°rio (JSON completo)
                dados.push(['RESPOSTAS DO QUESTION√ÅRIO']);
                dados.push(['']); // Linha em branco
                
                if (form.respostas && typeof form.respostas === 'object') {
                    // Iterar pelas respostas
                    for (const [chave, valor] of Object.entries(form.respostas)) {
                        if (valor !== null && valor !== undefined && valor !== '') {
                            dados.push([chave + ':', JSON.stringify(valor)]);
                        }
                    }
                } else {
                    dados.push(['Nenhuma resposta registrada']);
                }
                dados.push(['']); // Linha em branco
                
                // Converter para CSV
                const csv = dados.map(row => {
                    return row.map(cell => {
                        // Escapar aspas e envolver em aspas se contiver v√≠rgula
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',');
                }).join('\n');
                
                // Adicionar BOM para UTF-8 (corrige acentua√ß√£o no Excel)
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `formulario_${protocolo}_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Formul√°rio exportado para Excel com todas as respostas');
                
            } catch (error) {
                console.error('Erro ao exportar para Excel:', error);
                alert('Erro ao exportar formul√°rio. Verifique o console.');
            }
        }
        
        // Exportar todos os formul√°rios para Excel em um √∫nico arquivo
        window.exportarTodosExcel = async function() {
            try {
                // Usar dados globais do servidor
                const formularios = formulariosGlobal;
                
                if (formularios.length === 0) {
                    alert('Nenhum formul√°rio para exportar.');
                    return;
                }
                
                // Mostrar mensagem de progresso
                const originalText = event.target.textContent;
                event.target.textContent = `‚è≥ Exportando ${formularios.length} formul√°rios...`;
                event.target.disabled = true;
                
                console.log(`üìä Exportando ${formularios.length} formul√°rios para Excel...`);
                
                // Criar array de dados
                const dados = [];
                
                // Cabe√ßalho do arquivo
                dados.push(['FORMUL√ÅRIOS DE PESQUISA - EMATER-RO']);
                dados.push(['Total de Formul√°rios:', formularios.length]);
                dados.push(['Data Exporta√ß√£o:', new Date().toLocaleString('pt-BR')]);
                dados.push(['']); // Linha em branco
                dados.push(['']); // Linha em branco
                
                // Cabe√ßalho das colunas
                const colunas = [
                    'Protocolo',
                    'Data In√≠cio',
                    'Data Fim',
                    'Dura√ß√£o (min)',
                    'Munic√≠pio',
                    'Comunidade',
                    'Sistema Produtivo',
                    '√Årea Produtiva',
                    'Atendimento EMATER',
                    'Consentimento',
                    'Latitude',
                    'Longitude',
                    'Precis√£o GPS',
                    'Pr√°ticas Sustent√°veis',
                    'Produtividade',
                    'Renda',
                    'Satisfa√ß√£o Geral',
                    'P√∫blicos Priorit√°rios',
                    'Canais Comercializa√ß√£o',
                    'Sincronizado'
                ];
                dados.push(colunas);
                
                // Adicionar dados de cada formul√°rio
                for (const form of formularios) {
                    // Usar helper getRespostas() para acesso correto
                    const respostas = getRespostas(form);
                    
                    const linha = [
                        form.protocolo || '',
                        (form.timestampInicio || form.timestamp_inicio) ? new Date(form.timestampInicio || form.timestamp_inicio).toLocaleString('pt-BR') : '',
                        (form.timestampFim || form.timestamp_fim) ? new Date(form.timestampFim || form.timestamp_fim).toLocaleString('pt-BR') : '',
                        form.duracaoMinutos || form.duracao_minutos || '',
                        respostas?.municipio || '',
                        respostas?.comunidade_localidade || '',
                        respostas?.sistema_produtivo || '',
                        respostas?.area_produtiva || '',
                        respostas?.atendimento_emater || '',
                        respostas?.consentimento || '',
                        form.geolocalizacao?.latitude?.toFixed(6) || '',
                        form.geolocalizacao?.longitude?.toFixed(6) || '',
                        form.geolocalizacao?.precisao ? `¬±${Math.round(form.geolocalizacao.precisao)}m` : '',
                        Array.isArray(respostas?.praticas_sustentaveis) ? respostas.praticas_sustentaveis.join('; ') : respostas?.praticas_sustentaveis || '',
                        respostas?.produtividade || '',
                        respostas?.renda || '',
                        respostas?.satisfacao_geral || '',
                        Array.isArray(respostas?.publicos_prioritarios) ? respostas.publicos_prioritarios.join('; ') : '',
                        Array.isArray(respostas?.canais_comercializacao) ? respostas.canais_comercializacao.join('; ') : '',
                        form.sincronizado ? 'Sim' : 'N√£o'
                    ];
                    dados.push(linha);
                }
                
                // Converter para CSV
                const csv = dados.map(row => {
                    return row.map(cell => {
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',');
                }).join('\n');
                
                // Adicionar BOM para UTF-8
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                a.download = `formularios_emater_${timestamp}_${formularios.length}registros.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log(`‚úÖ ${formularios.length} formul√°rios exportados para Excel`);
                alert(`‚úÖ ${formularios.length} formul√°rios exportados com sucesso!\n\nArquivo: formularios_emater_${timestamp}_${formularios.length}registros.csv`);
                
                // Restaurar bot√£o
                event.target.textContent = originalText;
                event.target.disabled = false;
                
            } catch (error) {
                console.error('Erro ao exportar todos para Excel:', error);
                alert('Erro ao exportar formul√°rios. Verifique o console.');
                // Restaurar bot√£o em caso de erro
                if (event && event.target) {
                    event.target.textContent = originalText || 'üì• EXPORTAR TODOS (EXCEL)';
                    event.target.disabled = false;
                }
            }
        }
        
        // Abrir p√°gina de relat√≥rios
        window.abrirRelatorios = function() {
            window.location.href = 'relatorios.html';
        };
        
        // Sincronizar manualmente formul√°rios pendentes
        // Sincronizar manualmente formul√°rios pendentes
        window.sincronizarManual = async function() {
            const btn = document.getElementById('btn-sync-manual');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Sincronizando...';
            }
            
            try {
                console.log('üîÑ Iniciando sincroniza√ß√£o manual...');
                
                showSyncModal('Sincronizando Pendentes', 'Enviando formul√°rios para o servidor...', 'Preparando envio...');
                updateSyncModal('Buscando formul√°rios pendentes...', 20);
                
                // Buscar formul√°rios pendentes
                const pendentes = await buscarNaoSincronizados();
                console.log(`üì§ Encontrados ${pendentes.length} formul√°rio(s) pendente(s)`);
                
                if (pendentes.length === 0) {
                    hideSyncModal();
                    showToast('info', 'Nenhum Pendente', 'Todos os formul√°rios j√° est√£o sincronizados!');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '‚úÖ Tudo Sincronizado';
                    }
                    return;
                }
                
                updateSyncModal(`Sincronizando ${pendentes.length} formul√°rio(s)...`, 40);
                
                // Sincronizar cada formul√°rio
                let sucessos = 0;
                let erros = 0;
                
                for (let i = 0; i < pendentes.length; i++) {
                    const form = pendentes[i];
                    console.log(`üì§ Sincronizando ${i + 1}/${pendentes.length}: ${form.protocolo}`);
                    
                    const progresso = 40 + ((i + 1) / pendentes.length) * 50;
                    updateSyncModal(`Sincronizando ${i + 1}/${pendentes.length}...`, progresso);
                    
                    const resultado = await sincronizarFormularioComAzure(form);
                    
                    if (resultado.success) {
                        sucessos++;
                        console.log(`‚úÖ Sincronizado: ${form.protocolo}`);
                    } else {
                        erros++;
                        console.error(`‚ùå Falha: ${form.protocolo} - ${resultado.error}`);
                    }
                }
                
                updateSyncModal('Conclu√≠do!', 100);
                
                console.log(`üìä Resultado: ${sucessos} sucesso(s), ${erros} erro(s)`);
                
                if (btn) {
                    btn.innerHTML = '‚úÖ Sincronizado!';
                }
                
                setTimeout(() => {
                    hideSyncModal();
                    
                    if (erros > 0) {
                        showToast('warning', 'Sincroniza√ß√£o Parcial', `${sucessos} sincronizado(s), ${erros} com erro. Verifique os logs.`);
                    } else {
                        showToast('success', 'Sincroniza√ß√£o Completa', `${sucessos} formul√°rio(s) sincronizado(s) com sucesso!`);
                    }
                    
                    // Recarregar dados
                    setTimeout(async () => {
                        await carregarDadosServidor();
                        await carregarFormulariosPendentes();
                    }, 500);
                }, 500);
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o manual:', error);
                hideSyncModal();
                showToast('error', 'Erro na Sincroniza√ß√£o', `N√£o foi poss√≠vel sincronizar: ${error.message}`);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '‚ùå Erro - Tentar Novamente';
                }
            }
        }
        
        // Fun√ß√£o de debug para inspecionar formul√°rio problem√°tico
        window.debugFormulario = async function(protocolo) {
            try {
                // Garantir que o DB est√° inicializado
                if (!db) {
                    await initDB();
                }
                
                const tx = db.transaction('formularios', 'readonly');
                const store = tx.objectStore('formularios');
                const index = store.index('protocolo');
                const formulario = await new Promise((resolve, reject) => {
                    const request = index.get(protocolo);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                if (!formulario) {
                    console.error('‚ùå Formul√°rio n√£o encontrado:', protocolo);
                    return;
                }
                
                console.log('üêõ DEBUG - Formul√°rio Completo:', protocolo);
                console.log('üìã Estrutura:', JSON.stringify(formulario, null, 2));
                console.log('üîç Campos Eixo C:', {
                    parcerias_ativas: formulario.parcerias_ativas,
                    parceriasAtivas: formulario.parceriasAtivas,
                    parcerias_ativas_outro: formulario.parcerias_ativas_outro,
                    parceriasAtivasOutro: formulario.parceriasAtivasOutro,
                    participa_foruns: formulario.participa_foruns,
                    participaForuns: formulario.participaForuns,
                    influencia_emater: formulario.influencia_emater,
                    influenciaEmater: formulario.influenciaEmater,
                    comentario_eixo_c: formulario.comentario_eixo_c,
                    comentarioC: formulario.comentarioC
                });
                console.log('üîç Campos Eixo D:', {
                    freq_demanda_mercado: formulario.freq_demanda_mercado,
                    freqDemandaMercado: formulario.freqDemandaMercado,
                    capacitacao_mercado: formulario.capacitacao_mercado,
                    capacitacaoMercado: formulario.capacitacaoMercado,
                    impacto_capacitacao: formulario.impacto_capacitacao,
                    impactoCapacitacao: formulario.impactoCapacitacao,
                    instrumentos_producao: formulario.instrumentos_producao,
                    instrumentosProducao: formulario.instrumentosProducao,
                    exemplo_instrumentos_producao: formulario.exemplo_instrumentos_producao,
                    exemploInstrumentosProducao: formulario.exemploInstrumentosProducao,
                    freq_apoio_mercados_institucionais: formulario.freq_apoio_mercados_institucionais,
                    freqApoioMercadosInstitucionais: formulario.freqApoioMercadosInstitucionais,
                    conhecimento_oferta_demanda: formulario.conhecimento_oferta_demanda,
                    conhecimentoOfertaDemanda: formulario.conhecimentoOfertaDemanda,
                    comentario_eixo_d: formulario.comentario_eixo_d,
                    comentarioD: formulario.comentarioD
                });
                
                return formulario;
            } catch (error) {
                console.error('‚ùå Erro ao inspecionar formul√°rio:', error);
            }
        };
        
        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalDetalhes');
            if (event.target == modal) {
                fecharModal();
            }
        }

        // ==================================================
        // MODAL DE ERRO DETALHADO
        // ==================================================
        
        function mostrarErroDetalhado(error, protocolo = 'N/A') {
            const codigo = 'ERR-' + Date.now().toString().slice(-8);
            const timestamp = new Date().toLocaleString('pt-BR');
            const errorMsg = error.message || String(error);
            
            // Salvar no LocalStorage
            try {
                localStorage.setItem('ultimo_erro_sync', JSON.stringify({
                    codigo,
                    protocolo,
                    erro: errorMsg,
                    timestamp
                }));
            } catch (e) {
                console.error('Erro ao salvar no LocalStorage:', e);
            }
            
            // Criar modal
            const modalHTML = `
                <div id="modalErroSync" style="
                    display: flex;
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.6);
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease;
                ">
                    <div style="
                        background: white;
                        border-radius: 16px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        animation: slideDown 0.3s ease;
                    ">
                        <!-- Cabe√ßalho -->
                        <div style="
                            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
                            color: white;
                            padding: 24px;
                            border-radius: 16px 16px 0 0;
                        ">
                            <div style="font-size: 48px; text-align: center; margin-bottom: 12px;">‚ö†Ô∏è</div>
                            <h2 style="margin: 0; text-align: center; font-size: 1.5rem;">Erro na Sincroniza√ß√£o</h2>
                        </div>
                        
                        <!-- C√≥digo do Erro -->
                        <div style="padding: 24px; background: #fff3e0; border-left: 4px solid #f57c00;">
                            <div style="color: #e65100; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px;">
                                C√ìDIGO DO ERRO
                            </div>
                            <div id="codigoErro" style="
                                font-family: 'Courier New', monospace;
                                font-size: 1.5rem;
                                font-weight: bold;
                                color: #d84315;
                                letter-spacing: 1px;
                                user-select: all;
                            ">${codigo}</div>
                        </div>
                        
                        <!-- Detalhes -->
                        <div style="padding: 24px;">
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Protocolo:</div>
                                <div style="font-weight: 600; color: #333;">${protocolo}</div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Tipo de Erro:</div>
                                <div style="font-weight: 600; color: #333;">${errorMsg}</div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Data/Hora:</div>
                                <div style="font-weight: 600; color: #333;">${timestamp}</div>
                            </div>
                        </div>
                        
                        <!-- Instru√ß√µes -->
                        <div style="
                            margin: 0 24px 24px;
                            padding: 20px;
                            background: #e3f2fd;
                            border-radius: 12px;
                            border-left: 4px solid #1976d2;
                        ">
                            <div style="font-weight: 600; color: #0d47a1; margin-bottom: 12px; font-size: 1rem;">
                                üìã O que fazer agora?
                            </div>
                            <ol style="margin: 0; padding-left: 20px; color: #1565c0; line-height: 1.8;">
                                <li>Clique no bot√£o <strong>"Copiar C√≥digo"</strong> abaixo</li>
                                <li>Envie o c√≥digo copiado por <strong>WhatsApp</strong> para o suporte</li>
                                <li>Aguarde orienta√ß√£o da equipe t√©cnica</li>
                                <li>Seus dados est√£o <strong>salvos localmente e seguros</strong></li>
                            </ol>
                        </div>
                        
                        <!-- Bot√µes -->
                        <div style="padding: 0 24px 24px; display: flex; gap: 12px;">
                            <button onclick="copiarCodigoErro()" style="
                                flex: 1;
                                background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
                                color: white;
                                border: none;
                                padding: 14px 24px;
                                border-radius: 8px;
                                font-size: 1rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(46, 125, 50, 0.4)';"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(46, 125, 50, 0.3)';">
                                üìã Copiar C√≥digo
                            </button>
                            <button onclick="fecharModalErro()" style="
                                flex: 1;
                                background: #757575;
                                color: white;
                                border: none;
                                padding: 14px 24px;
                                border-radius: 8px;
                                font-size: 1rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='#616161';"
                               onmouseout="this.style.background='#757575';">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideDown {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;
            
            // Inserir no DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
        }
        
        function copiarCodigoErro() {
            const ultimoErro = JSON.parse(localStorage.getItem('ultimo_erro_sync') || '{}');
            const texto = `üö® ERRO DE SINCRONIZA√á√ÉO EMATECH

üìå C√≥digo: ${ultimoErro.codigo}
üìã Protocolo: ${ultimoErro.protocolo}
‚ùå Erro: ${ultimoErro.erro}
üïê Data/Hora: ${ultimoErro.timestamp}

Por favor, me ajude a resolver este problema.`;
            
            navigator.clipboard.writeText(texto).then(() => {
                // Toast de sucesso
                const toast = document.createElement('div');
                toast.innerHTML = `
                    <div style="
                        position: fixed;
                        bottom: 24px;
                        right: 24px;
                        background: #4caf50;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 10001;
                        font-weight: 600;
                        animation: slideUp 0.3s ease;
                    ">
                        ‚úÖ C√≥digo copiado! Cole no WhatsApp.
                    </div>
                    <style>
                        @keyframes slideUp {
                            from { transform: translateY(100px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                    </style>
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }).catch(() => {
                alert('Erro ao copiar. C√≥digo: ' + ultimoErro.codigo);
            });
        }
        
        function fecharModalErro() {
            const modal = document.getElementById('modalErroSync');
            if (modal) modal.parentElement.remove();
        }
        
        // Expor globalmente
        window.mostrarErroDetalhado = mostrarErroDetalhado;
    </script>
</body>
</html>
