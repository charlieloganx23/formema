<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa EMATER-RO - Unidades de Rond√¥nia (Coordenadas Corrigidas)</title>
    <!-- v1.4.1 - Cache-bust: Bot√µes de a√ß√£o adicionados -->
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            height: calc(100vh - 200px);
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #e0e0e0;
        }

        .sidebar h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #2a5298;
            padding-bottom: 10px;
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stats h3 {
            color: #2a5298;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            color: #1e3c72;
            font-weight: bold;
        }

        .territorio-list {
            margin-top: 20px;
        }

        .territorio-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #ccc;
            position: relative;
        }

        .territorio-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .territorio-info-icon {
            background: #2a5298;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }

        .territorio-info-icon:hover {
            background: #1e3c72;
            transform: scale(1.1);
        }

        .territorio-tooltip {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            min-width: 300px;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 3px solid #2a5298;
        }

        .territorio-tooltip.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .territorio-tooltip-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .territorio-tooltip-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .territorio-tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5298;
        }

        .territorio-tooltip h4 {
            color: #1e3c72;
            margin: 0;
            font-size: 1.1em;
        }

        .territorio-tooltip-close {
            background: #e74c3c;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .territorio-tooltip-close:hover {
            background: #c0392b;
            transform: rotate(90deg);
        }

        .territorio-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .territorio-tooltip li {
            padding: 8px 0;
            color: #555;
            font-size: 0.9em;
            border-bottom: 1px solid #e0e0e0;
        }

        .territorio-tooltip li:last-child {
            border-bottom: none;
        }

        .territorio-tooltip li:before {
            margin-right: 8px;
        }

        .territorio-tooltip::-webkit-scrollbar {
            width: 6px;
        }

        .territorio-tooltip::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .territorio-tooltip::-webkit-scrollbar-thumb {
            background: #2a5298;
            border-radius: 10px;
        }

        .territorio-item.active {
            border-left-width: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .territorio-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .territorio-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .territorio-name {
            font-weight: bold;
            color: #1e3c72;
            font-size: 0.95em;
            flex: 1;
        }

        .territorio-count {
            background: #2a5298;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            color: #1e3c72;
            font-size: 1.1em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .legend-icon {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        /* Popups */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .popup-content {
            padding: 10px;
            min-width: 250px;
        }

        .popup-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 10px;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 5px;
        }

        .popup-info {
            margin: 5px 0;
            color: #555;
        }

        .popup-label {
            font-weight: bold;
            color: #2a5298;
        }

        .filter-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-section h3 {
            color: #2a5298;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #2a5298;
            border-radius: 20px;
            font-size: 0.9em;
            outline: none;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .search-input:focus {
            border-color: #1e3c72;
            box-shadow: 0 0 8px rgba(42, 82, 152, 0.3);
        }

        .search-input::placeholder {
            color: #999;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 15px;
            border: 2px solid #2a5298;
            background: white;
            color: #2a5298;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #2a5298;
            color: white;
        }

        .filter-btn.active {
            background: #2a5298;
            color: white;
        }

        /* Bot√£o de Reset do Zoom */
        .reset-zoom-btn {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 12px 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #2a5298;
            font-size: 0.9em;
        }

        .reset-zoom-btn:hover {
            background: #2a5298;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .reset-zoom-btn:active {
            transform: translateY(0);
        }

        .reset-zoom-icon {
            font-size: 1.2em;
        }

        /* Bot√µes de a√ß√£o minimalistas */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #f5f5f5;
            border-color: #999;
            color: #333;
            transform: translateY(-1px);
        }

        /* Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #2a5298;
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #1e3c72;
        }

        /* Pol√≠gonos dos munic√≠pios */
        .municipio-polygon {
            stroke: #555;
            stroke-width: 1;
            fill-opacity: 0.70;
        }

        .municipio-polygon-hover {
            stroke-width: 2.5;
            fill-opacity: 0.85;
        }

        /* Estilos para status de cobertura */
        .unidade-visitada {
            filter: hue-rotate(90deg) brightness(1.2);
        }

        .unidade-nao-visitada {
            filter: grayscale(100%) opacity(0.5);
        }

        .badge-visitas {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .stat-value.green {
            color: #27ae60;
        }

        .stat-value.red {
            color: #e74c3c;
        }

        .stat-value.orange {
            color: #f39c12;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                max-height: 300px;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }

            .territorio-tooltip {
                max-width: 90vw;
                max-height: 80vh;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 0.9em;
            }

            body {
                padding: 10px;
            }

            .content {
                height: calc(100vh - 150px);
            }

            .reset-zoom-btn {
                top: 10px;
                right: 10px;
                padding: 10px 14px;
                font-size: 0.85em;
            }

            .reset-zoom-btn span:not(.reset-zoom-icon) {
                display: none;
            }

            .reset-zoom-icon {
                font-size: 1.4em;
            }
        }

        /* Estilo para tooltips dos pol√≠gonos municipais */
        .municipio-tooltip-geojson {
            background: rgba(0, 0, 0, 0.85) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 8px 14px !important;
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4) !important;
            letter-spacing: 0.3px !important;
        }

        .municipio-tooltip-geojson::before {
            border-top-color: rgba(0, 0, 0, 0.85) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="window.location.href='admin.html'" style="background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚Üê Painel Admin
                </button>
                <div style="flex: 1; text-align: center;">
                    <h1 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <img src="logo-ematech1.png" alt="Logo EMATECH" style="height: 40px; width: auto; object-fit: contain;">
                        Mapa de Cobertura EMATER-RO
                    </h1>
                    <p style="margin: 5px 0 0 0;">Monitoramento de Visitas e Formul√°rios Preenchidos por Unidade</p>
                </div>
                <div class="action-buttons">
                    <button class="action-btn" onclick="limparCache()">üóëÔ∏è Limpar Cache</button>
                    <button class="action-btn" onclick="atualizarMapa()">üîÑ Atualizar</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="sidebar">
                <h2>üìä Informa√ß√µes</h2>
                
                <div class="stats">
                    <h3>Estat√≠sticas Gerais</h3>
                    <div class="stat-item">
                        <span class="stat-label">Total de Unidades:</span>
                        <span class="stat-value" id="total-unidades">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Territ√≥rios:</span>
                        <span class="stat-value" id="total-territorios">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Munic√≠pios (IBGE):</span>
                        <span class="stat-value" id="total-municipios">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Munic√≠pios + Distritos:</span>
                        <span class="stat-value" id="total-localidades">-</span>
                    </div>

                </div>

                <div class="filter-section">
                    <h3>üîç Buscar Unidade</h3>
                    <input type="text" class="search-input" id="search-input" placeholder="Digite o nome da unidade, munic√≠pio ou distrito...">
                </div>

                <div class="filter-section">
                    <h3>üìã Filtrar por Tipo</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-tipo="todos">Todos</button>
                        <button class="filter-btn" data-tipo="ESREG">ESREG</button>
                        <button class="filter-btn" data-tipo="ESLOC">ESLOC</button>
                        <button class="filter-btn" data-tipo="Centro Gerencial">Centro Gerencial</button>
                        <button class="filter-btn" data-tipo="Centro de Treinamento">Centro de Treinamento</button>
                    </div>
                </div>

                <div class="filter-section">
                    <h3>üìç Filtrar por Cobertura</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn" id="filter-municipios-visitados" onclick="destacarMunicipiosVisitados()">
                            ‚úÖ Munic√≠pios Visitados
                        </button>
                        <button class="filter-btn" id="filter-limpar-destaque" onclick="limparDestaqueMunicipios()" style="display: none;">
                            üîÑ Mostrar Todos
                        </button>
                    </div>
                </div>

                <h2>üèõÔ∏è Unidades Emater por Territ√≥rios</h2>
                <div class="territorio-list" id="territorio-list">
                    <div class="loading">Carregando...</div>
                </div>
            </div>

            <div id="map">
                <button class="reset-zoom-btn" id="reset-zoom-btn" title="Voltar para vis√£o completa de Rond√¥nia">
                    <span class="reset-zoom-icon">üîÑ</span>
                    <span>Resetar Zoom</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay para tooltip -->
    <div class="territorio-tooltip-overlay" id="tooltip-overlay"></div>
    
    <!-- Container para tooltips (fora dos cards) -->
    <div id="tooltips-container"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- IndexedDB -->
    <script src="db-extensionistas.js"></script>
    
    <script>
        // Dados EMATER-RO com coordenadas corrigidas
        const ematerData = {
            "estado": "Rond√¥nia",
            "codigo_uf": 11,
            "sigla": "RO",
            "total_unidades": 83,
            "fonte": "EMATER-RO 2017 (Coordenadas: IBGE 2023)",
            "territorios": [
                {
                    "id": 1,
                    "nome": "Territ√≥rio Rural da Cidadania Madeira Mamor√©",
                    "cor": "#F5E6A8",
                    "unidades": [
                        {
                            "id": 1,
                            "tipo": "Centro Gerencial",
                            "nome": "Centro Gerencial",
                            "municipio": "Porto Velho",
                            "latitude": -8.761944,
                            "longitude": -63.903889,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 2,
                            "tipo": "ESREG",
                            "nome": "Esreg de Porto Velho",
                            "municipio": "Porto Velho",
                            "latitude": -8.761944,
                            "longitude": -63.903889,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 3,
                            "tipo": "ESLOC",
                            "nome": "Porto Velho",
                            "municipio": "Porto Velho",
                            "latitude": -8.761944,
                            "longitude": -63.903889,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 4,
                            "tipo": "ESLOC",
                            "nome": "Porto Verde",
                            "municipio": "Porto Velho",
                            "distrito": "Porto Verde",
                            "latitude": -9.850000,
                            "longitude": -64.450000,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 5,
                            "tipo": "ESLOC",
                            "nome": "Jaci-Paran√°",
                            "municipio": "Porto Velho",
                            "distrito": "Jaci-Paran√°",
                            "latitude": -9.256944,
                            "longitude": -64.395000,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 6,
                            "tipo": "ESLOC",
                            "nome": "Vista Alegre do Abun√£",
                            "municipio": "Porto Velho",
                            "distrito": "Vista Alegre do Abun√£",
                            "latitude": -9.656436,
                            "longitude": -65.736261,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 7,
                            "tipo": "ESLOC",
                            "nome": "Rio Pardo",
                            "municipio": "Porto Velho",
                            "distrito": "Rio Pardo",
                            "latitude": -9.630981,
                            "longitude": -63.966378,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 8,
                            "tipo": "ESLOC",
                            "nome": "Uni√£o Bandeirantes",
                            "municipio": "Porto Velho",
                            "distrito": "Uni√£o Bandeirantes",
                            "latitude": -9.705922,
                            "longitude": -64.529519,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 9,
                            "tipo": "ESLOC",
                            "nome": "Nova Mamor√©",
                            "municipio": "Nova Mamor√©",
                            "latitude": -10.401940,
                            "longitude": -65.326670,
                            "codigo_ibge": 1100338,
                            "ddd": 69
                        },
                        {
                            "id": 10,
                            "tipo": "ESLOC",
                            "nome": "Nova Dimens√£o",
                            "municipio": "Nova Mamor√©",
                            "latitude": -10.371060,
                            "longitude": -64.80771,
                            "codigo_ibge": 1100338,
                            "ddd": 69
                        },
                        {
                            "id": 11,
                            "tipo": "ESLOC",
                            "nome": "Extrema",
                            "municipio": "Porto Velho",
                            "distrito": "Extrema de Rond√¥nia",
                            "latitude": -9.773314,
                            "longitude": -66.358258,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 12,
                            "tipo": "ESLOC",
                            "nome": "Nova Calif√≥rnia",
                            "municipio": "Porto Velho",
                            "distrito": "Nova Calif√≥rnia",
                            "latitude": -9.754119,
                            "longitude": -66.613106,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        },
                        {
                            "id": 13,
                            "tipo": "ESLOC",
                            "nome": "Guajar√°-Mirim",
                            "municipio": "Guajar√°-Mirim",
                            "latitude": -10.790900,
                            "longitude": -65.332200,
                            "codigo_ibge": 1100106,
                            "ddd": 69
                        },
                        {
                            "id": 14,
                            "tipo": "ESLOC",
                            "nome": "Candeias do Jamari",
                            "municipio": "Candeias do Jamari",
                            "latitude": -8.809720,
                            "longitude": -63.695600,
                            "codigo_ibge": 1100809,
                            "ddd": 69
                        },
                        {
                            "id": 15,
                            "tipo": "ESLOC",
                            "nome": "Itapu√£ do Oeste",
                            "municipio": "Itapu√£ do Oeste",
                            "latitude": -9.202220,
                            "longitude": -63.180000,
                            "codigo_ibge": 1101104,
                            "ddd": 69
                        },
                        {
                            "id": 16,
                            "tipo": "ESLOC",
                            "nome": "Triunfo",
                            "municipio": "Candeias do Jamari",
                            "distrito": "Triunfo",
                            "latitude": -9.280720,
                            "longitude": -63.46876,
                            "codigo_ibge": 1100809,
                            "ddd": 69
                        },
                        {
                            "id": 17,
                            "tipo": "ESLOC",
                            "nome": "Calama",
                            "municipio": "Porto Velho",
                            "distrito": "Calama",
                            "latitude": -8.028425,
                            "longitude": -62.875158,
                            "codigo_ibge": 1100205,
                            "ddd": 69
                        }
                    ]
                },
                {
                    "id": 2,
                    "nome": "Territ√≥rio Rural da Cidadania do Vale do Jamari",
                    "cor": "#E8B5A5",
                    "unidades": [
                        {
                            "id": 18,
                            "tipo": "ESREG",
                            "nome": "Esreg de Ariquemes",
                            "municipio": "Ariquemes",
                            "latitude": -9.912800,
                            "longitude": -63.033300,
                            "codigo_ibge": 1100023,
                            "ddd": 69
                        },
                        {
                            "id": 19,
                            "tipo": "ESLOC",
                            "nome": "Ariquemes",
                            "municipio": "Ariquemes",
                            "latitude": -9.912800,
                            "longitude": -63.033300,
                            "codigo_ibge": 1100023,
                            "ddd": 69
                        },
                        {
                            "id": 20,
                            "tipo": "ESLOC",
                            "nome": "Alto Para√≠so",
                            "municipio": "Alto Para√≠so",
                            "latitude": -9.714300,
                            "longitude": -63.318800,
                            "codigo_ibge": 1100403,
                            "ddd": 69
                        },
                        {
                            "id": 21,
                            "tipo": "ESLOC",
                            "nome": "Rio Crespo",
                            "municipio": "Rio Crespo",
                            "latitude": -9.693300,
                            "longitude": -62.883300,
                            "codigo_ibge": 1100262,
                            "ddd": 69
                        },
                        {
                            "id": 22,
                            "tipo": "ESLOC",
                            "nome": "Cujubim",
                            "municipio": "Cujubim",
                            "latitude": -9.366700,
                            "longitude": -62.583300,
                            "codigo_ibge": 1100940,
                            "ddd": 69
                        },
                        {
                            "id": 23,
                            "tipo": "ESLOC",
                            "nome": "Machadinho do Oeste",
                            "municipio": "Machadinho D'Oeste",
                            "latitude": -9.42409,
                            "longitude": -61.9923,
                            "codigo_ibge": 1100130,
                            "ddd": 69
                        },
                        {
                            "id": 24,
                            "tipo": "Centro de Treinamento",
                            "nome": "Subunidade 5¬∫ BEC",
                            "municipio": "Machadinho D'Oeste",
                            "latitude": -9.68896,
                            "longitude": -62.21125,
                            "codigo_ibge": 1100130,
                            "ddd": 69
                        },
                        {
                            "id": 25,
                            "tipo": "ESLOC",
                            "nome": "Cacaul√¢ndia",
                            "municipio": "Cacaul√¢ndia",
                            "latitude": -10.340800,
                            "longitude": -62.899700,
                            "codigo_ibge": 1100601,
                            "ddd": 69
                        },
                        {
                            "id": 26,
                            "tipo": "ESLOC",
                            "nome": "Monte Negro",
                            "municipio": "Monte Negro",
                            "latitude": -10.252500,
                            "longitude": -63.297200,
                            "codigo_ibge": 1101401,
                            "ddd": 69
                        },
                        {
                            "id": 27,
                            "tipo": "ESLOC",
                            "nome": "Buritis",
                            "municipio": "Buritis",
                            "latitude": -10.203300,
                            "longitude": -63.829400,
                            "codigo_ibge": 1100452,
                            "ddd": 69
                        },
                        {
                            "id": 28,
                            "tipo": "ESLOC",
                            "nome": "Campo Novo de Rond√¥nia",
                            "municipio": "Campo Novo de Rond√¥nia",
                            "latitude": -10.567200,
                            "longitude": -63.617200,
                            "codigo_ibge": 1100700,
                            "ddd": 69
                        },
                        {
                            // Jacin√≥polis: Territ√≥rio 2 (texto), mas IBGE/cor de Nova Mamor√© (Territ√≥rio 1)
                            "id": 29,
                            "tipo": "ESLOC",
                            "nome": "Jacin√≥polis",
                            "municipio": "Nova Mamor√©",
                            "distrito": "Jacin√≥polis",
                            "latitude": -10.272272,
                            "longitude": -64.273303,
                            "codigo_ibge": 1100338,
                            "ddd": 69
                        }
                    ]
                },
                {
                    "id": 3,
                    "nome": "Territ√≥rio da Cidadania Central de Rond√¥nia",
                    "cor": "#A8D5E8",
                    "unidades": [
                        {
                            "id": 30,
                            "tipo": "ESREG",
                            "nome": "Esreg de Ji-Paran√°",
                            "municipio": "Ji-Paran√°",
                            "latitude": -10.881100,
                            "longitude": -61.941700,
                            "codigo_ibge": 1100122,
                            "ddd": 69
                        },
                        {
                            "id": 31,
                            "tipo": "ESLOC",
                            "nome": "Ji-Paran√°",
                            "municipio": "Ji-Paran√°",
                            "latitude": -10.877800,
                            "longitude": -61.927800,
                            "codigo_ibge": 1100122,
                            "ddd": 69
                        },
                        {
                            "id": 32,
                            "tipo": "ESLOC",
                            "nome": "Nova Londrina",
                            "municipio": "Ji-Paran√°",
                            "latitude": -11.064790,
                            "longitude": -62.009850,
                            "codigo_ibge": 1100122,
                            "ddd": 69
                        },
                        {
                            "id": 33,
                            "tipo": "ESLOC",
                            "nome": "Nova Colina",
                            "municipio": "Ji-Paran√°",
                            "latitude": -10.791800,
                            "longitude": -61.693170,
                            "codigo_ibge": 1100122,
                            "ddd": 69
                        },
                        {
                            "id": 34,
                            "tipo": "ESLOC",
                            "nome": "Presidente M√©dici",
                            "municipio": "Presidente M√©dici",
                            "latitude": -11.172500,
                            "longitude": -61.898600,
                            "codigo_ibge": 1100254,
                            "ddd": 69
                        },
                        {
                            "id": 35,
                            "tipo": "ESLOC",
                            "nome": "Estrela de Rond√¥nia",
                            "municipio": "Ji-Paran√°",
                            "latitude": -11.301450,
                            "longitude": -61.782880,
                            "codigo_ibge": 1100122,
                            "ddd": 69
                        },
                        {
                            "id": 36,
                            "tipo": "ESLOC",
                            "nome": "Novo Riachuelo",
                            "municipio": "Presidente M√©dici",
                            "latitude": -11.082630,
                            "longitude": -61.656970,
                            "codigo_ibge": 1100254,
                            "ddd": 69
                        },
                        {
                            "id": 37,
                            "tipo": "ESLOC",
                            "nome": "Urup√°",
                            "municipio": "Urup√°",
                            "latitude": -11.108300,
                            "longitude": -62.347200,
                            "codigo_ibge": 1101708,
                            "ddd": 69
                        },
                        {
                            "id": 38,
                            "tipo": "ESLOC",
                            "nome": "Teixeir√≥polis",
                            "municipio": "Teixeir√≥polis",
                            "latitude": -10.891700,
                            "longitude": -62.216700,
                            "codigo_ibge": 1101559,
                            "ddd": 69
                        },
                        {
                            "id": 39,
                            "tipo": "ESLOC",
                            "nome": "Vale do Para√≠so",
                            "municipio": "Vale do Para√≠so",
                            "latitude": -10.866700,
                            "longitude": -62.083300,
                            "codigo_ibge": 1101807,
                            "ddd": 69
                        },
                        {
                            "id": 40,
                            "tipo": "ESLOC",
                            "nome": "Rondominas",
                            "municipio": "Ouro Preto do Oeste",
                            "latitude": -10.513200,
                            "longitude": -61.999640,
                            "codigo_ibge": 1100155,
                            "ddd": 69
                        },
                        {
                            "id": 41,
                            "tipo": "ESLOC",
                            "nome": "Mirante da Serra",
                            "municipio": "Mirante da Serra",
                            "latitude": -11.016700,
                            "longitude": -62.666700,
                            "codigo_ibge": 1101302,
                            "ddd": 69
                        },
                        {
                            "id": 42,
                            "tipo": "ESLOC",
                            "nome": "Nova Uni√£o",
                            "municipio": "Nova Uni√£o",
                            "latitude": -10.908300,
                            "longitude": -62.533300,
                            "codigo_ibge": 1101435,
                            "ddd": 69
                        },
                        {
                            "id": 43,
                            "tipo": "ESLOC",
                            "nome": "Taril√¢ndia",
                            "municipio": "Jaru",
                            "latitude": -10.855390,
                            "longitude": -62.796840,
                            "codigo_ibge": 1100114,
                            "ddd": 69
                        },
                        {
                            "id": 44,
                            "tipo": "ESLOC",
                            "nome": "Governador Jorge Teixeira",
                            "municipio": "Governador Jorge Teixeira",
                            "latitude": -10.614020,
                            "longitude": -62.7326400,
                            "codigo_ibge": 1101005,
                            "ddd": 69
                        },
                        {
                            "id": 45,
                            "tipo": "ESLOC",
                            "nome": "Colina Verde",
                            "municipio": "Governador Jorge Teixeira",
                            "latitude": -10.541740,
                            "longitude": -63.0181600,
                            "codigo_ibge": 1101005,
                            "ddd": 69
                        },
                        {
                            "id": 46,
                            "tipo": "ESLOC",
                            "nome": "Jaru",
                            "municipio": "Jaru",
                            "latitude": -10.438900,
                            "longitude": -62.466400,
                            "codigo_ibge": 1100114,
                            "ddd": 69
                        },
                        {
                            "id": 47,
                            "tipo": "ESLOC",
                            "nome": "Theobroma",
                            "municipio": "Theobroma",
                            "latitude": -10.241700,
                            "longitude": -62.358300,
                            "codigo_ibge": 1101609,
                            "ddd": 69
                        },
                        {
                            "id": 48,
                            "tipo": "ESLOC",
                            "nome": "Vale do Anari",
                            "municipio": "Vale do Anari",
                            "latitude": -9.855600,
                            "longitude": -62.233300,
                            "codigo_ibge": 1101757,
                            "ddd": 69
                        },
                        {
                            "id": 49,
                            "tipo": "ESLOC",
                            "nome": "Ouro Preto do Oeste",
                            "municipio": "Ouro Preto do Oeste",
                            "latitude": -10.747200,
                            "longitude": -62.215800,
                            "codigo_ibge": 1100155,
                            "ddd": 69
                        },
                        {
                            "id": 50,
                            "tipo": "Centro de Treinamento",
                            "nome": "Centrer",
                            "municipio": "Ouro Preto do Oeste",
                            "latitude": -10.747200,
                            "longitude": -62.215800,
                            "codigo_ibge": 1100155,
                            "ddd": 69
                        }
                    ]
                },
                {
                    "id": 4,
                    "nome": "Territ√≥rio de Identidade Vale do Guapor√©",
                    "cor": "#A855A8",
                    "unidades": [
                        {
                            "id": 51,
                            "tipo": "ESREG",
                            "nome": "Esreg de S√£o Francisco do Guapor√©",
                            "municipio": "S√£o Francisco do Guapor√©",
                            "latitude": -12.058300,
                            "longitude": -63.566700,
                            "codigo_ibge": 1101492,
                            "ddd": 69
                        },
                        {
                            "id": 52,
                            "tipo": "ESLOC",
                            "nome": "S√£o Francisco do Guapor√©",
                            "municipio": "S√£o Francisco do Guapor√©",
                            "latitude": -12.058300,
                            "longitude": -63.566700,
                            "codigo_ibge": 1101492,
                            "ddd": 69
                        },
                        {
                            "id": 53,
                            "tipo": "ESLOC",
                            "nome": "S√£o Domingos",
                            "municipio": "Costa Marques",
                            "distrito": "S√£o Domingos",
                            "latitude": -12.07514,
                            "longitude": -64.02769,
                            "codigo_ibge": 1100080,
                            "ddd": 69
                        },
                        {
                            "id": 54,
                            "tipo": "ESLOC",
                            "nome": "Costa Marques",
                            "municipio": "Costa Marques",
                            "latitude": -12.436100,
                            "longitude": -64.231400,
                            "codigo_ibge": 1100080,
                            "ddd": 69
                        },
                        {
                            "id": 55,
                            "tipo": "ESLOC",
                            "nome": "Seringueiras",
                            "municipio": "Seringueiras",
                            "latitude": -11.808300,
                            "longitude": -63.016700,
                            "codigo_ibge": 1101500,
                            "ddd": 69
                        },
                        {
                            "id": 56,
                            "tipo": "ESLOC",
                            "nome": "S√£o Miguel do Guapor√©",
                            "municipio": "S√£o Miguel do Guapor√©",
                            "latitude": -11.691700,
                            "longitude": -62.716700,
                            "codigo_ibge": 1100320,
                            "ddd": 69
                        },
                        {
                            "id": 57,
                            "tipo": "ESLOC",
                            "nome": "Alvorada do Oeste",
                            "municipio": "Alvorada D'Oeste",
                            "latitude": -11.333300,
                            "longitude": -62.283300,
                            "codigo_ibge": 1100346,
                            "ddd": 69
                        }
                    ]
                },
                {
                    "id": 5,
                    "nome": "Territ√≥rio de Identidade Zona da Mata",
                    "cor": "#5A7FB8",
                    "unidades": [
                        {
                            "id": 58,
                            "tipo": "ESREG",
                            "nome": "Esreg de Rolim de Moura",
                            "municipio": "Rolim de Moura",
                            "latitude": -11.727200,
                            "longitude": -61.774700,
                            "codigo_ibge": 1100288,
                            "ddd": 69
                        },
                        {
                            "id": 59,
                            "tipo": "ESLOC",
                            "nome": "Rolim de Moura",
                            "municipio": "Rolim de Moura",
                            "latitude": -11.727200,
                            "longitude": -61.774700,
                            "codigo_ibge": 1100288,
                            "ddd": 69
                        },
                        {
                            "id": 60,
                            "tipo": "ESLOC",
                            "nome": "Novo Horizonte do Oeste",
                            "municipio": "Novo Horizonte do Oeste",
                            "latitude": -11.700000,
                            "longitude": -61.983300,
                            "codigo_ibge": 1100502,
                            "ddd": 69
                        },
                        {
                            "id": 61,
                            "tipo": "ESLOC",
                            "nome": "Nova Brasil√¢ndia do Oeste",
                            "municipio": "Nova Brasil√¢ndia D'Oeste",
                            "latitude": -11.716700,
                            "longitude": -62.316700,
                            "codigo_ibge": 1100148,
                            "ddd": 69
                        },
                        {
                            "id": 62,
                            "tipo": "ESLOC",
                            "nome": "Castanheiras",
                            "municipio": "Castanheiras",
                            "latitude": -11.433300,
                            "longitude": -61.950000,
                            "codigo_ibge": 1100908,
                            "ddd": 69
                        },
                        {
                            "id": 63,
                            "tipo": "ESLOC",
                            "nome": "Santa Luzia do Oeste",
                            "municipio": "Santa Luzia D'Oeste",
                            "latitude": -11.855556,
                            "longitude": -61.783333,
                            "codigo_ibge": 1100296,
                            "ddd": 69
                        },
                        {
                            "id": 64,
                            "tipo": "ESLOC",
                            "nome": "Alta Floresta do Oeste",
                            "municipio": "Alta Floresta D'Oeste",
                            "latitude": -11.928300,
                            "longitude": -61.995300,
                            "codigo_ibge": 1100015,
                            "ddd": 69
                        },
                        {
                            "id": 65,
                            "tipo": "ESLOC",
                            "nome": "Alto Alegre dos Parecis",
                            "municipio": "Alto Alegre dos Parecis",
                            "latitude": -12.132000,
                            "longitude": -61.835000,
                            "codigo_ibge": 1100379,
                            "ddd": 69
                        },
                        {
                            "id": 66,
                            "tipo": "ESLOC",
                            "nome": "Izidol√¢ndia",
                            "municipio": "Alta Floresta D'Oeste",
                            "distrito": "Izidol√¢ndia",
                            "latitude": -12.604510,
                            "longitude": -62.174920,
                            "codigo_ibge": 1100015,
                            "ddd": 69
                        }
                    ]
                },
                {
                    "id": 6,
                    "nome": "Territ√≥rio de Identidade Rio Machado",
                    "cor": "#E8A5C8",
                    "unidades": [
                        {
                            "id": 67,
                            "tipo": "ESREG",
                            "nome": "Esreg de Pimenta Bueno",
                            "municipio": "Pimenta Bueno",
                            "latitude": -11.672200,
                            "longitude": -61.193100,
                            "codigo_ibge": 1100189,
                            "ddd": 69
                        },
                        {
                            "id": 68,
                            "tipo": "ESLOC",
                            "nome": "Pimenta Bueno",
                            "municipio": "Pimenta Bueno",
                            "latitude": -11.672200,
                            "longitude": -61.193100,
                            "codigo_ibge": 1100189,
                            "ddd": 69
                        },
                        {
                            "id": 69,
                            "tipo": "ESLOC",
                            "nome": "Espig√£o do Oeste",
                            "municipio": "Espig√£o D'Oeste",
                            "latitude": -11.525600,
                            "longitude": -61.005600,
                            "codigo_ibge": 1100098,
                            "ddd": 69
                        },
                        {
                            "id": 70,
                            "tipo": "ESLOC",
                            "nome": "Cacoal",
                            "municipio": "Cacoal",
                            "latitude": -11.438600,
                            "longitude": -61.447200,
                            "codigo_ibge": 1100049,
                            "ddd": 69
                        },
                        {
                            "id": 71,
                            "tipo": "ESLOC",
                            "nome": "Ministro Andreazza",
                            "municipio": "Ministro Andreazza",
                            "latitude": -11.074170,
                            "longitude": -61.516940,
                            "codigo_ibge": 1101203,
                            "ddd": 69
                        },
                        {
                            "id": 72,
                            "tipo": "ESLOC",
                            "nome": "S√£o Felipe d'Oeste",
                            "municipio": "S√£o Felipe D'Oeste",
                            "latitude": -11.910800,
                            "longitude": -61.513010,
                            "codigo_ibge": 1101484,
                            "ddd": 69
                        },
                        {
                            "id": 73,
                            "tipo": "ESLOC",
                            "nome": "Primavera de Rond√¥nia",
                            "municipio": "Primavera de Rond√¥nia",
                            "latitude": -11.829460,
                            "longitude": -61.315340,
                            "codigo_ibge": 1101476,
                            "ddd": 69
                        },
                        {
                            "id": 74,
                            "tipo": "ESLOC",
                            "nome": "Parecis",
                            "municipio": "Parecis",
                            "latitude": -12.286600  ,
                            "longitude": -61.316600,
                            "codigo_ibge": 1101450,
                            "ddd": 69
                        },
                        {
                            "id": 75,
                            "tipo": "ESLOC",
                            "nome": "Boa Vista do Pacarana",
                            "municipio": "Espig√£o D'Oeste",
                            "distrito": "Boa Vista do Pacarana",
                            "latitude": -11.001930,
                            "longitude": -60.847350,
                            "codigo_ibge": 1100098,
                            "ddd": 69
                        }
                    ]
                },
                {
                    "id": 7,
                    "nome": "Territ√≥rio de Identidade Cone Sul",
                    "cor": "#FF9800",
                    "unidades": [
                        {
                            "id": 76,
                            "tipo": "ESREG",
                            "nome": "Esreg de Colorado do Oeste",
                            "municipio": "Colorado do Oeste",
                            "latitude": -13.116700,
                            "longitude": -60.533300,
                            "codigo_ibge": 1100064,
                            "ddd": 69
                        },
                        {
                            "id": 77,
                            "tipo": "ESLOC",
                            "nome": "Colorado do Oeste",
                            "municipio": "Colorado do Oeste",
                            "latitude": -13.116700,
                            "longitude": -60.533300,
                            "codigo_ibge": 1100064,
                            "ddd": 69
                        },
                        {
                            "id": 78,
                            "tipo": "ESLOC",
                            "nome": "Cabixi",
                            "municipio": "Cabixi",
                            "latitude": -13.500000,
                            "longitude": -60.541700,
                            "codigo_ibge": 1100031,
                            "ddd": 69
                        },
                        {
                            "id": 79,
                            "tipo": "ESLOC",
                            "nome": "Pimenteiras do Oeste",
                            "municipio": "Pimenteiras do Oeste",
                            "latitude": -13.483300,
                            "longitude": -61.033300,
                            "codigo_ibge": 1101468,
                            "ddd": 69
                        },
                        {
                            "id": 80,
                            "tipo": "ESLOC",
                            "nome": "Cerejeiras",
                            "municipio": "Cerejeiras",
                            "latitude": -13.183300,
                            "longitude": -60.816700,
                            "codigo_ibge": 1100056,
                            "ddd": 69
                        },
                        {
                            "id": 81,
                            "tipo": "ESLOC",
                            "nome": "Corumbiara",
                            "municipio": "Corumbiara",
                            "latitude": -12.983300,
                            "longitude": -60.916700,
                            "codigo_ibge": 1100072,
                            "ddd": 69
                        },
                        {
                            "id": 82,
                            "tipo": "ESLOC",
                            "nome": "Chupinguaia",
                            "municipio": "Chupinguaia",
                            "latitude": -12.566700,
                            "longitude": -60.900000,
                            "codigo_ibge": 1100924,
                            "ddd": 69
                        },
                        {
                            "id": 83,
                            "tipo": "ESLOC",
                            "nome": "Vilhena",
                            "municipio": "Vilhena",
                            "latitude": -12.740600,
                            "longitude": -60.145800,
                            "codigo_ibge": 1100304,
                            "ddd": 69
                        }
                    ]
                }
            ]
        };

        // Vari√°vel global para armazenar dados de cobertura
        let dadosCobertura = {
            municipios: [],
            resumo: {}
        };

        // Sincronizar dados do Azure SQL silenciosamente
        async function sincronizarDadosDoServidorSilencioso() {
            try {
                if (!navigator.onLine) return;
                
                console.log('üîÑ [MAPA] Sincronizando com servidor...');
                const resultado = await buscarFormulariosDoAzure({ limite: 10000 });
                
                if (resultado.success && resultado.formularios) {
                    const formulariosServidor = resultado.formularios;
                    const formulariosLocais = await buscarTodosFormularios();
                    const protocolosLocais = new Set(formulariosLocais.map(f => f.protocolo));
                    
                    const db = await initDB();
                    const transaction = db.transaction(['formularios'], 'readwrite');
                    const store = transaction.objectStore('formularios');
                    
                    let novos = 0;
                    for (const formServidor of formulariosServidor) {
                        if (!protocolosLocais.has(formServidor.protocolo)) {
                            formServidor.sincronizado = true;
                            delete formServidor.id;
                            try {
                                await new Promise((resolve, reject) => {
                                    const req = store.add(formServidor);
                                    req.onsuccess = () => { novos++; resolve(); };
                                    req.onerror = reject;
                                });
                            } catch (e) {}
                        }
                    }
                    
                    if (novos > 0) console.log(`‚úÖ [MAPA] ${novos} novos formul√°rios`);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è [MAPA] Erro ao sincronizar:', error.message);
            }
        }

        // Helper para obter respostas parseadas (compatibilidade de estrutura)
        function getRespostas(formulario) {
            if (!formulario) return null;
            
            let respostas = formulario.respostas;
            
            // Se respostas for string, fazer parse
            if (typeof respostas === 'string') {
                try {
                    respostas = JSON.parse(respostas);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao parsear respostas:', e);
                    return formulario; // Fallback para raiz
                }
            }
            
            // Se respostas existe (objeto), usar ela
            // Sen√£o, fallback para o pr√≥prio formul√°rio (dados na raiz)
            return respostas || formulario;
        }

        // Fun√ß√£o para buscar estat√≠sticas de cobertura do IndexedDB
        async function buscarEstatisticasCobertura() {
            try {
                // Sincronizar dados do servidor primeiro (silencioso)
                await sincronizarDadosDoServidorSilencioso();
                
                console.log('üîÑ Buscando formul√°rios do IndexedDB...');
                
                // Buscar todos os formul√°rios do IndexedDB
                const db = await initDB();
                const transaction = db.transaction(['formularios'], 'readonly');
                const store = transaction.objectStore('formularios');
                const request = store.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const formularios = request.result;
                        console.log(`üìä ${formularios.length} formul√°rios encontrados`);
                        
                        // Processar dados para gerar estat√≠sticas
                        const municipiosMap = new Map();
                        const unidadesMap = new Map();
                        const territoriosMap = new Map();
                        
                        formularios.forEach(form => {
                            // Usar helper getRespostas() para garantir compatibilidade
                            const respostas = getRespostas(form);
                            const municipio = respostas?.municipio;
                            const unidade = respostas?.escritorioLocal || respostas?.unidade_emater;
                            const territorio = respostas?.territorio || 'N√£o especificado';
                            const timestamp = form.timestampFim || form.timestamp_fim || form.timestamp;
                            
                            // Processar munic√≠pio
                            if (municipio) {
                                if (!municipiosMap.has(municipio)) {
                                    municipiosMap.set(municipio, {
                                        municipio: municipio,
                                        total_formularios: 0,
                                        territorio: territorio
                                    });
                                }
                                municipiosMap.get(municipio).total_formularios++;
                            }
                            
                            // Processar unidade EMATER
                            if (unidade) {
                                if (!unidadesMap.has(unidade)) {
                                    unidadesMap.set(unidade, {
                                        unidade: unidade,
                                        total_visitas: 0,
                                        ultima_visita: timestamp,
                                        primeira_visita: timestamp
                                    });
                                }
                                const unidadeData = unidadesMap.get(unidade);
                                unidadeData.total_visitas++;
                                
                                // Atualizar √∫ltima visita (mais recente)
                                if (timestamp && (!unidadeData.ultima_visita || timestamp > unidadeData.ultima_visita)) {
                                    unidadeData.ultima_visita = timestamp;
                                }
                                
                                // Atualizar primeira visita (mais antiga)
                                if (timestamp && (!unidadeData.primeira_visita || timestamp < unidadeData.primeira_visita)) {
                                    unidadeData.primeira_visita = timestamp;
                                }
                            }
                            
                            // Processar territ√≥rio
                            if (territorio) {
                                territoriosMap.set(territorio, (territoriosMap.get(territorio) || 0) + 1);
                            }
                        });
                        
                        // Calcular dias desde √∫ltima visita para cada unidade
                        const agora = Date.now();
                        const unidadesArray = Array.from(unidadesMap.values()).map(u => ({
                            ...u,
                            dias_desde_ultima: u.ultima_visita 
                                ? Math.floor((agora - new Date(u.ultima_visita).getTime()) / (1000 * 60 * 60 * 24))
                                : null
                        }));
                        
                        // Montar dados no formato esperado
                        dadosCobertura = {
                            success: true,
                            municipios: Array.from(municipiosMap.values()),
                            unidades: unidadesArray,
                            resumo: {
                                total_formularios: formularios.length,
                                total_municipios: municipiosMap.size,
                                total_unidades: unidadesMap.size,
                                total_territorios: territoriosMap.size,
                                cobertura_percentual: ((municipiosMap.size / 52) * 100).toFixed(1)
                            }
                        };
                        
                        console.log('üìä Estat√≠sticas processadas:', dadosCobertura.resumo);
                        console.log('üü¢ Munic√≠pios visitados:', dadosCobertura.municipios.map(m => m.municipio));
                        console.log('üè¢ Unidades EMATER visitadas:', dadosCobertura.unidades.map(u => u.unidade));
                        
                        atualizarEstatisticasSidebar();
                        resolve(dadosCobertura);
                    };
                    
                    request.onerror = () => {
                        console.error('‚ùå Erro ao buscar do IndexedDB');
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('‚ùå Erro ao buscar estat√≠sticas:', error);
                return null;
            }
        }

        // Fun√ß√£o para atualizar estat√≠sticas na sidebar
        function atualizarEstatisticasSidebar() {
            const resumo = dadosCobertura.resumo;
            
            // Atualizar valores
            document.getElementById('total-unidades').textContent = resumo.total_unidades_emater || 83;
            document.getElementById('total-municipios').textContent = resumo.total_municipios || 52;
            
            // Limpar estat√≠sticas de cobertura anteriores (se existirem)
            const statsDiv = document.querySelector('.stats');
            const statItemsExistentes = statsDiv.querySelectorAll('.stat-item');
            
            // Remove itens ap√≥s o 4¬∫ (os 4 primeiros s√£o: Total Unidades, Territ√≥rios, Munic√≠pios IBGE, Munic√≠pios+Distritos)
            if (statItemsExistentes.length > 4) {
                for (let i = statItemsExistentes.length - 1; i >= 4; i--) {
                    statItemsExistentes[i].remove();
                }
            }
            
            // Adicionar estat√≠sticas de cobertura
            const coberturaHTML = `
                <div class="stat-item">
                    <span class="stat-label">Formul√°rios Preenchidos:</span>
                    <span class="stat-value green">${resumo.total_formularios || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Unidades Visitadas:</span>
                    <span class="stat-value orange">${resumo.unidades_visitadas || 0}/${resumo.total_unidades_emater || 83}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Munic√≠pios Visitados:</span>
                    <span class="stat-value orange">${resumo.municipios_visitados || 0}/${resumo.total_municipios || 52}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Cobertura Unidades:</span>
                    <span class="stat-value ${resumo.percentual_cobertura_unidades >= 50 ? 'green' : 'red'}">${resumo.percentual_cobertura_unidades || 0}%</span>
                </div>
            `;
            
            // Inserir ap√≥s as estat√≠sticas existentes
            const lastStatItem = statsDiv.querySelector('.stat-item:last-child');
            if (lastStatItem) {
                lastStatItem.insertAdjacentHTML('afterend', coberturaHTML);
            }
        }

        // Fun√ß√£o para verificar se uma unidade EMATER foi visitada
        function unidadeFoiVisitada(nomeUnidade) {
            if (!dadosCobertura.unidades) return false;
            const visitada = dadosCobertura.unidades.some(u => 
                u.unidade.toLowerCase().trim() === nomeUnidade.toLowerCase().trim()
            );
            if (visitada) {
                console.log(`‚úÖ Unidade ${nomeUnidade} foi VISITADA`);
            }
            return visitada;
        }

        // Fun√ß√£o para obter informa√ß√µes de visitas da unidade EMATER
        function getInfoVisitasUnidade(nomeUnidade) {
            if (!dadosCobertura.unidades) return null;
            return dadosCobertura.unidades.find(u => 
                u.unidade.toLowerCase().trim() === nomeUnidade.toLowerCase().trim()
            );
        }

        // Fun√ß√£o para verificar se um munic√≠pio foi visitado (compatibilidade)
        function municipioFoiVisitado(nomeMunicipio) {
            if (!dadosCobertura.municipios) return false;
            const visitado = dadosCobertura.municipios.some(m => 
                m.municipio.toLowerCase().trim() === nomeMunicipio.toLowerCase().trim()
            );
            if (visitado) {
                console.log(`‚úÖ ${nomeMunicipio} foi VISITADO`);
            }
            return visitado;
        }

        // Fun√ß√£o para obter informa√ß√µes de visitas do munic√≠pio (compatibilidade)
        function getInfoVisitasMunicipio(nomeMunicipio) {
            if (!dadosCobertura.municipios) return null;
            return dadosCobertura.municipios.find(m => 
                m.municipio.toLowerCase().trim() === nomeMunicipio.toLowerCase().trim()
            );
        }

        // Fun√ß√£o para atualizar destaque dos territ√≥rios
        function atualizarDestaqueTerritorio(territorioId) {
            territorioAtivoId = territorioId;
            
            // Redesenhar layer de munic√≠pios se existir
            if (layerMunicipios) {
                layerMunicipios.setStyle((feature) => {
                    const props = feature.properties || {};
                    const idIbge = props.id;
                    const nome = props.name || props.NOME || props.NM_MUN || '';
                    
                    const foiVisitado = municipioFoiVisitado(nome);
                    
                    let territorio = null;
                    if (idIbge && municipioParaTerritorio[idIbge]) {
                        territorio = municipioParaTerritorio[idIbge];
                    } else {
                        const keyNome = normalizaNomeMunicipio(nome);
                        if (municipioParaTerritorio[keyNome]) {
                            territorio = municipioParaTerritorio[keyNome];
                        }
                    }
                    
                    let cor, borda, opacidade;
                    
                    // Se n√£o h√° territ√≥rio ativo, ou este munic√≠pio pertence ao territ√≥rio ativo
                    const pertenceAoTerritorioAtivo = !territorioAtivoId || (territorio && territorio.id === territorioAtivoId);
                    
                    if (foiVisitado) {
                        cor = '#27ae60';
                        borda = '#1e8449';
                        opacidade = pertenceAoTerritorioAtivo ? 0.45 : 0.15;
                    } else {
                        if (pertenceAoTerritorioAtivo) {
                            // Territ√≥rio ativo: cor original
                            cor = territorio ? territorio.cor : '#95a5a6';
                            borda = '#7f8c8d';
                            opacidade = 0.15;
                        } else {
                            // Territ√≥rio inativo: cinza neutro
                            cor = '#d5d5d5';
                            borda = '#b0b0b0';
                            opacidade = 0.08;
                        }
                    }
                    
                    return {
                        color: borda,
                        weight: foiVisitado ? 2 : 1,
                        fillColor: cor,
                        fillOpacity: opacidade,
                        className: foiVisitado ? 'municipio-visitado' : 'municipio-polygon'
                    };
                });
            }
        }

        // Vari√°vel global para territ√≥rio ativo (destaque)
        let territorioAtivoId = null;
        let layerMunicipios = null;
        let geoJsonLayer = null; // Camada de pol√≠gonos dos munic√≠pios
        let filtroMunicipiosVisitados = false; // Novo: controla filtro de munic√≠pios visitados

        // Inicializar mapa
        const map = L.map('map').setView([-10.9, -62.8], 7);
        const defaultView = {
            center: [-10.9, -62.8],
            zoom: 7
        };

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Carregar pol√≠gonos dos munic√≠pios
        carregarPoligonosMunicipios();

        let markers = [];
        let markerGroups = {};
        let currentFilter = 'todos';
        let searchTerm = '';

        const iconTypes = {
            'Centro Gerencial': 'üèõÔ∏è',
            'ESREG': 'üè¢',
            'ESLOC': 'üìç',
            'Centro de Treinamento': 'üéì'
        };

        // Fun√ß√£o para carregar pol√≠gonos dos munic√≠pios
        async function carregarPoligonosMunicipios() {
            try {
                const response = await fetch('geojs-11-mun.json');
                const geoJsonData = await response.json();

                geoJsonLayer = L.geoJSON(geoJsonData, {
                    style: function(feature) {
                        return getPolygonStyle(feature.properties.name);
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            layer.bindTooltip(feature.properties.name, {
                                permanent: false,
                                direction: 'center',
                                className: 'municipio-tooltip-geojson'
                            });
                        }

                        layer.on({
                            mouseover: function(e) {
                                const layer = e.target;
                                layer.setStyle({
                                    weight: 3,
                                    color: '#2a5298',
                                    fillOpacity: 0.7
                                });
                            },
                            mouseout: function(e) {
                                geoJsonLayer.resetStyle(e.target);
                            },
                            click: function(e) {
                                const municipioNome = e.target.feature.properties.name;
                                // Encontrar marcadores deste munic√≠pio
                                const marcadoresMunicipio = markers.filter(m => 
                                    m.unidadeMunicipio === municipioNome
                                );
                                if (marcadoresMunicipio.length > 0) {
                                    map.setView([e.latlng.lat, e.latlng.lng], 10);
                                    marcadoresMunicipio[0].openPopup();
                                }
                            }
                        });
                    }
                }).addTo(map);

                // Enviar pol√≠gonos para tr√°s dos marcadores
                geoJsonLayer.bringToBack();

                console.log('‚úÖ Pol√≠gonos dos munic√≠pios carregados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar pol√≠gonos:', error);
            }
        }

        // Fun√ß√£o para obter estilo do pol√≠gono baseado em dados
        function getPolygonStyle(municipio) {
            if (!municipio) return getStylePadrao();
            
            const foiVisitado = municipioFoiVisitado(municipio);
            const infoVisitas = getInfoVisitasMunicipio(municipio);
            
            if (foiVisitado && infoVisitas) {
                const count = infoVisitas.total_formularios;
                
                if (count <= 2) {
                    return {
                        fillColor: '#667eea',
                        weight: 2,
                        opacity: 1,
                        color: '#4c51bf',
                        fillOpacity: 0.4
                    };
                } else if (count <= 5) {
                    return {
                        fillColor: '#f39c12',
                        weight: 2,
                        opacity: 1,
                        color: '#d68910',
                        fillOpacity: 0.4
                    };
                } else {
                    return {
                        fillColor: '#27ae60',
                        weight: 2,
                        opacity: 1,
                        color: '#1e8449',
                        fillOpacity: 0.5
                    };
                }
            }
            
            return getStylePadrao();
        }

        function getStylePadrao() {
            return {
                fillColor: '#e0e0e0',
                weight: 1.5,
                opacity: 1,
                color: '#999',
                fillOpacity: 0.2
            };
        }

        // Fun√ß√£o para atualizar cores dos pol√≠gonos
        function atualizarCoresPoligonos() {
            if (!geoJsonLayer) return;

            geoJsonLayer.eachLayer(function(layer) {
                const municipioNome = layer.feature.properties.name;
                const estilo = getPolygonStyle(municipioNome);
                layer.setStyle(estilo);
            });
        }

        // Fun√ß√£o para resetar o zoom
        function resetZoom() {
            map.setView(defaultView.center, defaultView.zoom, {
                animate: true,
                duration: 1
            });
            // Remove classe active de todos os territ√≥rios
            document.querySelectorAll('.territorio-item').forEach(el => {
                el.classList.remove('active');
            });
            // Resetar destaque (mostrar todos os territ√≥rios)
            atualizarDestaqueTerritorio(null);
        }

        // Fun√ß√£o para destacar apenas munic√≠pios visitados
        function destacarMunicipiosVisitados() {
            console.log('üîç Destacando munic√≠pios visitados...');
            filtroMunicipiosVisitados = true;
            
            // Desativar territ√≥rio ativo
            territorioAtivoId = null;
            document.querySelectorAll('.territorio-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // Atualizar estilos do layer GeoJSON
            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(function(layer) {
                    const municipioNome = layer.feature.properties.name;
                    const foiVisitado = municipioFoiVisitado(municipioNome);
                    
                    if (foiVisitado) {
                        layer.setStyle({
                            fillColor: '#27ae60',
                            weight: 3,
                            opacity: 1,
                            color: '#1e8449',
                            fillOpacity: 0.7
                        });
                    } else {
                        layer.setStyle({
                            fillColor: '#d5d5d5',
                            weight: 1,
                            opacity: 0.5,
                            color: '#b0b0b0',
                            fillOpacity: 0.15
                        });
                    }
                });
            }
            
            // Atualizar estilos do layer antigo (compatibilidade)
            if (layerMunicipios) {
                layerMunicipios.setStyle((feature) => {
                    const props = feature.properties || {};
                    const nome = props.name || props.NOME || props.NM_MUN || '';
                    const foiVisitado = municipioFoiVisitado(nome);
                    
                    let cor, borda, opacidade;
                    
                    if (foiVisitado) {
                        // Munic√≠pio visitado: verde vibrante
                        cor = '#27ae60';
                        borda = '#1e8449';
                        opacidade = 0.85;
                    } else {
                        // Munic√≠pio n√£o visitado: cinza neutro
                        cor = '#d5d5d5';
                        borda = '#b0b0b0';
                        opacidade = 0.10;
                    }
                    
                    return {
                        color: borda,
                        weight: foiVisitado ? 2 : 1,
                        fillColor: cor,
                        fillOpacity: opacidade,
                        className: foiVisitado ? 'municipio-visitado' : 'municipio-polygon'
                    };
                });
            }
            
            // Atualizar bot√µes
            document.getElementById('filter-municipios-visitados').style.display = 'none';
            document.getElementById('filter-limpar-destaque').style.display = 'block';
            
            console.log('‚úÖ Munic√≠pios visitados destacados!');
        }

        // Fun√ß√£o para limpar destaque e mostrar todos
        function limparDestaqueMunicipios() {
            console.log('üîÑ Limpando destaque...');
            filtroMunicipiosVisitados = false;
            
            // Resetar pol√≠gonos GeoJSON para cores originais
            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(function(layer) {
                    const municipioNome = layer.feature.properties.name;
                    const estilo = getPolygonStyle(municipioNome);
                    layer.setStyle(estilo);
                });
            }
            
            // Resetar para mostrar todos os territ√≥rios
            atualizarDestaqueTerritorio(null);
            
            // Atualizar bot√µes
            document.getElementById('filter-municipios-visitados').style.display = 'block';
            document.getElementById('filter-limpar-destaque').style.display = 'none';
            
            console.log('‚úÖ Todos os munic√≠pios vis√≠veis!');
        }

        // Adicionar evento ao bot√£o de reset
        document.getElementById('reset-zoom-btn').addEventListener('click', resetZoom);

        function createCustomIcon(cor, tipo, unidadeVisitada, infoVisitas) {
            const emoji = iconTypes[tipo] || 'üìç';
            
            // Determinar cor baseada no status de visita
            let corFinal = cor;
            let badge = '';
            
            if (unidadeVisitada && infoVisitas) {
                // Munic√≠pio visitado - marcador verde
                const diasDesdeUltima = infoVisitas.dias_desde_ultima || 0;
                
                if (diasDesdeUltima <= 30) {
                    corFinal = '#27ae60'; // Verde escuro (recente)
                } else {
                    corFinal = '#52c77a'; // Verde claro (antiga)
                }
                
                // Adicionar badge com n√∫mero de visitas (sempre que houver visitas)
                if (infoVisitas.total_visitas >= 1) {
                    badge = `<div style="
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: #e74c3c;
                        color: white;
                        border-radius: 50%;
                        width: 18px;
                        height: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 0.65em;
                        font-weight: bold;
                        border: 2px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    ">${infoVisitas.total_visitas}</div>`;
                }
            } else {
                // Munic√≠pio n√£o visitado - marcador cinza
                corFinal = '#bdc3c7';
            }
            
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    position: relative;
                    background-color: ${corFinal};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    border: 3px solid ${unidadeVisitada ? '#27ae60' : '#95a5a6'};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 16px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                ">${emoji}${badge}</div>`,

                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        // Adiciona marcadores (com exce√ß√£o visual para Jacin√≥polis)
        function addMarkers() {
            ematerData.territorios.forEach(territorio => {
                markerGroups[territorio.id] = [];
                
                territorio.unidades.forEach(unidade => {
                    const latOffset = (Math.random() - 0.5) * 0.005;
                    const lngOffset = (Math.random() - 0.5) * 0.005;

                    // Cor padr√£o: cor do pr√≥prio territ√≥rio
                    let corMarker = territorio.cor;

                    // EXCE√á√ÉO: Jacin√≥polis deve usar a mesma cor de Nova Mamor√© (territ√≥rio 1)
                    if (unidade.nome === "Jacin√≥polis") {
                        const territorioNovaMamore = ematerData.territorios.find(t =>
                            t.unidades.some(u => u.codigo_ibge === 1100338) // c√≥digo de Nova Mamor√©
                        );
                        if (territorioNovaMamore) {
                            corMarker = territorioNovaMamore.cor;
                        }
                    }

                    // Verificar se unidade EMATER foi visitada
                    const unidadeVisitada = unidadeFoiVisitada(unidade.nome);
                    const infoVisitas = getInfoVisitasUnidade(unidade.nome);

                    const marker = L.marker(
                        [unidade.latitude + latOffset, unidade.longitude + lngOffset],
                        { icon: createCustomIcon(corMarker, unidade.tipo, unidadeVisitada, infoVisitas) }
                    );

                    // Adicionar informa√ß√µes de visita ao popup
                    let statusVisita = '';
                    if (unidadeVisitada && infoVisitas) {
                        const diasDesde = infoVisitas.dias_desde_ultima;
                        const dataUltima = new Date(infoVisitas.ultima_visita).toLocaleDateString('pt-BR');
                        statusVisita = `
                            <div class="popup-info" style="background: #d4edda; padding: 8px; border-radius: 5px; margin-top: 10px;">
                                <span class="popup-label" style="color: #155724;">‚úÖ Unidade Visitada</span><br>
                                <span style="color: #155724; font-size: 0.9em;">
                                    Total de visitas: <b>${infoVisitas.total_visitas}</b><br>
                                    √öltima visita: <b>${dataUltima}</b> (${diasDesde} dias atr√°s)
                                </span>
                            </div>
                        `;
                    } else {
                        statusVisita = `
                            <div class="popup-info" style="background: #f8d7da; padding: 8px; border-radius: 5px; margin-top: 10px;">
                                <span class="popup-label" style="color: #721c24;">‚ùå Unidade n√£o visitada</span><br>
                                <span style="color: #721c24; font-size: 0.9em;">
                                    Nenhum formul√°rio preenchido nesta unidade
                                </span>
                            </div>
                        `;
                    }

                    const popupContent = `
                        <div class="popup-content">
                            <div class="popup-title">${unidade.nome}</div>
                            <div class="popup-info">
                                <span class="popup-label">Tipo:</span> ${unidade.tipo}
                            </div>
                            <div class="popup-info">
                                <span class="popup-label">Munic√≠pio:</span> ${unidade.municipio}
                            </div>
                            ${unidade.distrito ? `<div class="popup-info">
                                <span class="popup-label">Distrito:</span> ${unidade.distrito}
                            </div>` : ''}
                            <div class="popup-info">
                                <span class="popup-label">Territ√≥rio:</span> ${territorio.nome}
                            </div>
                            ${statusVisita}
                            <div class="popup-info" style="margin-top: 10px; font-size: 0.85em; color: #666;">
                                <span class="popup-label">DDD:</span> ${unidade.ddd} | 
                                <span class="popup-label">IBGE:</span> ${unidade.codigo_ibge}
                            </div>
                        </div>
                    `;

                    marker.bindPopup(popupContent, {
                        className: 'custom-popup',
                        maxWidth: 300
                    });

                    marker.territorioId = territorio.id;
                    marker.unidadeTipo = unidade.tipo;
                    marker.unidadeNome = unidade.nome;
                    marker.unidadeMunicipio = unidade.municipio;
                    marker.unidadeDistrito = unidade.distrito || '';
                    marker.addTo(map);
                    
                    markers.push(marker);
                    markerGroups[territorio.id].push(marker);
                });
            });
        }

        function createTerritorioList() {
            const list = document.getElementById('territorio-list');
            const overlay = document.getElementById('tooltip-overlay');
            const tooltipsContainer = document.getElementById('tooltips-container');
            list.innerHTML = '';
            tooltipsContainer.innerHTML = '';

            ematerData.territorios.forEach(territorio => {
                const item = document.createElement('div');
                item.className = 'territorio-item';
                item.style.borderLeftColor = territorio.cor;
                
                // Criar lista de todas as unidades do territ√≥rio
                const unidadesHtml = territorio.unidades.map(u => {
                    const tipoEmoji = {
                        'Centro Gerencial': 'üèõÔ∏è',
                        'ESREG': 'üè¢',
                        'ESLOC': 'üìç',
                        'Centro de Treinamento': 'üéì'
                    };
                    const emoji = tipoEmoji[u.tipo] || 'üìç';
                    const distrito = u.distrito ? ` (Distrito de ${u.municipio})` : '';
                    return `<li>${emoji} ${u.nome}${distrito}</li>`;
                }).join('');
                
                const tooltipId = `tooltip-${territorio.id}`;
                
                item.innerHTML = `
                    <div class="territorio-header">
                        <div class="territorio-color" style="background-color: ${territorio.cor}"></div>
                        <div class="territorio-name">${territorio.nome}</div>
                        <div class="territorio-count">${territorio.unidades.length}</div>
                        <div class="territorio-info-icon" data-tooltip="${tooltipId}" title="Ver unidades">‚ÑπÔ∏è</div>
                    </div>
                `;

                // Criar tooltip separadamente
                const tooltip = document.createElement('div');
                tooltip.className = 'territorio-tooltip';
                tooltip.id = tooltipId;
                tooltip.innerHTML = `
                    <div class="territorio-tooltip-header">
                        <h4>Unidades deste territ√≥rio:</h4>
                        <button class="territorio-tooltip-close" title="Fechar">√ó</button>
                    </div>
                    <ul>
                        ${unidadesHtml}
                    </ul>
                `;
                tooltipsContainer.appendChild(tooltip);

                // Event listener para zoom no territ√≥rio (clique no card, mas n√£o no √≠cone info)
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.territorio-info-icon')) {
                        return;
                    }
                    
                    document.querySelectorAll('.territorio-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    item.classList.add('active');
                    
                    // Atualizar destaque do territ√≥rio
                    atualizarDestaqueTerritorio(territorio.id);
                    
                    const bounds = L.latLngBounds(
                        territorio.unidades.map(u => [u.latitude, u.longitude])
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });
                });

                // Event listener para mostrar tooltip
                const infoIcon = item.querySelector('.territorio-info-icon');
                const closeBtn = tooltip.querySelector('.territorio-tooltip-close');

                infoIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    // Fechar todos os outros tooltips
                    document.querySelectorAll('.territorio-tooltip').forEach(t => {
                        t.classList.remove('show');
                    });
                    tooltip.classList.add('show');
                    overlay.classList.add('show');
                });

                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    tooltip.classList.remove('show');
                    overlay.classList.remove('show');
                });

                list.appendChild(item);
            });

            // Event listener para fechar ao clicar no overlay
            overlay.addEventListener('click', () => {
                document.querySelectorAll('.territorio-tooltip').forEach(t => {
                    t.classList.remove('show');
                });
                overlay.classList.remove('show');
            });
        }

        function updateStats() {
            // Total de unidades (cada unidade √© uma localidade)
            let totalUnidades = 0;
            // Munic√≠pios distintos pelo c√≥digo IBGE (munic√≠pio oficial)
            const municipiosIbgeUnicos = new Set();

            ematerData.territorios.forEach(t => {
                totalUnidades += t.unidades.length;
                t.unidades.forEach(u => {
                    if (u.codigo_ibge) {
                        municipiosIbgeUnicos.add(u.codigo_ibge);
                    }
                });
            });

            document.getElementById('total-unidades').textContent = totalUnidades;
            document.getElementById('total-territorios').textContent = ematerData.territorios.length;
            document.getElementById('total-municipios').textContent = municipiosIbgeUnicos.size;
            document.getElementById('total-localidades').textContent = totalUnidades;
        }

        function filterMarkers(tipo) {
            currentFilter = tipo;
            applyFilters();

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tipo === tipo) {
                    btn.classList.add('active');
                }
            });
        }

        function applyFilters() {
            markers.forEach(marker => {
                const passTypeFilter = currentFilter === 'todos' || marker.unidadeTipo === currentFilter;
                const passSearchFilter = searchTerm === '' || 
                    marker.unidadeNome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    marker.unidadeMunicipio.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (marker.unidadeDistrito && marker.unidadeDistrito.toLowerCase().includes(searchTerm.toLowerCase()));
                
                if (passTypeFilter && passSearchFilter) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                filterMarkers(btn.dataset.tipo);
            });
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            applyFilters();
        });

        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<h4>üìç Tipos de Unidade</h4>';
            
            Object.entries(iconTypes).forEach(([tipo, emoji]) => {
                div.innerHTML += `
                    <div class="legend-item">
                        <span style="font-size: 18px;">${emoji}</span>
                        <span>${tipo}</span>
                    </div>
                `;
            });
            
            div.innerHTML += `
                <div style="margin-top: 15px; padding-top: 12px; border-top: 2px solid #e0e0e0;">
                    <h4 style="margin-bottom: 8px;">üó∫Ô∏è Pol√≠gonos Municipais</h4>
                    <div class="legend-item">
                        <div style="width: 20px; height: 20px; background: rgba(102, 126, 234, 0.4); border: 2px solid #4c51bf; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">1-2 formul√°rios</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 20px; height: 20px; background: rgba(243, 156, 18, 0.4); border: 2px solid #d68910; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">3-5 formul√°rios</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 20px; height: 20px; background: rgba(39, 174, 96, 0.5); border: 2px solid #1e8449; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">6+ formul√°rios</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 20px; height: 20px; background: rgba(224, 224, 224, 0.2); border: 1.5px solid #999; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">Sem formul√°rios</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: #666; font-style: italic;">
                        üí° Passe o mouse sobre os munic√≠pios
                    </div>
                </div>
            `;
            
            return div;
        };
        legend.addTo(map);

        // Mapa auxiliar: munic√≠pio -> territ√≥rio (para pintar pol√≠gonos)
        const municipioParaTerritorio = {};

        ematerData.territorios.forEach(territorio => {
            territorio.unidades.forEach(u => {
                const key = u.municipio
                    .trim()
                    .toLowerCase();

                if (!municipioParaTerritorio[key]) {
                    municipioParaTerritorio[key] = territorio;
                }

                if (u.codigo_ibge) {
                    const ibgeKey = u.codigo_ibge.toString();
                    if (!municipioParaTerritorio[ibgeKey]) {
                        municipioParaTerritorio[ibgeKey] = territorio;
                    }
                }
            });
        });

        function normalizaNomeMunicipio(nome) {
            return nome
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/d'oeste/gi, "doeste")
                .replace(/\s+/g, ' ')
                .trim()
                .toLowerCase();
        }

        // Carregar GeoJSON dos munic√≠pios de RO
        fetch('geojs-11-mun.json')
            .then(r => r.json())
            .then(geo => {
                layerMunicipios = L.geoJSON(geo, {
                    style: feature => {
                        const props = feature.properties || {};
                        const idIbge = props.id;
                        const nome = props.name || props.NOME || props.NM_MUN || '';
                        
                        // Verificar se munic√≠pio foi visitado
                        const foiVisitado = municipioFoiVisitado(nome);
                        
                        let territorio = null;
                        if (idIbge && municipioParaTerritorio[idIbge]) {
                            territorio = municipioParaTerritorio[idIbge];
                        } else {
                            const keyNome = normalizaNomeMunicipio(nome);
                            if (municipioParaTerritorio[keyNome]) {
                                territorio = municipioParaTerritorio[keyNome];
                            }
                        }

                        // Cores diferentes para visitados e n√£o visitados
                        let cor, borda, opacidade;
                        if (foiVisitado) {
                            // Munic√≠pio VISITADO - Verde vibrante
                            cor = '#27ae60'; // Verde escuro
                            borda = '#1e8449'; // Verde mais escuro na borda
                            opacidade = 0.45; // Mais opaco para destacar
                        } else {
                            // Munic√≠pio N√ÉO VISITADO - Cor do territ√≥rio ou cinza
                            cor = territorio ? territorio.cor : '#95a5a6';
                            borda = '#7f8c8d';
                            opacidade = 0.15; // Mais transparente
                        }

                        return {
                            color: borda,
                            weight: foiVisitado ? 2 : 1,
                            fillColor: cor,
                            fillOpacity: opacidade,
                            className: foiVisitado ? 'municipio-visitado' : 'municipio-polygon'
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties || {};
                        const idIbge = props.id;
                        const nome = props.name || props.NOME || props.NM_MUN || '';

                        let territorio = null;
                        if (idIbge && municipioParaTerritorio[idIbge]) {
                            territorio = municipioParaTerritorio[idIbge];
                        } else {
                            const keyNome = normalizaNomeMunicipio(nome);
                            if (municipioParaTerritorio[keyNome]) {
                                territorio = municipioParaTerritorio[keyNome];
                            }
                        }

                        let unidadesDoMunicipio = [];
                        ematerData.territorios.forEach(t => {
                            t.unidades.forEach(u => {
                                if (
                                    u.codigo_ibge === Number(idIbge) ||
                                    normalizaNomeMunicipio(u.municipio) === normalizaNomeMunicipio(nome)
                                ) {
                                    unidadesDoMunicipio.push({
                                        ...u,
                                        territorio: t
                                    });
                                }
                            });
                        });

                        const popupHtml = `
                            <div class="popup-content">
                                <div class="popup-title">${nome}</div>
                                <div class="popup-info">
                                    <span class="popup-label">Territ√≥rio (cor do mapa):</span>
                                    ${territorio ? territorio.nome : 'N√£o definido'}
                                </div>
                                <div class="popup-info">
                                    <span class="popup-label">C√≥digo IBGE:</span> ${idIbge || '-'}
                                </div>
                                <div class="popup-info">
                                    <span class="popup-label">Unidades EMATER:</span>
                                    ${unidadesDoMunicipio.length}
                                </div>
                                ${unidadesDoMunicipio.length ? `
                                <div class="popup-info">
                                    <span class="popup-label">Lista de unidades:</span><br>
                                    <ul style="padding-left:18px; margin:4px 0 0 0;">
                                        ${unidadesDoMunicipio.map(u => `
                                            <li>${u.tipo} - ${u.nome}${u.distrito ? ' (Distrito: ' + u.distrito + ')' : ''} (${u.latitude.toFixed(4)}, ${u.longitude.toFixed(4)})</li>
                                        `).join('')}
                                    </ul>
                                </div>` : ''}
                            </div>
                        `;

                        layer.bindPopup(popupHtml, {
                            className: 'custom-popup',
                            maxWidth: 320
                        });

                        layer.on('mouseover', () => {
                            layer.setStyle({
                                weight: 2.5,
                                fillOpacity: 0.95
                            });
                        });
                        layer.on('mouseout', () => {
                            layer.setStyle({
                                weight: 1,
                                fillOpacity: 0.85
                            });
                        });
                    }
                });

                layerMunicipios.addTo(map);
                console.log('‚úÖ Pol√≠gonos dos munic√≠pios carregados');
            })
            .catch(err => {
                console.error('‚ùå Erro ao carregar geojs-11-mun.json', err);
            });

        // Inicializa√ß√£o com dados de cobertura
        async function inicializarMapa() {
            console.log('üîÑ Carregando estat√≠sticas de cobertura...');
            await buscarEstatisticasCobertura();
            addMarkers();
            createTerritorioList();
            updateStats();
            
            // Atualizar cores dos pol√≠gonos ap√≥s carregar dados
            setTimeout(() => {
                atualizarCoresPoligonos();
            }, 1000);
            
            console.log('‚úÖ Mapa de Cobertura EMATER-RO carregado com sucesso!');
        }

        // Fun√ß√£o para limpar cache
        async function limparCache() {
            if (!confirm('Deseja limpar o cache do mapa? Isso remover√° todos os dados em cache.')) {
                return;
            }

            try {
                // Limpar cache do service worker
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => caches.delete(cacheName))
                    );
                    console.log('‚úÖ Cache limpo com sucesso');
                }

                // Desregistrar service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(
                        registrations.map(registration => registration.unregister())
                    );
                    console.log('‚úÖ Service workers desregistrados');
                }

                alert('Cache limpo com sucesso! A p√°gina ser√° recarregada.');
                window.location.reload(true);
            } catch (error) {
                console.error('‚ùå Erro ao limpar cache:', error);
                alert('Erro ao limpar cache. Verifique o console.');
            }
        }

        // Fun√ß√£o para atualizar o mapa
        async function atualizarMapa() {
            try {
                console.log('üîÑ Atualizando mapa...');
                
                // Recarregar dados
                await buscarEstatisticasCobertura();
                
                // Limpar marcadores existentes
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                Object.keys(markerGroups).forEach(key => {
                    markerGroups[key] = [];
                });
                
                // Recriar tudo
                addMarkers();
                createTerritorioList();
                updateStats();
                
                // Atualizar cores dos pol√≠gonos
                atualizarCoresPoligonos();
                
                // Resetar territ√≥rio ativo
                atualizarDestaqueTerritorio(null);
                
                console.log('‚úÖ Mapa atualizado com sucesso!');
                alert('Mapa atualizado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao atualizar mapa:', error);
                alert('Erro ao atualizar mapa. Verifique o console.');
            }
        }

        // Iniciar quando a p√°gina carregar
        inicializarMapa();
    </script>
</body>
</html>

