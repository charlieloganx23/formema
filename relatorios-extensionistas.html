<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - Extensionistas EMATER-RO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .relatorios-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1rem;
        }

        .actions-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-2px);
        }

        .resumo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-box .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: #f7fafc;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .mapa-section {
            margin-top: 40px;
        }

        .mapa-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        #mapa {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .relatorios-container {
                padding: 20px;
            }

            .chart-wrapper {
                height: 300px;
            }

            #mapa {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="relatorios-container">
        <div class="header">
            <h1>üìà Relat√≥rios e An√°lises</h1>
            <p>Dashboard Anal√≠tico - Extensionistas EMATER-RO</p>
        </div>

        <div class="actions-bar">
            <button class="btn-action btn-primary" onclick="voltarAdmin()">
                ‚Üê Voltar ao Painel
            </button>
            <button class="btn-action btn-secondary" onclick="atualizarDados()">
                üîÑ Atualizar Dados
            </button>
            <button class="btn-action btn-secondary" onclick="verMapa()">
                üó∫Ô∏è Ver Mapa de Cobertura
            </button>
            <button class="btn-action btn-secondary" onclick="exportarGraficos()">
                üì∏ Exportar Gr√°ficos
            </button>
        </div>

        <div class="resumo-stats" id="resumoStats">
            <!-- Preenchido dinamicamente -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>üìä Nenhum dado dispon√≠vel</h3>
            <p>Complete alguns formul√°rios para visualizar as an√°lises.</p>
        </div>

        <div id="chartsContainer" style="display: none;">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>‚è±Ô∏è Tempo de Atua√ß√£o na EMATER</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartTempoAtuacao"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üéì Forma√ß√£o Acad√™mica</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartFormacao"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üåæ √Åreas de Especializa√ß√£o</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartEspecializacao"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üë• Produtores Atendidos por M√™s</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartProdutores"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìã Tipos de Atividades Realizadas</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartAtividades"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üéØ Crit√©rios de Prioriza√ß√£o</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartCriterios"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üíº Sufici√™ncia de Recursos (M√©dia)</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartRecursos"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>ü§ù Participa√ß√£o em F√≥runs/Redes</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartForuns"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üè¢ Parcerias com Institui√ß√µes</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartParcerias"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìä Aumento de Produ√ß√£o (Relatos)</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartProducao"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìà Indicadores Utilizados</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartIndicadores"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìù Formaliza√ß√£o de Relat√≥rios</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartRelatorios"></canvas>
                    </div>
                </div>
            </div>

            <div class="mapa-section">
                <h2>üó∫Ô∏è Distribui√ß√£o Geogr√°fica dos Extensionistas</h2>
                <div id="mapa"></div>
            </div>
        </div>
    </div>

    <script src="db-extensionistas.js"></script>
    <script>
        let todosFormularios = [];
        let charts = {};
        let mapa = null;

        // Coordenadas aproximadas de alguns munic√≠pios de Rond√¥nia
        const coordenadasMunicipios = {
            'Porto Velho': [-8.7619, -63.9039],
            'Ji-Paran√°': [-10.8777, -61.9509],
            'Ariquemes': [-9.9144, -63.0408],
            'Cacoal': [-11.4386, -61.4472],
            'Vilhena': [-12.7404, -60.1458],
            'Jaru': [-10.4389, -62.4664],
            'Rolim de Moura': [-11.7273, -61.7784],
            'Guajar√°-Mirim': [-10.7833, -65.3333],
            'Pimenta Bueno': [-11.6719, -61.1933],
            'Ouro Preto do Oeste': [-10.7489, -62.2158],
            'Machadinho d\'Oeste': [-9.4644, -61.9897],
            'Espig√£o d\'Oeste': [-11.5258, -61.0042],
            'Buritis': [-10.2042, -63.8289],
            'Colorado do Oeste': [-13.1169, -60.5450],
            'Costa Marques': [-12.4397, -64.2392],
            'Alta Floresta d\'Oeste': [-11.9319, -61.9981],
            'Cerejeiras': [-13.1881, -60.8156]
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await carregarDados();
        });

        async function carregarDados() {
            try {
                document.getElementById('loadingOverlay').classList.add('active');

                todosFormularios = await buscarTodosFormularios();

                if (todosFormularios.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('chartsContainer').style.display = 'none';
                    return;
                }

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('chartsContainer').style.display = 'block';

                renderizarResumo();
                renderizarGraficos();
                renderizarMapa();

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados para relat√≥rios.');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function renderizarResumo() {
            const stats = {
                total: todosFormularios.length,
                municipios: new Set(todosFormularios.map(f => f.municipio).filter(Boolean)).size,
                media_duracao: Math.round(
                    todosFormularios
                        .filter(f => f.duracao_minutos)
                        .reduce((acc, f) => acc + parseFloat(f.duracao_minutos), 0) / 
                    todosFormularios.filter(f => f.duracao_minutos).length
                ) || 0,
                ultimos7dias: todosFormularios.filter(f => {
                    const data = new Date(f.timestamp_fim);
                    const hoje = new Date();
                    const diff = Math.floor((hoje - data) / (1000 * 60 * 60 * 24));
                    return diff <= 7;
                }).length
            };

            document.getElementById('resumoStats').innerHTML = `
                <div class="stat-box">
                    <div class="number">${stats.total}</div>
                    <div class="label">Total de Respostas</div>
                </div>
                <div class="stat-box">
                    <div class="number">${stats.municipios}</div>
                    <div class="label">Munic√≠pios</div>
                </div>
                <div class="stat-box">
                    <div class="number">${stats.media_duracao}min</div>
                    <div class="label">Tempo M√©dio</div>
                </div>
                <div class="stat-box">
                    <div class="number">${stats.ultimos7dias}</div>
                    <div class="label">√öltimos 7 Dias</div>
                </div>
            `;
        }

        function renderizarGraficos() {
            // 1. Tempo de Atua√ß√£o
            const tempoAtuacao = contarRespostas('q1');
            criarGraficoBarras('chartTempoAtuacao', 'Tempo de Atua√ß√£o', tempoAtuacao);

            // 2. Forma√ß√£o Acad√™mica
            const formacao = contarRespostas('q2');
            criarGraficoPizza('chartFormacao', formacao);

            // 3. √Åreas de Especializa√ß√£o
            const especializacao = contarRespostasMultiplas('q3');
            criarGraficoBarrasHorizontal('chartEspecializacao', 'Extensionistas', especializacao);

            // 4. Produtores Atendidos
            const produtores = contarRespostas('q4');
            criarGraficoBarras('chartProdutores', 'Produtores/M√™s', produtores);

            // 5. Tipos de Atividades
            const atividades = contarRespostasMultiplas('q5');
            criarGraficoBarrasHorizontal('chartAtividades', 'Extensionistas', atividades);

            // 6. Crit√©rios de Prioriza√ß√£o
            const criterios = contarRespostasMultiplas('q6');
            criarGraficoPizza('chartCriterios', criterios);

            // 7. Sufici√™ncia de Recursos (Radar)
            const recursos = {
                'Recursos T√©cnicos': calcularMedia('q8'),
                'Recursos Financeiros': calcularMedia('q9'),
                'Transporte/Log√≠stica': calcularMedia('q10'),
                'Equipamentos Tech': calcularMedia('q11')
            };
            criarGraficoRadar('chartRecursos', recursos);

            // 8. Participa√ß√£o em F√≥runs
            const foruns = contarRespostas('q13');
            criarGraficoPizza('chartForuns', foruns);

            // 9. Parcerias com Institui√ß√µes
            const parcerias = contarRespostasMultiplas('q14');
            criarGraficoBarrasHorizontal('chartParcerias', 'Extensionistas', parcerias);

            // 10. Aumento de Produ√ß√£o
            const producao = contarRespostas('q17');
            criarGraficoPizza('chartProducao', producao);

            // 11. Indicadores Utilizados
            const indicadores = contarRespostasMultiplas('q21');
            criarGraficoBarrasHorizontal('chartIndicadores', 'Extensionistas', indicadores);

            // 12. Formaliza√ß√£o de Relat√≥rios
            const relatorios = contarRespostas('q22');
            criarGraficoPizza('chartRelatorios', relatorios);
        }

        function contarRespostas(campo) {
            const contagem = {};
            todosFormularios.forEach(f => {
                const valor = f[campo];
                if (valor) {
                    contagem[valor] = (contagem[valor] || 0) + 1;
                }
            });
            return contagem;
        }

        function contarRespostasMultiplas(campo) {
            const contagem = {};
            todosFormularios.forEach(f => {
                const valores = f[campo];
                if (Array.isArray(valores)) {
                    valores.forEach(v => {
                        contagem[v] = (contagem[v] || 0) + 1;
                    });
                } else if (valores) {
                    contagem[valores] = (contagem[valores] || 0) + 1;
                }
            });
            return contagem;
        }

        function calcularMedia(campo) {
            const mapeamento = {
                'Muito insuficiente': 1,
                'Insuficiente': 2,
                'Adequado': 3,
                'Bom': 4,
                'Excelente': 5
            };

            const valores = todosFormularios
                .map(f => mapeamento[f[campo]])
                .filter(v => v !== undefined);

            if (valores.length === 0) return 0;
            return (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(1);
        }

        function criarGraficoBarras(canvasId, label, dados) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{
                        label: label,
                        data: Object.values(dados),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function criarGraficoBarrasHorizontal(canvasId, label, dados) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{
                        label: label,
                        data: Object.values(dados),
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function criarGraficoPizza(canvasId, dados) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) charts[canvasId].destroy();

            const cores = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(72, 187, 120, 0.8)',
                'rgba(245, 101, 101, 0.8)',
                'rgba(237, 137, 54, 0.8)',
                'rgba(66, 153, 225, 0.8)'
            ];

            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{
                        data: Object.values(dados),
                        backgroundColor: cores,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function criarGraficoRadar(canvasId, dados) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{
                        label: 'M√©dia (1-5)',
                        data: Object.values(dados),
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function renderizarMapa() {
            if (mapa) {
                mapa.remove();
            }

            // Centralizar em Rond√¥nia
            mapa = L.map('mapa').setView([-10.9, -62.8], 7);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapa);

            // Contar formul√°rios por munic√≠pio
            const porMunicipio = {};
            todosFormularios.forEach(f => {
                if (f.municipio) {
                    porMunicipio[f.municipio] = (porMunicipio[f.municipio] || 0) + 1;
                }
            });

            // Adicionar marcadores
            Object.entries(porMunicipio).forEach(([municipio, count]) => {
                const coords = coordenadasMunicipios[municipio];
                if (coords) {
                    const marker = L.marker(coords).addTo(mapa);
                    marker.bindPopup(`
                        <strong>${municipio}</strong><br>
                        Formul√°rios: ${count}
                    `);
                }
            });
        }

        async function atualizarDados() {
            await carregarDados();
        }

        function voltarAdmin() {
            window.location.href = 'admin-extensionistas.html';
        }

        function verMapa() {
            window.location.href = 'mapa-extensionistas.html';
        }

        function exportarGraficos() {
            alert('üì∏ Fun√ß√£o de exporta√ß√£o de gr√°ficos ser√° implementada em breve.\n\nPor enquanto, use a captura de tela do navegador.');
        }
    </script>
</body>
</html>
